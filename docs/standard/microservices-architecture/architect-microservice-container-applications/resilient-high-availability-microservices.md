---
title: 微服务中的复原和高可用性
description: 微服务必须能够承受暂时的网络和依赖项故障，必须可复原以实现高可用性。
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 09/20/2018
ms.openlocfilehash: 174e9881be50b8c2f8220960e93dce626e776b65
ms.sourcegitcommit: 542aa405b295955eb055765f33723cb8b588d0d0
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/17/2019
ms.locfileid: "54362231"
---
# <a name="resiliency-and-high-availability-in-microservices"></a><span data-ttu-id="a0884-103">微服务中的复原和高可用性</span><span class="sxs-lookup"><span data-stu-id="a0884-103">Resiliency and high availability in microservices</span></span>

<span data-ttu-id="a0884-104">意外故障处理是最难解决的问题之一，尤其是在分布系统之中。</span><span class="sxs-lookup"><span data-stu-id="a0884-104">Dealing with unexpected failures is one of the hardest problems to solve, especially in a distributed system.</span></span> <span data-ttu-id="a0884-105">开发人员编写的大多数代码都包括处理异常，这也是测试中花费时间最多的地方。</span><span class="sxs-lookup"><span data-stu-id="a0884-105">Much of the code that developers write involves handling exceptions, and this is also where the most time is spent in testing.</span></span> <span data-ttu-id="a0884-106">这个问题比编写代码处理故障更为复杂。</span><span class="sxs-lookup"><span data-stu-id="a0884-106">The problem is more involved than writing code to handle failures.</span></span> <span data-ttu-id="a0884-107">计算机中微服务运行失败时会出现哪些情况？</span><span class="sxs-lookup"><span data-stu-id="a0884-107">What happens when the machine where the microservice is running fails?</span></span> <span data-ttu-id="a0884-108">不仅需要检测此次微服务失败（这本身就是一个难题），还需要采取某些措施以重新启动微服务。</span><span class="sxs-lookup"><span data-stu-id="a0884-108">Not only do you need to detect this microservice failure (a hard problem on its own), but you also need something to restart your microservice.</span></span>

<span data-ttu-id="a0884-109">微服务需要具有应对故障的复原能力，并且能够经常在另一台计算机上重新启动以获得可用性。</span><span class="sxs-lookup"><span data-stu-id="a0884-109">A microservice needs to be resilient to failures and to be able to restart often on another machine for availability.</span></span> <span data-ttu-id="a0884-110">这种复原还归结于代表微服务保存的状态（微服务可从中恢复此状态）和微服务是否可以成功重新启动。</span><span class="sxs-lookup"><span data-stu-id="a0884-110">This resiliency also comes down to the state that was saved on behalf of the microservice, where the microservice can recover this state from, and whether the microservice can restart successfully.</span></span> <span data-ttu-id="a0884-111">换言之，这需要计算机功能中的复原能力（进程随时可重新启动），还需要状态或数据的复原能力（不会丢失数据并且数据保持一致）。</span><span class="sxs-lookup"><span data-stu-id="a0884-111">In other words, there needs to be resiliency in the compute capability (the process can restart at any time) as well as resilience in the state or data (no data loss, and the data remains consistent).</span></span>

<span data-ttu-id="a0884-112">在其他情况下，复原问题会更加复杂，例如在应用程序升级时发生此故障。</span><span class="sxs-lookup"><span data-stu-id="a0884-112">The problems of resiliency are compounded during other scenarios, such as when failures occur during an application upgrade.</span></span> <span data-ttu-id="a0884-113">与部署系统一起工作的微服务需要确定它应该继续更新到新版本还是应该回滚到之前的版本，才能保持一致的状态。</span><span class="sxs-lookup"><span data-stu-id="a0884-113">The microservice, working with the deployment system, needs to determine whether it can continue to move forward to the newer version or instead roll back to a previous version to maintain a consistent state.</span></span> <span data-ttu-id="a0884-114">需要考虑的问题如：是否有足够的计算机可继续更新以及如何恢复微服务的以前版本。</span><span class="sxs-lookup"><span data-stu-id="a0884-114">Questions such as whether enough machines are available to keep moving forward and how to recover previous versions of the microservice need to be considered.</span></span> <span data-ttu-id="a0884-115">这要求微服务发出运行状况信息，使整个应用程序和业务流程协调程序可以做出以上决定。</span><span class="sxs-lookup"><span data-stu-id="a0884-115">This requires the microservice to emit health information so that the overall application and orchestrator can make these decisions.</span></span>

<span data-ttu-id="a0884-116">此外，复原还与基于云的系统的必要行为方式有关。</span><span class="sxs-lookup"><span data-stu-id="a0884-116">In addition, resiliency is related to how cloud-based systems must behave.</span></span> <span data-ttu-id="a0884-117">如前所述，基于云的系统必须包含故障，必须尝试从故障中自动恢复。</span><span class="sxs-lookup"><span data-stu-id="a0884-117">As mentioned, a cloud-based system must embrace failures and must try to automatically recover from them.</span></span> <span data-ttu-id="a0884-118">例如，如果发生网络或容器故障，客户端应用或客户端服务必须有重试发送信息或重试请求的策略，因为在多数情况下，云中的故障仅是部分故障。</span><span class="sxs-lookup"><span data-stu-id="a0884-118">For instance, in case of network or container failures, client apps or client services must have a strategy to retry sending messages or to retry requests, since in many cases failures in the cloud are partial.</span></span> <span data-ttu-id="a0884-119">本指南中的[实现具有恢复能力的应用程序](../implement-resilient-applications/index.md)一节介绍了部分故障的处理方式。</span><span class="sxs-lookup"><span data-stu-id="a0884-119">The [Implementing Resilient Applications](../implement-resilient-applications/index.md) section in this guide addresses how to handle partial failure.</span></span> <span data-ttu-id="a0884-120">该部分通过使用库（如[Polly](https://github.com/App-vNext/Polly)，其中提供了多种策略处理此类问题）介绍了诸如指数退避重试或 .NET Core 中的断路器模式的技术。</span><span class="sxs-lookup"><span data-stu-id="a0884-120">It describes techniques like retries with exponential backoff or the Circuit Breaker pattern in .NET Core by using libraries like [Polly](https://github.com/App-vNext/Polly), which offers a large variety of policies to handle this subject.</span></span>

## <a name="health-management-and-diagnostics-in-microservices"></a><span data-ttu-id="a0884-121">微服务中的运行状况管理和诊断</span><span class="sxs-lookup"><span data-stu-id="a0884-121">Health management and diagnostics in microservices</span></span>

<span data-ttu-id="a0884-122">微服务必须报告其运行状况和诊断，这可能看起来显而易见，但时常被忽视。</span><span class="sxs-lookup"><span data-stu-id="a0884-122">It may seem obvious, and it's often overlooked, but a microservice must report its health and diagnostics.</span></span> <span data-ttu-id="a0884-123">否则，从操作角度来说，几乎没有见解。</span><span class="sxs-lookup"><span data-stu-id="a0884-123">Otherwise, there's little insight from an operations perspective.</span></span> <span data-ttu-id="a0884-124">关联一组独立服务中的诊断事件和处理计算机时钟扭曲以了解事件顺序是很有难度的。</span><span class="sxs-lookup"><span data-stu-id="a0884-124">Correlating diagnostic events across a set of independent services and dealing with machine clock skews to make sense of the event order is challenging.</span></span> <span data-ttu-id="a0884-125">和通过商定的协议和数据格式与微服务交互的方式一样，这需要一个标准方式来记录运行状况和诊断事件，最终记录到事件存储中供查询和查看。</span><span class="sxs-lookup"><span data-stu-id="a0884-125">In the same way that you interact with a microservice over agreed-upon protocols and data formats, there's a need for standardization in how to log health and diagnostic events that ultimately end up in an event store for querying and viewing.</span></span> <span data-ttu-id="a0884-126">对于微服务方法，其关键在于不同团队达成单个日志记录格式。</span><span class="sxs-lookup"><span data-stu-id="a0884-126">In a microservices approach, it's key that different teams agree on a single logging format.</span></span> <span data-ttu-id="a0884-127">还需要一种一致的方法在应用程序中查看诊断事件。</span><span class="sxs-lookup"><span data-stu-id="a0884-127">There needs to be a consistent approach to viewing diagnostic events in the application.</span></span>

### <a name="health-checks"></a><span data-ttu-id="a0884-128">运行状况检查</span><span class="sxs-lookup"><span data-stu-id="a0884-128">Health checks</span></span>

<span data-ttu-id="a0884-129">运行状况不同于诊断。</span><span class="sxs-lookup"><span data-stu-id="a0884-129">Health is different from diagnostics.</span></span> <span data-ttu-id="a0884-130">运行状况是微服务报告其当前状态以采取适当的措施。</span><span class="sxs-lookup"><span data-stu-id="a0884-130">Health is about the microservice reporting its current state to take appropriate actions.</span></span> <span data-ttu-id="a0884-131">一个很好的例子就是使用升级和部署机制来保证可用性。</span><span class="sxs-lookup"><span data-stu-id="a0884-131">A good example is working with upgrade and deployment mechanisms to maintain availability.</span></span> <span data-ttu-id="a0884-132">即使可能由于进程崩溃或计算机重启导致当前服务不正常，仍可对服务器进行操作。</span><span class="sxs-lookup"><span data-stu-id="a0884-132">Although a service might currently be unhealthy due to a process crash or machine reboot, the service might still be operational.</span></span> <span data-ttu-id="a0884-133">最不需要做的就是执行升级，那样会让情况变得更糟。</span><span class="sxs-lookup"><span data-stu-id="a0884-133">The last thing you need is to make this worse by performing an upgrade.</span></span> <span data-ttu-id="a0884-134">最佳方法是先调查或给微服务恢复的时间。</span><span class="sxs-lookup"><span data-stu-id="a0884-134">The best approach is to do an investigation first or allow time for the microservice to recover.</span></span> <span data-ttu-id="a0884-135">微服务的运行状况事件能帮助做出明智的决定，实际上是帮助创建自愈服务。</span><span class="sxs-lookup"><span data-stu-id="a0884-135">Health events from a microservice help us make informed decisions and, in effect, help create self-healing services.</span></span>

<span data-ttu-id="a0884-136">本指南的[在 ASP.NET Core 服务中实现运行状况检查](../implement-resilient-applications/monitor-app-health.md#implement-health-checks-in-aspnet-core-services)一节介绍了如何在微服务中使用新 ASP.NET 运行状况检查库，使微服务可向监视器服务报告它们的状态，以执行适当的操作。</span><span class="sxs-lookup"><span data-stu-id="a0884-136">In the [Implementing health checks in ASP.NET Core services](../implement-resilient-applications/monitor-app-health.md#implement-health-checks-in-aspnet-core-services) section of this guide, we explain how to use a new ASP.NET HealthChecks library in your microservices so they can report their state to a monitoring service to take appropriate actions.</span></span>

<span data-ttu-id="a0884-137">还可以使用出色的开源库 Beat Pulse，该库可通过 [GitHub](https://github.com/Xabaril/BeatPulse) 作为 [NuGet 包](https://www.nuget.org/packages/BeatPulse/) 获取。</span><span class="sxs-lookup"><span data-stu-id="a0884-137">You also have the option of using an excellent open-source library called Beat Pulse, available on [GitHub](https://github.com/Xabaril/BeatPulse) and as a [NuGet package](https://www.nuget.org/packages/BeatPulse/).</span></span> <span data-ttu-id="a0884-138">此库还执行经过改进的运行状况检查，它可以处理两种类型的检查：</span><span class="sxs-lookup"><span data-stu-id="a0884-138">This library also does health checks, with a twist, it handles two types of checks:</span></span>

- <span data-ttu-id="a0884-139">**运行情况**：检查微服务是否处于活动状态，即微服务是否接受请求并作出响应。</span><span class="sxs-lookup"><span data-stu-id="a0884-139">**Liveness**: Checks if the microservice is alive, that is, if it’s able to accept requests and respond.</span></span> 
- <span data-ttu-id="a0884-140">**就绪情况**：检查微服务的依赖项（数据库、查询服务等）是否已就绪，以便微服务可以执行预期操作。</span><span class="sxs-lookup"><span data-stu-id="a0884-140">**Readiness**: Checks if the microservice's dependencies (Database, queue services, etc.) are themselves ready, so the microservice can do what it’s supposed to do.</span></span> 

### <a name="using-diagnostics-and-logs-event-streams"></a><span data-ttu-id="a0884-141">使用诊断和日志事件流</span><span class="sxs-lookup"><span data-stu-id="a0884-141">Using diagnostics and logs event streams</span></span>

<span data-ttu-id="a0884-142">日志提供应用程序或服务的运行方式的相关信息，其中包括异常、警告和简单的信息。</span><span class="sxs-lookup"><span data-stu-id="a0884-142">Logs provide information about how an application or service is running, including exceptions, warnings, and simple informational messages.</span></span> <span data-ttu-id="a0884-143">通常，每篇日志都是文本格式，每个事件一行，但异常经常显示跨越多行的堆栈跟踪。</span><span class="sxs-lookup"><span data-stu-id="a0884-143">Usually, each log is in a text format with one line per event, although exceptions also often show the stack trace across multiple lines.</span></span>

<span data-ttu-id="a0884-144">在基于服务器的整体式应用程序中，可简单地将日志写入磁盘上的文件（日志文件），然后使用任意工具对其进行分析。</span><span class="sxs-lookup"><span data-stu-id="a0884-144">In monolithic server-based applications, you can simply write logs to a file on disk (a logfile) and then analyze it with any tool.</span></span> <span data-ttu-id="a0884-145">因为应用程序限制在固定的服务器或 VM 上执行，所以它通常不会太过复杂而导致无法分析事件流。</span><span class="sxs-lookup"><span data-stu-id="a0884-145">Since application execution is limited to a fixed server or VM, it generally isn't too complex to analyze the flow of events.</span></span> <span data-ttu-id="a0884-146">但在分布式应用程序中，多个服务在业务流程协调程序群集中的多数节点上执行，因此关联分布式事件是一项挑战。</span><span class="sxs-lookup"><span data-stu-id="a0884-146">However, in a distributed application where multiple services are executed across many nodes in an orchestrator cluster, being able to correlate distributed events is a challenge.</span></span>

<span data-ttu-id="a0884-147">基于微服务的应用程序不应尝试自行存储事件或日志文件的输出流，甚至不应尝试管理事件到中心位置的路由。</span><span class="sxs-lookup"><span data-stu-id="a0884-147">A microservice-based application should not try to store the output stream of events or logfiles by itself, and not even try to manage the routing of the events to a central place.</span></span> <span data-ttu-id="a0884-148">它应该是透明的，即每个进程只需要将其事件流写入一个标准输出，该标准输出将由运行的执行环境基础结构收集。</span><span class="sxs-lookup"><span data-stu-id="a0884-148">It should be transparent, meaning that each process should just write its event stream to a standard output that underneath will be collected by the execution environment infrastructure where it's running.</span></span> <span data-ttu-id="a0884-149">事件流路由器的一个示例为 [Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow)，该路由器从多个源收集事件流，并将其发布到输出系统。</span><span class="sxs-lookup"><span data-stu-id="a0884-149">An example of these event stream routers is [Microsoft.Diagnostic.EventFlow](https://github.com/Azure/diagnostics-eventflow), which collects event streams from multiple sources and publishes it to output systems.</span></span> <span data-ttu-id="a0884-150">这些可能包括开发环境或云系统（如 [Application Insights](https://azure.microsoft.com/services/application-insights/)、[OMS](https://github.com/Azure/diagnostics-eventflow#oms-operations-management-suite)（用于本地应用程序）和 [Azure 诊断](https://docs.microsoft.com/azure/monitoring-and-diagnostics/azure-diagnostics)）的简单标准输出。</span><span class="sxs-lookup"><span data-stu-id="a0884-150">These can include simple standard output for a development environment or cloud systems like [Application Insights](https://azure.microsoft.com/services/application-insights/), [OMS](https://github.com/Azure/diagnostics-eventflow#oms-operations-management-suite) (for on-premises applications), and [Azure Diagnostics](https://docs.microsoft.com/azure/monitoring-and-diagnostics/azure-diagnostics).</span></span> <span data-ttu-id="a0884-151">也有一些好的第三方日志分析平台和工具（如 [Splunk](https://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA)），它们甚至可以实时搜索、提示、报告和监视日志。</span><span class="sxs-lookup"><span data-stu-id="a0884-151">There are also good third-party log analysis platforms and tools that can search, alert, report, and monitor logs, even in real time, like [Splunk](https://www.splunk.com/goto/Splunk_Log_Management?ac=ga_usa_log_analysis_phrase_Mar17&_kk=logs%20analysis&gclid=CNzkzIrex9MCFYGHfgodW5YOtA).</span></span>

### <a name="orchestrators-managing-health-and-diagnostics-information"></a><span data-ttu-id="a0884-152">管理运行状况和诊断信息的业务流程协调程序</span><span class="sxs-lookup"><span data-stu-id="a0884-152">Orchestrators managing health and diagnostics information</span></span>

<span data-ttu-id="a0884-153">创建基于微服务的应用程序时，需要处理其复杂性。</span><span class="sxs-lookup"><span data-stu-id="a0884-153">When you create a microservice-based application, you need to deal with complexity.</span></span> <span data-ttu-id="a0884-154">当然，单个微服务的处理很简单，但处理微服务的数十个或数百个类型以及数千个实例则十分复杂。</span><span class="sxs-lookup"><span data-stu-id="a0884-154">Of course, a single microservice is simple to deal with, but dozens or hundreds of types and thousands of instances of microservices is a complex problem.</span></span> <span data-ttu-id="a0884-155">这不仅是构建微服务体系结构，如果想要一个稳定紧密的系统，还需要具有高可用性、可寻址能力、复原能力、运行状况和诊断功能。</span><span class="sxs-lookup"><span data-stu-id="a0884-155">It isn't just about building your microservice architecture—you also need high availability, addressability, resiliency, health, and diagnostics if you intend to have a stable and cohesive system.</span></span>

![业务流程协调程序提供用于运行微服务的支持平台。](./media/image22.png)

<span data-ttu-id="a0884-157">**图 4-22**。</span><span class="sxs-lookup"><span data-stu-id="a0884-157">**Figure 4-22**.</span></span> <span data-ttu-id="a0884-158">微服务平台是应用程序运行状况管理的基础</span><span class="sxs-lookup"><span data-stu-id="a0884-158">A Microservice Platform is fundamental for an application's health management</span></span>

<span data-ttu-id="a0884-159">图 4-22 所示的复杂问题很难自行解决。</span><span class="sxs-lookup"><span data-stu-id="a0884-159">The complex problems shown in Figure 4-22 are very hard to solve by yourself.</span></span> <span data-ttu-id="a0884-160">开发团队应侧重于解决商业问题和构建使用基于微服务方法的自定义应用程序。</span><span class="sxs-lookup"><span data-stu-id="a0884-160">Development teams should focus on solving business problems and building custom applications with microservice-based approaches.</span></span> <span data-ttu-id="a0884-161">他们不应侧重于解决复杂的基础结构问题，因为如果他们这样做，任何基于微服务的应用程序都将耗费巨大成本。</span><span class="sxs-lookup"><span data-stu-id="a0884-161">They should not focus on solving complex infrastructure problems; if they did, the cost of any microservice-based application would be huge.</span></span> <span data-ttu-id="a0884-162">因此，出现了面向微服务的平台（称为业务流程协调程序或微服务群集），这些平台尝试解决构建和运行服务的困难问题，并尝试有效地使用基础结构资源。</span><span class="sxs-lookup"><span data-stu-id="a0884-162">Therefore, there are microservice-oriented platforms, referred to as orchestrators or microservice clusters, that try to solve the hard problems of building and running a service and using infrastructure resources efficiently.</span></span> <span data-ttu-id="a0884-163">这降低了构建使用微服务方法的应用程序的复杂程度。</span><span class="sxs-lookup"><span data-stu-id="a0884-163">This reduces the complexities of building applications that use a microservices approach.</span></span>

<span data-ttu-id="a0884-164">不同的业务流程协调程序可能听起来相似，但它们各自提供的诊断和运行状况检查都在功能和成熟状态上不同，有时这取决于 OS 平台，如下节所述。</span><span class="sxs-lookup"><span data-stu-id="a0884-164">Different orchestrators might sound similar, but the diagnostics and health checks offered by each of them differ in features and state of maturity, sometimes depending on the OS platform, as explained in the next section.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="a0884-165">其他资源</span><span class="sxs-lookup"><span data-stu-id="a0884-165">Additional resources</span></span>

- <span data-ttu-id="a0884-166">**The Twelve-Factor App.XI.日志：将日志视为事件流** \\</span><span class="sxs-lookup"><span data-stu-id="a0884-166">**The Twelve-Factor App. XI. Logs: Treat logs as event streams** \\</span></span>
  [*https://12factor.net/logs*](https://12factor.net/logs)

- <span data-ttu-id="a0884-167">Microsoft Diagnostic EventFlow 库 GitHub 存储库。</span><span class="sxs-lookup"><span data-stu-id="a0884-167">**Microsoft Diagnostic EventFlow Library** GitHub repo.</span></span> \
  [*https://github.com/Azure/diagnostics-eventflow*](https://github.com/Azure/diagnostics-eventflow)

- <span data-ttu-id="a0884-168">什么是 Azure 诊断 \\</span><span class="sxs-lookup"><span data-stu-id="a0884-168">**What is Azure Diagnostics** \\</span></span>
  [*https://docs.microsoft.com/azure/azure-diagnostics*](https://docs.microsoft.com/azure/azure-diagnostics)

- <span data-ttu-id="a0884-169">将 Windows 计算机连接到 Azure 中的 Log Analytics 服务 \\</span><span class="sxs-lookup"><span data-stu-id="a0884-169">**Connect Windows computers to the Log Analytics service in Azure** \\</span></span>
  [*https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents*](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)

- <span data-ttu-id="a0884-170">**记录你的想法：使用语义日志记录应用程序块** \\</span><span class="sxs-lookup"><span data-stu-id="a0884-170">**Logging What You Mean: Using the Semantic Logging Application Block** \\</span></span>
  [*https://msdn.microsoft.com/library/dn440729(v=pandp.60).aspx*](https://msdn.microsoft.com/library/dn440729(v=pandp.60).aspx)

- <span data-ttu-id="a0884-171">Splunk 官方网站。</span><span class="sxs-lookup"><span data-stu-id="a0884-171">**Splunk** Official site.</span></span> \
  [*https://www.splunk.com/*](https://www.splunk.com/)

- <span data-ttu-id="a0884-172">Windows 事件跟踪 (ETW) 的 EventSource 类 API \\</span><span class="sxs-lookup"><span data-stu-id="a0884-172">**EventSource Class** API for events tracing for Windows (ETW) \\</span></span>
  [*https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource*](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource)

>[!div class="step-by-step"]
><span data-ttu-id="a0884-173">[上一页](microservice-based-composite-ui-shape-layout.md)
>[下一页](scalable-available-multi-container-microservice-applications.md)</span><span class="sxs-lookup"><span data-stu-id="a0884-173">[Previous](microservice-based-composite-ui-shape-layout.md)
[Next](scalable-available-multi-container-microservice-applications.md)</span></span>
