---
title: Azure 平台复原
description: 构建适用于 Azure 的云本机 .NET 应用 |Azure 的云基础结构复原
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: 752f1320d9dfa18e52b078763d221a787da15e8e
ms.sourcegitcommit: 27db07ffb26f76912feefba7b884313547410db5
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/19/2020
ms.locfileid: "83613975"
---
# <a name="azure-platform-resiliency"></a><span data-ttu-id="e777c-103">Azure 平台复原</span><span class="sxs-lookup"><span data-stu-id="e777c-103">Azure platform resiliency</span></span>

<span data-ttu-id="e777c-104">在云中生成可靠应用程序不同于传统的本地应用程序开发。</span><span class="sxs-lookup"><span data-stu-id="e777c-104">Building a reliable application in the cloud is different from traditional on-premises application development.</span></span> <span data-ttu-id="e777c-105">尽管在以前的环境中购买了更高端的硬件，但在云环境中进行了扩展。目标是最大程度地降低其效果并使系统保持稳定，而不是尝试防止故障。</span><span class="sxs-lookup"><span data-stu-id="e777c-105">While historically you purchased higher-end hardware to scale up, in a cloud environment you scale out. Instead of trying to prevent failures, the goal is to minimize their effects and keep the system stable.</span></span>

<span data-ttu-id="e777c-106">也就是说，可靠的云应用程序显示了不同的特征：</span><span class="sxs-lookup"><span data-stu-id="e777c-106">That said, reliable cloud applications display distinct characteristics:</span></span>

- <span data-ttu-id="e777c-107">它们是弹性的，可从问题中轻松恢复，并继续正常工作。</span><span class="sxs-lookup"><span data-stu-id="e777c-107">They're resilient, recover gracefully from problems, and continue to function.</span></span>
- <span data-ttu-id="e777c-108">它们是高度可用的（HA），并在正常状态中按设计运行，无需很长的停机时间。</span><span class="sxs-lookup"><span data-stu-id="e777c-108">They're highly available (HA) and run as designed in a healthy state with no significant downtime.</span></span>

<span data-ttu-id="e777c-109">了解这些特性如何协同工作，以及它们如何影响成本，对于构建可靠的云本机应用程序至关重要。</span><span class="sxs-lookup"><span data-stu-id="e777c-109">Understanding how these characteristics work together - and how they affect cost - is essential to building a reliable cloud-native application.</span></span> <span data-ttu-id="e777c-110">接下来，我们将看看如何利用 Azure 云中的功能，在云本机应用程序中构建复原能力和可用性。</span><span class="sxs-lookup"><span data-stu-id="e777c-110">We'll next look at ways that you can build resiliency and availability into your cloud-native applications leveraging features from the Azure cloud.</span></span>

## <a name="design-with-resiliency"></a><span data-ttu-id="e777c-111">具有复原能力的设计</span><span class="sxs-lookup"><span data-stu-id="e777c-111">Design with resiliency</span></span>

<span data-ttu-id="e777c-112">我们已经说过复原功能，使应用程序能够应对故障并仍能正常工作。</span><span class="sxs-lookup"><span data-stu-id="e777c-112">We've said resiliency enables your application to react to failure and still remain functional.</span></span> <span data-ttu-id="e777c-113">白皮书（ [Azure 白皮书中的复原能力](https://azure.microsoft.com/mediahandler/files/resourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf)）提供了在 azure 平台中实现复原能力的指导。</span><span class="sxs-lookup"><span data-stu-id="e777c-113">The whitepaper, [Resilience in Azure whitepaper](https://azure.microsoft.com/mediahandler/files/resourcefiles/resilience-in-azure-whitepaper/Resilience%20in%20Azure.pdf), provides guidance for achieving resilience in the Azure platform.</span></span> <span data-ttu-id="e777c-114">下面是一些关键建议：</span><span class="sxs-lookup"><span data-stu-id="e777c-114">Here are some key recommendations:</span></span>

- <span data-ttu-id="e777c-115">*硬件故障。*</span><span class="sxs-lookup"><span data-stu-id="e777c-115">*Hardware failure.*</span></span> <span data-ttu-id="e777c-116">通过在不同的容错域中部署组件，在应用程序中构建冗余。</span><span class="sxs-lookup"><span data-stu-id="e777c-116">Build redundancy into the application by deploying components across different fault domains.</span></span> <span data-ttu-id="e777c-117">例如，使用可用性集确保将 Azure Vm 放在不同的机架中。</span><span class="sxs-lookup"><span data-stu-id="e777c-117">For example, ensure that Azure VMs are placed in different racks by using Availability Sets.</span></span>

- <span data-ttu-id="e777c-118">*数据中心故障。*</span><span class="sxs-lookup"><span data-stu-id="e777c-118">*Datacenter failure.*</span></span> <span data-ttu-id="e777c-119">通过跨数据中心的容错隔离区，在应用程序中构建冗余。</span><span class="sxs-lookup"><span data-stu-id="e777c-119">Build redundancy into the application with fault isolation zones across datacenters.</span></span> <span data-ttu-id="e777c-120">例如，通过使用 Azure 可用性区域确保将 Azure Vm 放置在不同的故障隔离数据中心。</span><span class="sxs-lookup"><span data-stu-id="e777c-120">For example, ensure that Azure VMs are placed in different fault-isolated datacenters by using Azure Availability Zones.</span></span>

- <span data-ttu-id="e777c-121">*区域性故障。*</span><span class="sxs-lookup"><span data-stu-id="e777c-121">*Regional failure.*</span></span> <span data-ttu-id="e777c-122">将数据和组件复制到另一个区域，以便能够快速恢复应用程序。</span><span class="sxs-lookup"><span data-stu-id="e777c-122">Replicate the data and components into another region so that applications can be quickly recovered.</span></span> <span data-ttu-id="e777c-123">例如，使用 Azure Site Recovery 将 Azure Vm 复制到另一 Azure 区域。</span><span class="sxs-lookup"><span data-stu-id="e777c-123">For example, use Azure Site Recovery to replicate Azure VMs to another Azure region.</span></span>

- <span data-ttu-id="e777c-124">*重负载。*</span><span class="sxs-lookup"><span data-stu-id="e777c-124">*Heavy load.*</span></span> <span data-ttu-id="e777c-125">在实例之间进行负载平衡，处理高峰使用量。</span><span class="sxs-lookup"><span data-stu-id="e777c-125">Load balance across instances to handle spikes in usage.</span></span> <span data-ttu-id="e777c-126">例如，将两个或多个 Azure Vm 放在负载均衡器后面，以将流量分配到所有 Vm。</span><span class="sxs-lookup"><span data-stu-id="e777c-126">For example, put two or more Azure VMs behind a load balancer to distribute traffic to all VMs.</span></span>

- <span data-ttu-id="e777c-127">*意外的数据删除或损坏。*</span><span class="sxs-lookup"><span data-stu-id="e777c-127">*Accidental data deletion or corruption.*</span></span> <span data-ttu-id="e777c-128">备份数据，以便在发生任何删除或损坏时可以将其还原。</span><span class="sxs-lookup"><span data-stu-id="e777c-128">Back up data so it can be restored if there’s any deletion or corruption.</span></span> <span data-ttu-id="e777c-129">例如，使用 Azure 备份定期备份 Azure Vm。</span><span class="sxs-lookup"><span data-stu-id="e777c-129">For example, use Azure Backup to periodically back up your Azure VMs.</span></span>

## <a name="design-with-redundancy"></a><span data-ttu-id="e777c-130">具有冗余的设计</span><span class="sxs-lookup"><span data-stu-id="e777c-130">Design with redundancy</span></span>

<span data-ttu-id="e777c-131">故障的影响范围有所不同。</span><span class="sxs-lookup"><span data-stu-id="e777c-131">Failures vary in scope of impact.</span></span> <span data-ttu-id="e777c-132">硬件故障（例如磁盘故障）可能会影响群集中的单个节点。</span><span class="sxs-lookup"><span data-stu-id="e777c-132">A hardware failure, such as a failed disk, can affect a single node in a cluster.</span></span> <span data-ttu-id="e777c-133">网络交换机故障可能会影响整个服务器机架。</span><span class="sxs-lookup"><span data-stu-id="e777c-133">A failed network switch could affect an entire server rack.</span></span> <span data-ttu-id="e777c-134">不太常见的故障（例如断电）可能会中断整个数据中心。</span><span class="sxs-lookup"><span data-stu-id="e777c-134">Less common failures, such as loss of power, could disrupt a whole datacenter.</span></span> <span data-ttu-id="e777c-135">很少会出现整个区域不可用的情况。</span><span class="sxs-lookup"><span data-stu-id="e777c-135">Rarely, an entire region becomes unavailable.</span></span>

<span data-ttu-id="e777c-136">[冗余](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy)是提供应用程序复原能力的一种方法。</span><span class="sxs-lookup"><span data-stu-id="e777c-136">[Redundancy](https://docs.microsoft.com/azure/architecture/guide/design-principles/redundancy) is one way to provide application resilience.</span></span> <span data-ttu-id="e777c-137">所需的确切冗余级别取决于你的业务需求，并将影响系统的成本和复杂性。</span><span class="sxs-lookup"><span data-stu-id="e777c-137">The exact level of redundancy needed depends upon your business requirements and will affect both the cost and complexity of your system.</span></span> <span data-ttu-id="e777c-138">例如，多区域部署比单区域部署更昂贵且更复杂。</span><span class="sxs-lookup"><span data-stu-id="e777c-138">For example, a multi-region deployment is more expensive and more complex to manage than a single-region deployment.</span></span> <span data-ttu-id="e777c-139">你将需要操作过程来管理故障转移和故障回复。</span><span class="sxs-lookup"><span data-stu-id="e777c-139">You'll need operational procedures to manage failover and failback.</span></span> <span data-ttu-id="e777c-140">对于某些业务方案，而不是其他业务方案，可能会增加额外的成本和复杂性。</span><span class="sxs-lookup"><span data-stu-id="e777c-140">The additional cost and complexity might be justified for some business scenarios, but not others.</span></span>

<span data-ttu-id="e777c-141">若要构建冗余，需要确定应用程序中的关键路径，然后确定路径中每个点是否有冗余？</span><span class="sxs-lookup"><span data-stu-id="e777c-141">To architect redundancy, you need to identify the critical paths in your application, and then determine if there's redundancy at each point in the path?</span></span> <span data-ttu-id="e777c-142">如果子系统应失败，应用程序是否会故障转移到其他内容？</span><span class="sxs-lookup"><span data-stu-id="e777c-142">If a subsystem should fail, will the application fail over to something else?</span></span> <span data-ttu-id="e777c-143">最后，你需要清楚地了解内置于 Azure 云平台的功能，你可以利用这些功能满足你的冗余要求。</span><span class="sxs-lookup"><span data-stu-id="e777c-143">Finally, you need a clear understanding of those features built into the Azure cloud platform that you can leverage to meet your redundancy requirements.</span></span> <span data-ttu-id="e777c-144">下面是用于构建冗余的建议：</span><span class="sxs-lookup"><span data-stu-id="e777c-144">Here are recommendations for architecting redundancy:</span></span>

- <span data-ttu-id="e777c-145">*部署服务的多个实例。*</span><span class="sxs-lookup"><span data-stu-id="e777c-145">*Deploy multiple instances of services.*</span></span> <span data-ttu-id="e777c-146">如果应用程序依赖于服务的单个实例，则会造成单一故障点。</span><span class="sxs-lookup"><span data-stu-id="e777c-146">If your application depends on a single instance of a service, it creates a single point of failure.</span></span> <span data-ttu-id="e777c-147">预配多个实例能够提高复原能力和可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="e777c-147">Provisioning multiple instances improves both resiliency and scalability.</span></span> <span data-ttu-id="e777c-148">在 Azure Kubernetes 服务中托管时，可以通过声明方式在 Kubernetes 清单文件中配置冗余实例（副本集）。</span><span class="sxs-lookup"><span data-stu-id="e777c-148">When hosting in Azure Kubernetes Service, you can declaratively configure redundant instances (replica sets) in the Kubernetes manifest file.</span></span> <span data-ttu-id="e777c-149">可以通过编程方式、在门户中或通过自动缩放功能来管理副本计数值。</span><span class="sxs-lookup"><span data-stu-id="e777c-149">The replica count value can be managed programmatically, in the portal, or through autoscaling features.</span></span>

- <span data-ttu-id="e777c-150">*利用负载均衡器。*</span><span class="sxs-lookup"><span data-stu-id="e777c-150">*Leveraging a load balancer.*</span></span> <span data-ttu-id="e777c-151">负载平衡将应用程序的请求分发到正常服务实例，并自动从旋转中删除不正常的实例。</span><span class="sxs-lookup"><span data-stu-id="e777c-151">Load-balancing distributes your application's requests to healthy service instances and automatically removes unhealthy instances from rotation.</span></span> <span data-ttu-id="e777c-152">部署到 Kubernetes 时，可以在 "服务" 部分的 Kubernetes 清单文件中指定负载平衡。</span><span class="sxs-lookup"><span data-stu-id="e777c-152">When deploying to Kubernetes, load balancing can be specified in the Kubernetes manifest file in the Services section.</span></span>

- <span data-ttu-id="e777c-153">*规划多区域部署。*</span><span class="sxs-lookup"><span data-stu-id="e777c-153">*Plan for multiregion deployment.*</span></span> <span data-ttu-id="e777c-154">如果将应用程序部署到单个区域，并且该区域变得不可用，应用程序也会变得不可用。</span><span class="sxs-lookup"><span data-stu-id="e777c-154">If you deploy your application to a single region, and that region becomes unavailable, your application will also become unavailable.</span></span> <span data-ttu-id="e777c-155">在应用程序的服务级别协议条款下，这可能是不可接受的。</span><span class="sxs-lookup"><span data-stu-id="e777c-155">This may be unacceptable under the terms of your application's service level agreements.</span></span> <span data-ttu-id="e777c-156">请考虑跨多个区域部署应用程序及其服务。</span><span class="sxs-lookup"><span data-stu-id="e777c-156">Instead, consider deploying your application and its services across multiple regions.</span></span> <span data-ttu-id="e777c-157">例如，Azure Kubernetes Service （AKS）群集部署到单个区域。</span><span class="sxs-lookup"><span data-stu-id="e777c-157">For example, an Azure Kubernetes Service (AKS) cluster is deployed to a single region.</span></span> <span data-ttu-id="e777c-158">为了保护系统免受区域性故障的危害，你可以将应用程序部署到跨不同区域的多个 AKS 群集，并使用[配对区域](https://buildazure.com/2017/01/06/azure-region-pairs-explained/)功能来协调平台更新并设置恢复工作的优先级。</span><span class="sxs-lookup"><span data-stu-id="e777c-158">To protect your system from a regional failure, you might deploy your application to multiple AKS clusters across different regions and use the [Paired Regions](https://buildazure.com/2017/01/06/azure-region-pairs-explained/) feature to coordinate platform updates and prioritize recovery efforts.</span></span>

- <span data-ttu-id="e777c-159">*启用[异地复制](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication)。*</span><span class="sxs-lookup"><span data-stu-id="e777c-159">*Enable [geo-replication](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication).*</span></span> <span data-ttu-id="e777c-160">适用于 Azure SQL 数据库和 Cosmos DB 等服务的异地复制将跨多个区域创建数据的次要副本。</span><span class="sxs-lookup"><span data-stu-id="e777c-160">Geo-replication for services such as Azure SQL Database and Cosmos DB will create secondary replicas of your data across multiple regions.</span></span> <span data-ttu-id="e777c-161">尽管这两种服务都将自动复制同一区域内的数据，但异地复制可让你在故障转移到次要区域时防止出现区域性中断。</span><span class="sxs-lookup"><span data-stu-id="e777c-161">While both services will automatically replicate data within the same region, geo-replication protects you against a regional outage by enabling you to fail over to a secondary region.</span></span> <span data-ttu-id="e777c-162">异地复制的另一种最佳做法是存储容器映像。</span><span class="sxs-lookup"><span data-stu-id="e777c-162">Another best practice for geo-replication centers around storing container images.</span></span> <span data-ttu-id="e777c-163">若要在 AKS 中部署服务，需要存储存储库中的映像并将其从存储库中提取。</span><span class="sxs-lookup"><span data-stu-id="e777c-163">To deploy a service in AKS, you need to store and pull the image from a repository.</span></span> <span data-ttu-id="e777c-164">Azure 容器注册表与 AKS 集成，可以安全地存储容器映像。</span><span class="sxs-lookup"><span data-stu-id="e777c-164">Azure Container Registry integrates with AKS and can securely store container images.</span></span> <span data-ttu-id="e777c-165">若要提高性能和可用性，请考虑将映像异地复制到每个区域中有 AKS 群集的注册表。</span><span class="sxs-lookup"><span data-stu-id="e777c-165">To improve performance and availability, consider geo-replicating your images to a registry in each region where you have an AKS cluster.</span></span> <span data-ttu-id="e777c-166">然后，每个 AKS 群集从其区域中的本地容器注册表中提取容器映像，如图6-4 所示：</span><span class="sxs-lookup"><span data-stu-id="e777c-166">Each AKS cluster then pulls container images from the local container registry in its region as shown in Figure 6-4:</span></span>

![跨区域复制的资源](./media/replicated-resources.png)

<span data-ttu-id="e777c-168">**图 6-4**。</span><span class="sxs-lookup"><span data-stu-id="e777c-168">**Figure 6-4**.</span></span> <span data-ttu-id="e777c-169">跨区域复制的资源</span><span class="sxs-lookup"><span data-stu-id="e777c-169">Replicated resources across regions</span></span>

- <span data-ttu-id="e777c-170">*实现 DNS 流量负载均衡器。*</span><span class="sxs-lookup"><span data-stu-id="e777c-170">*Implement a DNS traffic load balancer.*</span></span> <span data-ttu-id="e777c-171">[Azure 流量管理器](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)通过 DNS 级别的负载均衡为关键应用程序提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="e777c-171">[Azure Traffic Manager](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview) provides high-availability for critical applications by load-balancing at the DNS level.</span></span> <span data-ttu-id="e777c-172">它可以根据地理位置、群集响应时间甚至应用程序终结点运行状况，将流量路由到不同区域。</span><span class="sxs-lookup"><span data-stu-id="e777c-172">It can route traffic to different regions based on geography, cluster response time, and even application endpoint health.</span></span> <span data-ttu-id="e777c-173">例如，Azure 流量管理器可以将客户定向到最近的 AKS 群集和应用程序实例。</span><span class="sxs-lookup"><span data-stu-id="e777c-173">For example, Azure Traffic Manager can direct customers to the closest AKS cluster and application instance.</span></span> <span data-ttu-id="e777c-174">如果在不同的区域中创建了多个 AKS 群集，请使用流量管理器控制如何将流量传送到每个群集中运行的应用程序。</span><span class="sxs-lookup"><span data-stu-id="e777c-174">If you have multiple AKS clusters in different regions, use Traffic Manager to control how traffic flows to the applications that run in each cluster.</span></span> <span data-ttu-id="e777c-175">图6-5 显示了这种情况。</span><span class="sxs-lookup"><span data-stu-id="e777c-175">Figure 6-5 shows this scenario.</span></span>

![AKS 和 Azure 流量管理器](./media/aks-traffic-manager.png)

<span data-ttu-id="e777c-177">图 6-5\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="e777c-177">**Figure 6-5**.</span></span> <span data-ttu-id="e777c-178">AKS 和 Azure 流量管理器</span><span class="sxs-lookup"><span data-stu-id="e777c-178">AKS and Azure Traffic Manager</span></span>

## <a name="design-for-scalability"></a><span data-ttu-id="e777c-179">可伸缩性设计</span><span class="sxs-lookup"><span data-stu-id="e777c-179">Design for scalability</span></span>

<span data-ttu-id="e777c-180">云经久不衰缩放。</span><span class="sxs-lookup"><span data-stu-id="e777c-180">The cloud thrives on scaling.</span></span> <span data-ttu-id="e777c-181">增加/减少系统资源以满足增加/减少系统负载的能力是 Azure 云的关键原则。</span><span class="sxs-lookup"><span data-stu-id="e777c-181">The ability to increase/decrease system resources to address increasing/decreasing system load is a key tenet of the Azure cloud.</span></span> <span data-ttu-id="e777c-182">但为了有效地缩放应用程序，你需要了解应用程序中包含的每个 Azure 服务的缩放功能。</span><span class="sxs-lookup"><span data-stu-id="e777c-182">But, to effectively scale an application, you need an understanding of the scaling features of each Azure service that you include in your application.</span></span>  <span data-ttu-id="e777c-183">下面是在系统中有效实施缩放的建议。</span><span class="sxs-lookup"><span data-stu-id="e777c-183">Here are recommendations for effectively implementing scaling in your system.</span></span>

- <span data-ttu-id="e777c-184">*针对缩放进行设计。*</span><span class="sxs-lookup"><span data-stu-id="e777c-184">*Design for scaling.*</span></span> <span data-ttu-id="e777c-185">应用程序必须设计用于缩放。</span><span class="sxs-lookup"><span data-stu-id="e777c-185">An application must be designed for scaling.</span></span> <span data-ttu-id="e777c-186">若要开始，服务应是无状态的，以便可以将请求路由到任何实例。</span><span class="sxs-lookup"><span data-stu-id="e777c-186">To start, services should be stateless so that requests can be routed to any instance.</span></span> <span data-ttu-id="e777c-187">具有无状态服务还意味着添加或删除实例并不会对当前用户造成不利影响。</span><span class="sxs-lookup"><span data-stu-id="e777c-187">Having stateless services also means that adding or removing an instance doesn't adversely impact current users.</span></span>

- <span data-ttu-id="e777c-188">对*工作负荷进行分区*。</span><span class="sxs-lookup"><span data-stu-id="e777c-188">*Partition workloads*.</span></span> <span data-ttu-id="e777c-189">分解域转换为独立的独立微服务，使每个服务可以独立于其他服务进行缩放。</span><span class="sxs-lookup"><span data-stu-id="e777c-189">Decomposing domains into independent, self-contained microservices enable each service to scale independently of others.</span></span> <span data-ttu-id="e777c-190">通常，服务具有不同的可伸缩性需求和要求。</span><span class="sxs-lookup"><span data-stu-id="e777c-190">Typically, services will have different scalability needs and requirements.</span></span> <span data-ttu-id="e777c-191">利用分区，你只需缩放需要缩放的内容，而无需对整个应用程序进行缩放。</span><span class="sxs-lookup"><span data-stu-id="e777c-191">Partitioning enables you to scale only what needs to be scaled without the unnecessary cost of scaling an entire application.</span></span>

- <span data-ttu-id="e777c-192">*优选横向扩展。* 基于云的应用程序倾向于横向扩展资源，而不是纵向扩展。</span><span class="sxs-lookup"><span data-stu-id="e777c-192">*Favor scale-out.* Cloud-based applications favor scaling out resources as opposed to scaling up.</span></span> <span data-ttu-id="e777c-193">横向扩展（也称为水平缩放）涉及到将更多服务资源添加到现有系统以满足并共享所需的性能级别。</span><span class="sxs-lookup"><span data-stu-id="e777c-193">Scaling out (also known as horizontal scaling) involves adding more service resources to an existing system to meet and share a desired level of performance.</span></span> <span data-ttu-id="e777c-194">向上缩放（也称为垂直缩放）涉及到用功能更强大的硬件（更多的磁盘、内存和处理核心）替换现有资源。</span><span class="sxs-lookup"><span data-stu-id="e777c-194">Scaling up (also known as vertical scaling) involves replacing existing resources with more powerful hardware (more disk, memory, and processing cores).</span></span> <span data-ttu-id="e777c-195">可以使用某些 Azure 云资源中提供的自动缩放功能来自动调用横向扩展。</span><span class="sxs-lookup"><span data-stu-id="e777c-195">Scaling out can be invoked automatically with the autoscaling features available in some Azure cloud resources.</span></span> <span data-ttu-id="e777c-196">跨多个资源横向扩展还会增加整个系统的冗余性。</span><span class="sxs-lookup"><span data-stu-id="e777c-196">Scaling out across multiple resources also adds redundancy to the overall system.</span></span> <span data-ttu-id="e777c-197">最后，增加单个资源通常比在多个较小的资源上横向扩展更昂贵。</span><span class="sxs-lookup"><span data-stu-id="e777c-197">Finally scaling up a single resource is typically more expensive than scaling out across many smaller resources.</span></span> <span data-ttu-id="e777c-198">图6-6 显示了两种方法：</span><span class="sxs-lookup"><span data-stu-id="e777c-198">Figure 6-6 shows the two approaches:</span></span>

![向上缩放和向外缩放](./media/scale-up-scale-out.png)

<span data-ttu-id="e777c-200">**图6-6。**</span><span class="sxs-lookup"><span data-stu-id="e777c-200">**Figure 6-6.**</span></span> <span data-ttu-id="e777c-201">向上缩放和向外缩放</span><span class="sxs-lookup"><span data-stu-id="e777c-201">Scale up versus scale out</span></span>

- <span data-ttu-id="e777c-202">*按比例缩放。*</span><span class="sxs-lookup"><span data-stu-id="e777c-202">*Scale proportionally.*</span></span> <span data-ttu-id="e777c-203">缩放服务时，请考虑*资源集*。</span><span class="sxs-lookup"><span data-stu-id="e777c-203">When scaling a service, think in terms of *resource sets*.</span></span> <span data-ttu-id="e777c-204">如果要大幅扩展特定服务，对后端数据存储、缓存和依赖服务有什么影响？</span><span class="sxs-lookup"><span data-stu-id="e777c-204">If you were to dramatically scale out a specific service, what impact would that have on back-end data stores, caches and dependent services?</span></span> <span data-ttu-id="e777c-205">某些资源（如 Cosmos DB）可以按比例横向扩展，而其他资源则不能。</span><span class="sxs-lookup"><span data-stu-id="e777c-205">Some resources such as Cosmos DB can scale out proportionally, while many others can't.</span></span> <span data-ttu-id="e777c-206">需要确保不会将资源扩展到将耗尽其他关联资源的点。</span><span class="sxs-lookup"><span data-stu-id="e777c-206">You want to ensure that you don't scale out a resource to a point where it will exhaust other associated resources.</span></span>

- <span data-ttu-id="e777c-207">*避免关联。*</span><span class="sxs-lookup"><span data-stu-id="e777c-207">*Avoid affinity.*</span></span> <span data-ttu-id="e777c-208">最佳做法是确保节点不需要本地关联，这通常称为 "*粘滞会话*"。</span><span class="sxs-lookup"><span data-stu-id="e777c-208">A best practice is to ensure a node doesn't require local affinity, often referred to as a *sticky session*.</span></span> <span data-ttu-id="e777c-209">请求应能够路由到任何实例。</span><span class="sxs-lookup"><span data-stu-id="e777c-209">A request should be able to route to any instance.</span></span> <span data-ttu-id="e777c-210">如果需要保存状态，则应将其保存到分布式缓存（如[Azure Redis 缓存](https://azure.microsoft.com/services/cache/)）。</span><span class="sxs-lookup"><span data-stu-id="e777c-210">If you need to persist state, it should be saved to a distributed cache, such as [Azure Redis cache](https://azure.microsoft.com/services/cache/).</span></span>

- <span data-ttu-id="e777c-211">*充分利用平台自动缩放功能。*</span><span class="sxs-lookup"><span data-stu-id="e777c-211">*Take advantage of platform autoscaling features.*</span></span> <span data-ttu-id="e777c-212">尽可能使用内置自动缩放功能，而不是自定义或第三方机制。</span><span class="sxs-lookup"><span data-stu-id="e777c-212">Use built-in autoscaling features whenever possible, rather than custom or third-party mechanisms.</span></span> <span data-ttu-id="e777c-213">如果可能，请使用计划的缩放规则，确保资源在无需启动延迟的情况下可用，但根据需要向规则中添加反应性的自动缩放，以应对要求的意外更改。</span><span class="sxs-lookup"><span data-stu-id="e777c-213">Where possible, use scheduled scaling rules to ensure that resources are available without a startup delay, but add reactive autoscaling to the rules as appropriate, to cope with unexpected changes in demand.</span></span> <span data-ttu-id="e777c-214">有关详细信息，请参阅自动[缩放指南](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling)。</span><span class="sxs-lookup"><span data-stu-id="e777c-214">For more information, see [Autoscaling guidance](https://docs.microsoft.com/azure/architecture/best-practices/auto-scaling).</span></span>

- <span data-ttu-id="e777c-215">*主动扩展。*</span><span class="sxs-lookup"><span data-stu-id="e777c-215">*Scale out aggressively.*</span></span> <span data-ttu-id="e777c-216">最后一种做法是主动扩展，使你可以快速实现流量高峰，而不会失去业务。</span><span class="sxs-lookup"><span data-stu-id="e777c-216">A final practice would be to scale out aggressively so that you can quickly meet immediate spikes in traffic without losing business.</span></span> <span data-ttu-id="e777c-217">然后，谨慎地放大（即，删除不需要的实例）以使系统稳定。</span><span class="sxs-lookup"><span data-stu-id="e777c-217">And, then scale in (that is, remove unneeded instances) conservatively to keep the system stable.</span></span> <span data-ttu-id="e777c-218">实现此操作的一种简单方法是设置冷停机时间，这是在缩放操作之间等待的时间，为添加资源的时间设置为5分钟，删除实例最多需要15分钟。</span><span class="sxs-lookup"><span data-stu-id="e777c-218">A simple way to implement this is to set the cool down period, which is the time to wait between scaling operations, to five minutes for adding resources and up to 15 minutes for removing instances.</span></span>

## <a name="built-in-retry-in-services"></a><span data-ttu-id="e777c-219">服务中的内置重试</span><span class="sxs-lookup"><span data-stu-id="e777c-219">Built-in retry in services</span></span>

<span data-ttu-id="e777c-220">我们建议在前面的部分中实现编程重试操作的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="e777c-220">We encouraged the best practice of implementing programmatic retry operations in an earlier section.</span></span> <span data-ttu-id="e777c-221">请记住，许多 Azure 服务及其对应的客户端 Sdk 还包括重试机制。</span><span class="sxs-lookup"><span data-stu-id="e777c-221">Keep in mind that many Azure services and their corresponding client SDKs also include retry mechanisms.</span></span> <span data-ttu-id="e777c-222">以下列表汇总了本书所述的许多 Azure 服务中的重试功能：</span><span class="sxs-lookup"><span data-stu-id="e777c-222">The following list summarizes retry features in the many of the Azure services that are discussed in this book:</span></span>

- <span data-ttu-id="e777c-223">*Azure Cosmos DB。*</span><span class="sxs-lookup"><span data-stu-id="e777c-223">*Azure Cosmos DB.*</span></span> <span data-ttu-id="e777c-224"><xref:Microsoft.Azure.Documents.Client.DocumentClient>来自客户端 API 的类将自动停用失败的尝试。</span><span class="sxs-lookup"><span data-stu-id="e777c-224">The <xref:Microsoft.Azure.Documents.Client.DocumentClient> class from the client API automatically retires failed attempts.</span></span> <span data-ttu-id="e777c-225">重试次数和最长等待时间是可配置的。</span><span class="sxs-lookup"><span data-stu-id="e777c-225">The number of retries and maximum wait time are configurable.</span></span> <span data-ttu-id="e777c-226">客户端 API 引发的异常可能是超过重试策略或非暂时性错误的请求。</span><span class="sxs-lookup"><span data-stu-id="e777c-226">Exceptions thrown by the client API are either requests that exceed the retry policy or non-transient errors.</span></span>

- <span data-ttu-id="e777c-227">*Azure Redis 缓存。*</span><span class="sxs-lookup"><span data-stu-id="e777c-227">*Azure Redis Cache.*</span></span> <span data-ttu-id="e777c-228">Redis Stackexchange.redis 客户端使用连接管理器类，其中包含尝试失败时的重试次数。</span><span class="sxs-lookup"><span data-stu-id="e777c-228">The Redis StackExchange client uses a connection manager class that includes retries on failed attempts.</span></span> <span data-ttu-id="e777c-229">重试次数、特定的重试策略和等待时间都是可配置的。</span><span class="sxs-lookup"><span data-stu-id="e777c-229">The number of retries, specific retry policy and wait time are all configurable.</span></span>

- <span data-ttu-id="e777c-230">*Azure 服务总线。*</span><span class="sxs-lookup"><span data-stu-id="e777c-230">*Azure Service Bus.*</span></span> <span data-ttu-id="e777c-231">服务总线客户端公开[RetryPolicy 类，该类](xref:Microsoft.ServiceBus.RetryPolicy)可以使用后向后间隔、重试次数和 <xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer%2A> （指定操作可以执行的最大时间）进行配置。</span><span class="sxs-lookup"><span data-stu-id="e777c-231">The Service Bus client exposes a [RetryPolicy class](xref:Microsoft.ServiceBus.RetryPolicy) that can be configured with a back-off interval, retry count, and <xref:Microsoft.ServiceBus.RetryExponential.TerminationTimeBuffer%2A>, which specifies the maximum time an operation can take.</span></span> <span data-ttu-id="e777c-232">默认策略为9次最大重试次数，两次尝试之间的回退时间间隔为30秒。</span><span class="sxs-lookup"><span data-stu-id="e777c-232">The default policy is nine maximum retry attempts with a 30-second backoff period between attempts.</span></span>

- <span data-ttu-id="e777c-233">*Azure SQL 数据库。*</span><span class="sxs-lookup"><span data-stu-id="e777c-233">*Azure SQL Database.*</span></span> <span data-ttu-id="e777c-234">使用[Entity Framework Core](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency)库时，将提供重试支持。</span><span class="sxs-lookup"><span data-stu-id="e777c-234">Retry support is provided when using the [Entity Framework Core](https://docs.microsoft.com/ef/core/miscellaneous/connection-resiliency) library.</span></span>

- <span data-ttu-id="e777c-235">*Azure 存储。*</span><span class="sxs-lookup"><span data-stu-id="e777c-235">*Azure Storage.*</span></span> <span data-ttu-id="e777c-236">存储客户端库支持重试操作。</span><span class="sxs-lookup"><span data-stu-id="e777c-236">The storage client library support retry operations.</span></span> <span data-ttu-id="e777c-237">每个 Azure 存储表、blob 和队列的策略各不相同。</span><span class="sxs-lookup"><span data-stu-id="e777c-237">The strategies vary across Azure storage tables, blobs, and queues.</span></span> <span data-ttu-id="e777c-238">同时，当启用异地冗余功能时，备用重试会在主要和辅助存储服务位置之间切换。</span><span class="sxs-lookup"><span data-stu-id="e777c-238">As well, alternate retries switch between primary and secondary storage services locations when the geo-redundancy feature is enabled.</span></span>

- <span data-ttu-id="e777c-239">*Azure 事件中心。*</span><span class="sxs-lookup"><span data-stu-id="e777c-239">*Azure Event Hubs.*</span></span> <span data-ttu-id="e777c-240">事件中心客户端库具有 RetryPolicy 属性，该属性包含可配置的指数回退功能。</span><span class="sxs-lookup"><span data-stu-id="e777c-240">The Event Hub client library features a RetryPolicy property, which includes a configurable exponential backoff feature.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="e777c-241">[上一页](application-resiliency-patterns.md)
>[下一页](resilient-communications.md)</span><span class="sxs-lookup"><span data-stu-id="e777c-241">[Previous](application-resiliency-patterns.md)
[Next](resilient-communications.md)</span></span>
