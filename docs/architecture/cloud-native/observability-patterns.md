---
title: 可观测性模式
description: 适用于云原生应用程序的可观察性模式
ms.date: 02/05/2020
ms.openlocfilehash: a821235835b4553760b19887d500a29ca75e133e
ms.sourcegitcommit: 700ea803fb06c5ce98de017c7f76463ba33ff4a9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/19/2020
ms.locfileid: "77448501"
---
# <a name="observability-patterns"></a>可观测性模式

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

正如为了帮助应用程序中的代码布局而开发的模式一样，以可靠方式为操作应用程序提供模式。 维护应用程序的三种有用模式已经出现：**日志记录**、**监视**和**警报**。

## <a name="when-to-use-logging"></a>何时使用日志记录

无论如何，应用程序在生产中几乎总是以意想不到的方式运行。 当用户报告应用程序出现问题时，如果出现问题，可以查看应用程序的情况非常有用。 捕获有关应用程序在运行时所做操作的信息的一种最尝试和真正的方法是让应用程序记下正在执行的操作。 此过程称为日志记录。 在生产环境中出现故障或问题时，目标应该是在非生产环境中重现发生失败的情况。 准备好的日志记录可为开发人员提供一个路线图，以便在可通过测试和 vspackage 的环境中重现问题。

### <a name="challenges-when-logging-with-cloud-native-applications"></a>用云本机应用程序进行日志记录时遇到的难题

在传统的应用程序中，日志文件通常存储在本地计算机上。 事实上，在类似 Unix 的操作系统上，有一个文件夹结构定义为保存任何日志，通常在 `/var/log`下。

![日志记录到单一应用中的文件。](./media/single-monolith-logging.png)
**图 7-1**。 记录到单一应用中的文件。

在云环境中，将日志记录到单台计算机上的平面文件的有用性大大减少。 生成日志的应用程序可能无法访问本地磁盘或本地磁盘，因为容器是在物理计算机上无序的。 即使是在多个节点上进行单一应用程序的简单扩展，也可以很难找到相应的基于文件的日志文件。

![日志记录到缩放的单一应用中的文件。](./media/multiple-node-monolith-logging.png)
**图 7-2**。 记录到缩放的单一应用中的文件。

使用微服务体系结构开发的云本机应用程序还会对基于文件的记录器带来一些挑战。 用户请求现在可能跨在不同计算机上运行的多个服务，可能包括无服务器功能，而不能访问本地文件系统。 将用户或会话中的日志与许多服务和计算机的关联起来非常困难。

![日志记录到微服务应用中的本地文件。](./media/local-log-file-per-service.png)
**图 7-3**。 在微服务应用中记录到本地文件。

最后，某些云本机应用程序中的用户数很高。 假设每个用户登录到应用程序时都会生成几百行的日志消息。 隔离，这是可管理的，但比100000用户和日志量要大得多，因为需要使用专用工具来支持有效地使用日志。

### <a name="logging-in-cloud-native-applications"></a>云本机应用程序中的日志记录

每种编程语言都有允许编写日志的工具，通常，写入这些日志的开销也很低。 许多日志记录库提供了记录不同种类的重要性，可在运行时进行优化。 例如， [Serilog 库](https://serilog.net/)是适用于 .net 的常用结构化日志记录库，提供以下日志记录级别：

* “详细”
* 调试
* 信息
* 警告
* 错误
* 出现

这些不同的日志级别提供日志记录的粒度。 当应用程序在生产环境中正常运行时，可以将其配置为仅记录重要的消息。 当应用程序行为不好时，可以增加日志级别，以便收集更详细的日志。 这会平衡性能，使其易于调试。

日志记录工具的高性能和详细级别的 tunability 应鼓励开发人员经常记录。 很多倾向于记录每个方法的输入和退出的模式。 这种方法可能听起来像是多余，但开发人员很少需要更少的日志记录。 事实上，出于将日志记录添加到有问题的方法的唯一目的，执行部署并不少见。 错误记录一侧，而不太少。 某些工具可用于自动提供此类日志记录。

由于在云本机应用程序中使用基于文件的日志的相关挑战，因此最好使用集中式日志。 日志由应用程序收集，并发送到一个集中式日志记录应用程序，用于索引和存储日志。 此类系统每天可以引入数十个千兆字节的日志。

构建跨越许多服务的日志记录时，遵循一些标准做法也是有帮助的。 例如，在时间较长的交互时生成[相关 ID](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/) ，然后将其记录在与该交互相关的每个消息中，使得搜索所有相关消息变得更加容易。 只需查找单个消息，然后提取相关 ID 即可查找所有相关的消息。 另一个示例是确保每个服务的日志格式都是相同的，无论使用何种语言或日志记录库。 这一标准化使得读取日志变得更加容易。 图7-4 演示了微服务体系结构如何利用集中式日志记录作为其工作流的一部分。

来自各种来源的 ![日志会被引入到一个集中的日志存储中。](./media/centralized-logging.png)
**图 7-4**。 来自各种来源的日志会被引入到一个集中的日志存储中。

## <a name="challenges-with-detecting-and-responding-to-potential-app-health-issues"></a>检测和响应潜在的应用运行状况问题的挑战

有些应用程序并不关键。 也许它们只能在内部使用，并且在出现问题时，用户可以与负责的团队联系，并且可以重新启动应用程序。 但是，客户通常对其使用的应用程序具有更高的预期。 你应了解应用程序在用户执行*之前*或用户通知你之前出现的问题。 否则，你可能会发现，当你发现 deriding 你的应用程序甚至你的组织的社交媒体帖子被

你可能需要考虑的一些情况包括：

- 应用程序中的一个服务会继续失败和重新启动，从而导致响应间歇缓慢。
- 在一天中的某个时间，你的应用程序的响应时间会很慢。
- 最近的部署后，对数据库的负载 tripled。

正确实现后，监视可以让你了解将导致问题的条件，让你可以在这些条件导致严重的用户影响之前解决这些问题。

### <a name="monitoring-cloud-native-apps"></a>监视云本机应用

某些集中式日志记录系统采用额外的角色，在纯粹的日志以外收集遥测数据。 它们可以收集指标，例如运行数据库查询所用的时间、来自 web 服务器的平均响应时间，甚至是操作系统报告的 CPU 负载平均值和内存压力。 这些系统与日志结合使用，可提供系统中节点和整个应用程序的运行状况的整体视图。

还可以从应用程序中手动采集监视工具的指标收集功能。 可能会检测到特别感兴趣的业务流程（如新用户注册或订单），以使其在中央监视系统中递增计数器。 这会解锁监视工具，不仅监视应用程序的运行状况，而且还会监视业务的运行状况。

可以在日志聚合工具中构造查询，以查找特定的统计信息或模式，然后在自定义仪表板上以图形形式显示这些统计信息或模式。 通常情况下，团队将投资完成与应用程序相关的统计信息。 这样一来，就很容易看到发生的问题。

云本机监视工具提供应用的实时遥测和见解，无论它们是单进程整体应用程序还是分布式微服务体系结构。 它们包括允许从应用收集数据的工具，以及用于查询和显示有关应用运行状况的信息的工具。

## <a name="challenges-with-reacting-to-critical-problems-in-cloud-native-apps"></a>对云本机应用中的严重问题做出反应的挑战

如果需要对应用程序的问题做出响应，则需要通过某种方式向正确的人员发出警报。 这是第三个云本机应用程序可观察性模式，具体取决于日志记录和监视。 你的应用程序需要有日志记录，以便能够诊断问题，并在某些情况下进入监视工具。 It 需要监视将应用程序指标和运行状况数据聚合到一个位置。 一旦建立了此值，则可以创建规则，当某些指标超出可接受的级别时，会触发警报。

通常，警报位于监视之上，因此，某些条件会触发适当的警报，通知团队成员发生了紧急问题。 可能需要警报的一些情况包括：

- 某个应用程序的服务在停机一分钟后没有响应。
- 应用程序正在将不成功的 HTTP 响应返回到超过1% 的请求。
- 应用程序的关键终结点平均响应时间超过2000毫秒。

### <a name="alerts-in-cloud-native-apps"></a>云本机应用中的警报

您可以对监视工具创建查询以查找已知的故障条件。 例如，查询可以在传入日志中搜索 HTTP 状态代码500的指示，这表示 web 服务器上存在问题。 一旦检测到其中一项，就可以将电子邮件或短信发送给发起调查的原始服务的所有者。

不过，通常情况下，单个500错误不足以确定是否出现了问题。 这可能意味着用户键入的密码不正确或输入的数据格式不正确。 仅当检测到的500错误的平均数量大于平均数量时，才会触发警报查询。

最有破坏性的警报模式之一就是激发太多的警报，供人们调查。 服务所有者很快就会 desensitized 以前调查并发现良性的错误。 然后，当发生 true 错误时，它们将在数百个误报的噪音下丢失。 [Cried 狼](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf)的 parable 经常被告知儿童向儿童发出警告。 务必确保触发的警报是真正的问题。

>[!div class="step-by-step"]
>[上一页](monitoring-health.md)
>[下一页](logging-with-elastic-stack.md)
