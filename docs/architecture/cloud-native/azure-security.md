---
title: 适用于云原生应用的 Azure 安全性
description: 构建适用于 Azure 的云本机 .NET 应用 |适用于云原生应用的 Azure 安全性
ms.date: 06/30/2019
ms.openlocfilehash: 27ef6c8313f1573ca686e8489a84f64a56116fa4
ms.sourcegitcommit: 046a9c22487551360e20ec39fc21eef99820a254
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/14/2020
ms.locfileid: "83394732"
---
# <a name="azure-security-for-cloud-native-apps"></a><span data-ttu-id="78a44-103">适用于云原生应用的 Azure 安全性</span><span class="sxs-lookup"><span data-stu-id="78a44-103">Azure security for cloud-native apps</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="78a44-104">与传统的应用程序相比，云本机应用程序的安全性更强且更难。</span><span class="sxs-lookup"><span data-stu-id="78a44-104">Cloud-native applications can be both easier and more difficult to secure than traditional applications.</span></span> <span data-ttu-id="78a44-105">缺点是，需要保护更小的应用程序，并将更多的精力用于构建安全基础结构。</span><span class="sxs-lookup"><span data-stu-id="78a44-105">On the downside, you need to secure more smaller applications and dedicate more energy to build out the security infrastructure.</span></span> <span data-ttu-id="78a44-106">大多数服务部署中的编程语言和样式的异类性质也意味着您需要更多地关注来自许多不同提供商的安全公告。</span><span class="sxs-lookup"><span data-stu-id="78a44-106">The heterogeneous nature of programming languages and styles in most service deployments also means you need to pay more attention to security bulletins from many different providers.</span></span>

<span data-ttu-id="78a44-107">另一方面，较小的服务，每个服务都有自己的数据存储，它限制了攻击的范围。</span><span class="sxs-lookup"><span data-stu-id="78a44-107">On the flip side, smaller services, each with their own data store, limit the scope of an attack.</span></span> <span data-ttu-id="78a44-108">如果攻击者损害一个系统，攻击者可能更难将跳转到另一个系统，而不是在单一应用程序中。</span><span class="sxs-lookup"><span data-stu-id="78a44-108">If an attacker compromises one system, it's probably more difficult for the attacker to make the jump to another system than it is in a monolithic application.</span></span> <span data-ttu-id="78a44-109">进程边界是强边界。</span><span class="sxs-lookup"><span data-stu-id="78a44-109">Process boundaries are strong boundaries.</span></span> <span data-ttu-id="78a44-110">而且，如果数据库备份泄露，则损害会受到更多的限制，因为数据库只包含数据的一个子集，并且不太可能包含个人数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-110">Also, if a database backup leaks, then the damage is more limited, as that database contains only a subset of data and is unlikely to contain personal data.</span></span>

## <a name="threat-modeling"></a><span data-ttu-id="78a44-111">威胁建模</span><span class="sxs-lookup"><span data-stu-id="78a44-111">Threat modeling</span></span>

<span data-ttu-id="78a44-112">无论优点是否比云本机应用程序的缺点更明显，都必须遵循相同的整体安全思维。</span><span class="sxs-lookup"><span data-stu-id="78a44-112">No matter if the advantages outweigh the disadvantages of cloud-native applications, the same holistic security mindset must be followed.</span></span> <span data-ttu-id="78a44-113">安全和安全思维必须是开发和操作情景的每个步骤的一部分。</span><span class="sxs-lookup"><span data-stu-id="78a44-113">Security and secure thinking must be part of every step of the development and operations story.</span></span> <span data-ttu-id="78a44-114">规划应用程序时询问以下问题：</span><span class="sxs-lookup"><span data-stu-id="78a44-114">When planning an application ask questions like:</span></span>

- <span data-ttu-id="78a44-115">此数据丢失的后果是什么？</span><span class="sxs-lookup"><span data-stu-id="78a44-115">What would be the impact of this data being lost?</span></span>
- <span data-ttu-id="78a44-116">如何限制将错误数据注入此服务的损害？</span><span class="sxs-lookup"><span data-stu-id="78a44-116">How can we limit the damage from bad data being injected into this service?</span></span>
- <span data-ttu-id="78a44-117">谁有权访问此数据？</span><span class="sxs-lookup"><span data-stu-id="78a44-117">Who should have access to this data?</span></span>
- <span data-ttu-id="78a44-118">开发和发布过程是否有审核策略？</span><span class="sxs-lookup"><span data-stu-id="78a44-118">Are there auditing policies in place around the development and release process?</span></span>

<span data-ttu-id="78a44-119">所有这些问题都是名为 "[威胁建模](https://docs.microsoft.com/azure/security/azure-security-threat-modeling-tool)" 的过程的一部分。</span><span class="sxs-lookup"><span data-stu-id="78a44-119">All these questions are part of a process called [threat modeling](https://docs.microsoft.com/azure/security/azure-security-threat-modeling-tool).</span></span> <span data-ttu-id="78a44-120">此过程将尝试回答系统面临的威胁的问题、威胁的可能性以及潜在的损害。</span><span class="sxs-lookup"><span data-stu-id="78a44-120">This process tries to answer the question of what threats there are to the system, how likely the threats are, and the potential damage from them.</span></span>

<span data-ttu-id="78a44-121">一旦建立了威胁列表，就需要决定是否值得缓解这些威胁。</span><span class="sxs-lookup"><span data-stu-id="78a44-121">Once the list of threats has been established, you need to decide whether they're worth mitigating.</span></span> <span data-ttu-id="78a44-122">有时，对威胁的规划不太可能和昂贵，因为这样做并不值得花费大量精力。</span><span class="sxs-lookup"><span data-stu-id="78a44-122">Sometimes a threat is so unlikely and expensive to plan for that it isn't worth spending energy on it.</span></span> <span data-ttu-id="78a44-123">例如，某些状态级别执行组件可能会将更改注入到数百万设备使用的进程设计中。</span><span class="sxs-lookup"><span data-stu-id="78a44-123">For instance, some state level actor could inject changes into the design of a process that is used by millions of devices.</span></span> <span data-ttu-id="78a44-124">现在，此代码不会在[环 3](https://en.wikipedia.org/wiki/Protection_ring)中运行某个代码段，而是在环0中运行。</span><span class="sxs-lookup"><span data-stu-id="78a44-124">Now, instead of running a certain piece of code in [Ring 3](https://en.wikipedia.org/wiki/Protection_ring), that code is run in Ring 0.</span></span> <span data-ttu-id="78a44-125">这使得攻击者能够绕过虚拟机监控程序并在裸机计算机上运行攻击代码，从而允许在该硬件上运行的所有虚拟机上进行攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-125">This allows an exploit that can bypass the hypervisor and run the attack code on the bare metal machines, allowing attacks on all the virtual machines that are running on that hardware.</span></span>

<span data-ttu-id="78a44-126">在没有 microscope 的情况下，更改的处理器很难检测到该处理器的芯片设计的高级知识。</span><span class="sxs-lookup"><span data-stu-id="78a44-126">The altered processors are difficult to detect without a microscope and advanced knowledge of the on silicon design of that processor.</span></span> <span data-ttu-id="78a44-127">这种情况不太可能发生，并且缓解起来很昂贵，因此可能没有威胁模型为它构建利用保护。</span><span class="sxs-lookup"><span data-stu-id="78a44-127">This scenario is unlikely to happen and expensive to mitigate, so probably no threat model would recommend building exploit protection for it.</span></span>

<span data-ttu-id="78a44-128">更有可能的威胁，例如允许增加攻击的损坏的访问控制 `Id` （ `Id=2` `Id=3` 在 URL 中替换为）或 SQL 注入，更具吸引力。</span><span class="sxs-lookup"><span data-stu-id="78a44-128">More likely threats, such as broken access controls permitting `Id` incrementing attacks (replacing `Id=2` with `Id=3` in the URL) or SQL injection, are more attractive to build protections against.</span></span> <span data-ttu-id="78a44-129">这些威胁的缓解措施非常合理，可以构建和阻止污点公司信誉的尴尬安全漏洞。</span><span class="sxs-lookup"><span data-stu-id="78a44-129">The mitigations for these threats are quite reasonable to build and prevent embarrassing security holes that smear the company's reputation.</span></span>

## <a name="principle-of-least-privilege"></a><span data-ttu-id="78a44-130">最低权限原则</span><span class="sxs-lookup"><span data-stu-id="78a44-130">Principle of least privilege</span></span>

<span data-ttu-id="78a44-131">计算机安全的一项初步理念是最小特权原则（POLP）。</span><span class="sxs-lookup"><span data-stu-id="78a44-131">One of the founding ideas in computer security is the Principle of Least Privilege (POLP).</span></span> <span data-ttu-id="78a44-132">它实际上是一个基本概念，其中的大多数形式都是数字或物理。</span><span class="sxs-lookup"><span data-stu-id="78a44-132">It's actually a foundational idea in most any form of security be it digital or physical.</span></span> <span data-ttu-id="78a44-133">简而言之，原则是，任何用户或进程都应具有执行其任务所需的最少权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-133">In short, the principle is that any user or process should have the smallest number of rights possible to execute its task.</span></span>

<span data-ttu-id="78a44-134">例如，在银行 tellers：访问 safe 是一种不常见的活动。</span><span class="sxs-lookup"><span data-stu-id="78a44-134">As an example, think of the tellers at a bank: accessing the safe is an uncommon activity.</span></span> <span data-ttu-id="78a44-135">因此，平均出纳不能打开安全的。</span><span class="sxs-lookup"><span data-stu-id="78a44-135">So, the average teller can't open the safe themselves.</span></span> <span data-ttu-id="78a44-136">若要获取访问权限，他们需要通过银行经理来升级其请求，该管理人员执行额外的安全检查。</span><span class="sxs-lookup"><span data-stu-id="78a44-136">To gain access, they need to escalate their request through a bank manager, who performs additional security checks.</span></span>

<span data-ttu-id="78a44-137">在计算机系统中，有一个极好的示例是用户连接到数据库的权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-137">In a computer system, a fantastic example is the rights of a user connecting to a database.</span></span> <span data-ttu-id="78a44-138">在许多情况下，只需使用单个用户帐户即可生成数据库结构并运行应用程序。</span><span class="sxs-lookup"><span data-stu-id="78a44-138">In many cases, there's a single user account used to both build the database structure and run the application.</span></span> <span data-ttu-id="78a44-139">除极端情况外，运行应用程序的帐户不需要更新架构信息的能力。</span><span class="sxs-lookup"><span data-stu-id="78a44-139">Except in extreme cases, the account running the application doesn't need the ability to update schema information.</span></span> <span data-ttu-id="78a44-140">应该有多个帐户提供不同级别的权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-140">There should be several accounts that provide different levels of privilege.</span></span> <span data-ttu-id="78a44-141">应用程序应仅使用授予对表中数据的读取和写入访问权限的权限级别。</span><span class="sxs-lookup"><span data-stu-id="78a44-141">The application should only use the permission level that grants read and write access to the data in the tables.</span></span> <span data-ttu-id="78a44-142">这种保护将消除旨在丢弃数据库表或引入恶意触发器的攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-142">This kind of protection would eliminate attacks that aimed to drop database tables or introduce malicious triggers.</span></span>

<span data-ttu-id="78a44-143">构建云本机应用程序的几乎每个部分都可以从记住最低权限原则中获益。</span><span class="sxs-lookup"><span data-stu-id="78a44-143">Almost every part of building a cloud-native application can benefit from remembering the principle of least privilege.</span></span> <span data-ttu-id="78a44-144">在基于角色的访问控制（RBAC）中设置防火墙、网络安全组、角色和作用域时，可以找到它。</span><span class="sxs-lookup"><span data-stu-id="78a44-144">You can find it at play when setting up firewalls, network security groups, roles, and scopes in Role-based access control (RBAC).</span></span>

## <a name="penetration-testing"></a><span data-ttu-id="78a44-145">渗透测试</span><span class="sxs-lookup"><span data-stu-id="78a44-145">Penetration testing</span></span>

<span data-ttu-id="78a44-146">随着应用程序变得更加复杂，攻击媒介的数量会以惊人的速度增长。</span><span class="sxs-lookup"><span data-stu-id="78a44-146">As applications become more complicated the number of attack vectors increases at an alarming rate.</span></span> <span data-ttu-id="78a44-147">威胁建模有一些缺陷，因为它通常由生成系统的人员执行。</span><span class="sxs-lookup"><span data-stu-id="78a44-147">Threat modeling is flawed in that it tends to be executed by the same people building the system.</span></span> <span data-ttu-id="78a44-148">与许多开发人员在构想用户交互和生成无法使用的用户界面方面一样，大多数开发人员都难以查看每个攻击向量。</span><span class="sxs-lookup"><span data-stu-id="78a44-148">In the same way that many developers have trouble envisioning user interactions and then build unusable user interfaces, most developers have difficulty seeing every attack vector.</span></span> <span data-ttu-id="78a44-149">构建系统的开发人员也有可能不会精通攻击方法，并错过一些重要的内容。</span><span class="sxs-lookup"><span data-stu-id="78a44-149">It's also possible that the developers building the system aren't well versed in attack methodologies and miss something crucial.</span></span>

<span data-ttu-id="78a44-150">渗透测试或 "笔测试" 涉及引入外部参与者来尝试攻击系统。</span><span class="sxs-lookup"><span data-stu-id="78a44-150">Penetration testing or "pen testing" involves bringing in external actors to attempt to attack the system.</span></span> <span data-ttu-id="78a44-151">这些攻击者可能是外部咨询公司或其他开发人员，他们可以从业务的其他部分获得良好的安全知识。</span><span class="sxs-lookup"><span data-stu-id="78a44-151">These attackers may be an external consulting company or other developers with good security knowledge from another part of the business.</span></span> <span data-ttu-id="78a44-152">他们将获得全权，尝试破坏系统。</span><span class="sxs-lookup"><span data-stu-id="78a44-152">They're given carte blanche to attempt to subvert the system.</span></span> <span data-ttu-id="78a44-153">通常，它们会发现需要修补的大量安全漏洞。</span><span class="sxs-lookup"><span data-stu-id="78a44-153">Frequently, they'll find extensive security holes that need to be patched.</span></span> <span data-ttu-id="78a44-154">有时，攻击向量将是完全意外的内容，例如对 CEO 的网络钓鱼攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-154">Sometimes the attack vector will be something totally unexpected like exploiting a phishing attack against the CEO.</span></span>

<span data-ttu-id="78a44-155">Azure 本身在[Microsoft 内部](https://azure.microsoft.com/resources/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/)不断遭受黑客的攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-155">Azure itself is constantly undergoing attacks from a [team of hackers inside Microsoft](https://azure.microsoft.com/resources/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/).</span></span> <span data-ttu-id="78a44-156">多年来，他们一直在寻找数十个潜在灾难性攻击媒介，在外部利用它们之前将它们关闭。</span><span class="sxs-lookup"><span data-stu-id="78a44-156">Over the years, they've been the first to find dozens of potentially catastrophic attack vectors, closing them before they can be exploited externally.</span></span> <span data-ttu-id="78a44-157">目标越诱人，永久的执行组件就越有可能尝试利用它，并且在世界上有一些目标比 Azure 更具吸引力。</span><span class="sxs-lookup"><span data-stu-id="78a44-157">The more tempting a target, the more likely that eternal actors will attempt to exploit it and there are a few targets in the world more tempting than Azure.</span></span>

## <a name="monitoring"></a><span data-ttu-id="78a44-158">监视</span><span class="sxs-lookup"><span data-stu-id="78a44-158">Monitoring</span></span>

<span data-ttu-id="78a44-159">如果攻击者尝试渗透某个应用程序，应该会出现一条警告。</span><span class="sxs-lookup"><span data-stu-id="78a44-159">Should an attacker attempt to penetrate an application, there should be some warning of it.</span></span> <span data-ttu-id="78a44-160">通常，通过检查服务中的日志可以发现攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-160">Frequently, attacks can be spotted by examining the logs from services.</span></span> <span data-ttu-id="78a44-161">攻击会留下 telltale 标志，使其能够成功完成。</span><span class="sxs-lookup"><span data-stu-id="78a44-161">Attacks leave telltale signs that can be spotted before they succeed.</span></span> <span data-ttu-id="78a44-162">例如，尝试猜测密码的攻击者会向登录系统发出许多请求。</span><span class="sxs-lookup"><span data-stu-id="78a44-162">For instance, an attacker attempting to guess a password will make many requests to a login system.</span></span> <span data-ttu-id="78a44-163">围绕登录系统的监视可以检测出与典型访问模式不存在的奇怪模式。</span><span class="sxs-lookup"><span data-stu-id="78a44-163">Monitoring around the login system can detect weird patterns that are out of line with the typical access pattern.</span></span> <span data-ttu-id="78a44-164">此监视功能可以变成警报，进而提醒操作人员激活某种类型的对策。</span><span class="sxs-lookup"><span data-stu-id="78a44-164">This monitoring can be turned into an alert that can, in turn, alert an operations person to activate some sort of countermeasure.</span></span> <span data-ttu-id="78a44-165">高度成熟的监视系统甚至可能会根据这些偏差采取措施，从而将规则提前用于阻止请求或限制响应。</span><span class="sxs-lookup"><span data-stu-id="78a44-165">A highly mature monitoring system might even take action based on these deviations proactively adding rules to block requests or throttle responses.</span></span>

## <a name="securing-the-build"></a><span data-ttu-id="78a44-166">保护生成</span><span class="sxs-lookup"><span data-stu-id="78a44-166">Securing the build</span></span>

<span data-ttu-id="78a44-167">大多数情况下，安全被忽略的一个地方就是在生成过程中。</span><span class="sxs-lookup"><span data-stu-id="78a44-167">One place where security is often overlooked is around the build process.</span></span> <span data-ttu-id="78a44-168">除了生成运行安全检查（如扫描不安全代码或签入凭据）外，生成本身应该是安全的。</span><span class="sxs-lookup"><span data-stu-id="78a44-168">Not only should the build run security checks, such as scanning for insecure code or checked-in credentials, but the build itself should be secure.</span></span> <span data-ttu-id="78a44-169">如果生成服务器已泄露，则它会提供一个极好的矢量来向产品引入任意代码。</span><span class="sxs-lookup"><span data-stu-id="78a44-169">If the build server is compromised, then it provides a fantastic vector for introducing arbitrary code into the product.</span></span>

<span data-ttu-id="78a44-170">假设攻击者希望窃取登录到 web 应用程序的用户的密码。</span><span class="sxs-lookup"><span data-stu-id="78a44-170">Imagine that an attacker is looking to steal the passwords of people signing into a web application.</span></span> <span data-ttu-id="78a44-171">它们可能会引入一个生成步骤，用于修改签出的代码以将任何登录请求镜像到其他服务器。</span><span class="sxs-lookup"><span data-stu-id="78a44-171">They could introduce a build step that modifies the checked-out code to mirror any login request to another server.</span></span> <span data-ttu-id="78a44-172">下一次执行代码时，该生成会自动更新。</span><span class="sxs-lookup"><span data-stu-id="78a44-172">The next time code goes through the build, it's silently updated.</span></span> <span data-ttu-id="78a44-173">源代码漏洞扫描在生成之前运行时不会捕获。</span><span class="sxs-lookup"><span data-stu-id="78a44-173">The source code vulnerability scanning won't catch this as it runs before the build.</span></span> <span data-ttu-id="78a44-174">同样，没有人会将其捕获到代码评审中，因为生成步骤会在生成服务器上运行。</span><span class="sxs-lookup"><span data-stu-id="78a44-174">Equally, nobody will catch it in a code review because the build steps live on the build server.</span></span> <span data-ttu-id="78a44-175">攻击者的代码会在生产环境中获取密码。</span><span class="sxs-lookup"><span data-stu-id="78a44-175">The exploited code will go to production where it can harvest passwords.</span></span> <span data-ttu-id="78a44-176">可能没有生成过程更改的审核日志，或者至少没有任何监视审核的情况。</span><span class="sxs-lookup"><span data-stu-id="78a44-176">Probably there's no audit log of the build process changes, or at least nobody monitoring the audit.</span></span>

<span data-ttu-id="78a44-177">这是一个很好的示例，可用于侵入系统。</span><span class="sxs-lookup"><span data-stu-id="78a44-177">This is a perfect example of a seemingly low value target that can be used to break into the system.</span></span> <span data-ttu-id="78a44-178">一旦攻击者破坏了系统的外围网络，他们就可以开始寻找将其权限提升到的方法，使他们能够在他们所喜欢的任何地方引起真实损害。</span><span class="sxs-lookup"><span data-stu-id="78a44-178">Once an attacker breaches the perimeter of the system, they can start working on finding ways to elevate their permissions to the point that they can cause real harm anywhere they like.</span></span>

## <a name="building-secure-code"></a><span data-ttu-id="78a44-179">构建安全代码</span><span class="sxs-lookup"><span data-stu-id="78a44-179">Building secure code</span></span>

<span data-ttu-id="78a44-180">.NET Framework 已是一个非常安全的框架。</span><span class="sxs-lookup"><span data-stu-id="78a44-180">.NET Framework is already a quite secure framework.</span></span> <span data-ttu-id="78a44-181">它避免了某些非托管代码的缺陷，如遍历数组的结尾。</span><span class="sxs-lookup"><span data-stu-id="78a44-181">It avoids some of the pitfalls of unmanaged code, such as walking off the ends of arrays.</span></span> <span data-ttu-id="78a44-182">工作正在进行，以便在发现安全漏洞时进行修复。</span><span class="sxs-lookup"><span data-stu-id="78a44-182">Work is actively done to fix security holes as they're discovered.</span></span> <span data-ttu-id="78a44-183">甚至还有一个[bug 奖励程序](https://www.microsoft.com/msrc/bounty)，它可以向研究人员提供框架中的问题并进行报告，而不是利用这些问题。</span><span class="sxs-lookup"><span data-stu-id="78a44-183">There's even a [bug bounty program](https://www.microsoft.com/msrc/bounty) that pays researchers to find issues in the framework and report them instead of exploiting them.</span></span>

<span data-ttu-id="78a44-184">有多种方法可以使 .NET 代码更安全。</span><span class="sxs-lookup"><span data-stu-id="78a44-184">There are many ways to make .NET code more secure.</span></span> <span data-ttu-id="78a44-185">遵循适用于 .NET 的[安全编码准则](https://docs.microsoft.com/dotnet/standard/security/secure-coding-guidelines)这类准则是确保代码完全安全的合理步骤。</span><span class="sxs-lookup"><span data-stu-id="78a44-185">Following guidelines such as the [Secure coding guidelines for .NET](https://docs.microsoft.com/dotnet/standard/security/secure-coding-guidelines) article is a reasonable step to take to ensure that the code is secure from the ground up.</span></span> <span data-ttu-id="78a44-186">[OWASP top 10](https://owasp.org/www-project-top-ten/)是另一个可用于构建安全代码的重要指南。</span><span class="sxs-lookup"><span data-stu-id="78a44-186">The [OWASP top 10](https://owasp.org/www-project-top-ten/) is another invaluable guide to build secure code.</span></span>

<span data-ttu-id="78a44-187">在生成过程中，可以使用生成过程来检测源代码中的问题，然后再将其投入生产。</span><span class="sxs-lookup"><span data-stu-id="78a44-187">The build process is a good place to put scanning tools to detect problems in source code before they make it into production.</span></span> <span data-ttu-id="78a44-188">大多数项目都具有其他某些包的依赖关系。</span><span class="sxs-lookup"><span data-stu-id="78a44-188">Most every project has dependencies on some other packages.</span></span> <span data-ttu-id="78a44-189">可以扫描过期包的工具将会在夜间生成中捕获问题。</span><span class="sxs-lookup"><span data-stu-id="78a44-189">A tool that can scan for outdated packages will catch problems in a nightly build.</span></span> <span data-ttu-id="78a44-190">即使在构建 Docker 映像时，检查并确保基本映像没有已知的漏洞也是非常有用的。</span><span class="sxs-lookup"><span data-stu-id="78a44-190">Even when building Docker images, it's useful to check and make sure that the base image doesn't have known vulnerabilities.</span></span> <span data-ttu-id="78a44-191">要检查的另一件事是没有人无意中签入凭据。</span><span class="sxs-lookup"><span data-stu-id="78a44-191">Another thing to check is that nobody has accidentally checked in credentials.</span></span>

## <a name="built-in-security"></a><span data-ttu-id="78a44-192">内置安全性</span><span class="sxs-lookup"><span data-stu-id="78a44-192">Built-in security</span></span>

<span data-ttu-id="78a44-193">Azure 旨在平衡大多数用户的可用性和安全性。</span><span class="sxs-lookup"><span data-stu-id="78a44-193">Azure is designed to balance usability and security for the majority of users.</span></span> <span data-ttu-id="78a44-194">不同的用户会有不同的安全要求，因此他们需要对云安全方法进行微调。</span><span class="sxs-lookup"><span data-stu-id="78a44-194">Different users are going to have different security requirements, so they need to fine-tune their approach to cloud security.</span></span> <span data-ttu-id="78a44-195">Microsoft 在[信任中心](https://azure.microsoft.com/support/trust-center/)发布了大量安全信息。</span><span class="sxs-lookup"><span data-stu-id="78a44-195">Microsoft publishes a great deal of security information in the [Trust Center](https://azure.microsoft.com/support/trust-center/).</span></span> <span data-ttu-id="78a44-196">对于那些想要了解内置攻击缓解技术如何工作的专业人员，此资源应是第一站。</span><span class="sxs-lookup"><span data-stu-id="78a44-196">This resource should be the first stop for those professionals interested in understanding how the built-in attack mitigation technologies work.</span></span>

<span data-ttu-id="78a44-197">在 Azure 门户中， [Azure 顾问](https://azure.microsoft.com/services/advisor/)是一种持续扫描环境并提出建议的系统。</span><span class="sxs-lookup"><span data-stu-id="78a44-197">Within the Azure portal, the [Azure Advisor](https://azure.microsoft.com/services/advisor/) is a system that is constantly scanning an environment and making recommendations.</span></span> <span data-ttu-id="78a44-198">其中的某些建议旨在节省用户资金，但其他建议用于标识可能不安全的配置，例如，将存储容器打开到世界，不受虚拟网络保护。</span><span class="sxs-lookup"><span data-stu-id="78a44-198">Some of these recommendations are designed to save users money, but others are designed to identify potentially insecure configurations, such as having a storage container open to the world and not protected by a Virtual Network.</span></span>

## <a name="azure-network-infrastructure"></a><span data-ttu-id="78a44-199">Azure 网络基础结构</span><span class="sxs-lookup"><span data-stu-id="78a44-199">Azure network infrastructure</span></span>

<span data-ttu-id="78a44-200">在本地部署环境中，大量能源专用于设置网络。</span><span class="sxs-lookup"><span data-stu-id="78a44-200">In an on-premises deployment environment, a great deal of energy is dedicated to setting up networking.</span></span> <span data-ttu-id="78a44-201">设置路由器、交换机和这样的工作非常复杂。</span><span class="sxs-lookup"><span data-stu-id="78a44-201">Setting up routers, switches, and the such is complicated work.</span></span> <span data-ttu-id="78a44-202">网络允许某些资源与其他资源通信，并在某些情况下防止访问。</span><span class="sxs-lookup"><span data-stu-id="78a44-202">Networks allow certain resources to talk to other resources and prevent access in some cases.</span></span> <span data-ttu-id="78a44-203">经常的网络规则是从开发环境限制对生产环境的访问，而这种情况可能是由一半开发的代码发现运行并删除了大量的数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-203">A frequent network rule is to restrict access to the production environment from the development environment on the off chance that a half-developed piece of code runs awry and deletes a swath of data.</span></span>

<span data-ttu-id="78a44-204">在现成的情况下，大多数 PaaS Azure 资源仅具有最基本和最宽松的网络设置。</span><span class="sxs-lookup"><span data-stu-id="78a44-204">Out of the box, most PaaS Azure resources have only the most basic and permissive networking setup.</span></span> <span data-ttu-id="78a44-205">例如，Internet 上的任何人都可以访问应用服务。</span><span class="sxs-lookup"><span data-stu-id="78a44-205">For instance, anybody on the Internet can access an app service.</span></span> <span data-ttu-id="78a44-206">新的 SQL Server 实例通常会受到限制，因此外部方不能访问它们，但允许 Azure 本身使用的 IP 地址范围。</span><span class="sxs-lookup"><span data-stu-id="78a44-206">New SQL Server instances typically come restricted, so that external parties can't access them, but the IP address ranges used by Azure itself are permitted through.</span></span> <span data-ttu-id="78a44-207">因此，虽然 SQL server 受到外部威胁的保护，但攻击者只需设置一个 Azure 桥头，就可以在其中对 Azure 上的所有 SQL 实例发起攻击。</span><span class="sxs-lookup"><span data-stu-id="78a44-207">So, while the SQL server is protected from external threats, an attacker only needs to set up an Azure bridgehead from where they can launch attacks against all SQL instances on Azure.</span></span>

<span data-ttu-id="78a44-208">幸运的是，大多数 Azure 资源都可以放入允许更精细的访问控制的 Azure 虚拟网络中。</span><span class="sxs-lookup"><span data-stu-id="78a44-208">Fortunately, most Azure resources can be placed into an Azure Virtual Network that allows finer grained access control.</span></span> <span data-ttu-id="78a44-209">与本地网络建立广泛保护的专用网络的方式类似，虚拟网络是位于 Azure 网络内的专用 IP 地址孤岛。</span><span class="sxs-lookup"><span data-stu-id="78a44-209">Similar to the way that on-premises networks establish private networks that are protected from the wider world, virtual networks are islands of private IP addresses that are located within the Azure network.</span></span>

![图 9-1 Azure 中的虚拟网络](./media/virtual-network.png)

<span data-ttu-id="78a44-211">**图 9-1**。</span><span class="sxs-lookup"><span data-stu-id="78a44-211">**Figure 9-1**.</span></span> <span data-ttu-id="78a44-212">Azure 中的虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="78a44-212">A virtual network in Azure.</span></span>

<span data-ttu-id="78a44-213">与本地网络具有管理网络访问权限的方式一样，你可以在虚拟网络的边界建立类似的防火墙。</span><span class="sxs-lookup"><span data-stu-id="78a44-213">In the same way that on-premises networks have a firewall governing access to the network, you can establish a similar firewall at the boundary of the virtual network.</span></span> <span data-ttu-id="78a44-214">默认情况下，虚拟网络中的所有资源仍可以与 Internet 通信。</span><span class="sxs-lookup"><span data-stu-id="78a44-214">By default, all the resources on a virtual network can still talk to the Internet.</span></span> <span data-ttu-id="78a44-215">它只是需要某种形式的显式防火墙例外的传入连接。</span><span class="sxs-lookup"><span data-stu-id="78a44-215">It's only incoming connections that require some form of explicit firewall exception.</span></span>

<span data-ttu-id="78a44-216">建立网络后，可以将存储帐户等内部资源设置为仅允许虚拟网络中的资源访问。</span><span class="sxs-lookup"><span data-stu-id="78a44-216">With the network established, internal resources like storage accounts can be set up to only allow for access by resources that are also on the Virtual Network.</span></span> <span data-ttu-id="78a44-217">此防火墙提供额外的安全级别，如果该存储帐户的密钥泄漏，攻击者将无法连接到该存储帐户以利用泄露的密钥。</span><span class="sxs-lookup"><span data-stu-id="78a44-217">This firewall provides an extra level of security, should the keys for that storage account be leaked, attackers wouldn't be able to connect to it to exploit the leaked keys.</span></span> <span data-ttu-id="78a44-218">这是最低权限原则的另一个示例。</span><span class="sxs-lookup"><span data-stu-id="78a44-218">This is another example of the principle of least privilege.</span></span>

<span data-ttu-id="78a44-219">Azure Kubernetes 群集中的节点可以加入虚拟网络，就像其他更适用于 Azure 的资源一样。</span><span class="sxs-lookup"><span data-stu-id="78a44-219">The nodes in an Azure Kubernetes cluster can participate in a virtual network just like other resources that are more native to Azure.</span></span> <span data-ttu-id="78a44-220">此功能称为[Azure 容器网络接口](https://github.com/Azure/azure-container-networking/blob/master/docs/cni.md)。</span><span class="sxs-lookup"><span data-stu-id="78a44-220">This functionality is called [Azure Container Networking Interface](https://github.com/Azure/azure-container-networking/blob/master/docs/cni.md).</span></span> <span data-ttu-id="78a44-221">实际上，它会在虚拟网络中分配虚拟机和容器映像的子网。</span><span class="sxs-lookup"><span data-stu-id="78a44-221">In effect, it allocates a subnet within the virtual network on which virtual machines and container images are allocated.</span></span>

<span data-ttu-id="78a44-222">继续说明最小特权原则，而不是虚拟网络中的每个资源都需要与其他每个资源进行通信。</span><span class="sxs-lookup"><span data-stu-id="78a44-222">Continuing down the path of illustrating the principle of least privilege, not every resource within a Virtual Network needs to talk to every other resource.</span></span> <span data-ttu-id="78a44-223">例如，在通过存储帐户和 SQL 数据库提供 web API 的应用程序中，数据库和存储帐户不太可能需要彼此通信。</span><span class="sxs-lookup"><span data-stu-id="78a44-223">For instance, in an application that provides a web API over a storage account and a SQL database, it's unlikely that the database and the storage account need to talk to one another.</span></span> <span data-ttu-id="78a44-224">它们之间共享的任何数据都将通过 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="78a44-224">Any data sharing between them would go through the web application.</span></span> <span data-ttu-id="78a44-225">因此，可以使用[网络安全组（NSG）](https://docs.microsoft.com/azure/virtual-network/security-overview)拒绝这两个服务之间的流量。</span><span class="sxs-lookup"><span data-stu-id="78a44-225">So, a [network security group (NSG)](https://docs.microsoft.com/azure/virtual-network/security-overview) could be used to deny traffic between the two services.</span></span>

<span data-ttu-id="78a44-226">拒绝资源之间的通信的策略可能会令人讨厌，尤其是从使用 Azure 的后台，而不受流量限制。</span><span class="sxs-lookup"><span data-stu-id="78a44-226">A policy of denying communication between resources can be annoying to implement, especially coming from a background of using Azure without traffic restrictions.</span></span> <span data-ttu-id="78a44-227">在其他云上，网络安全组的概念更为普遍。</span><span class="sxs-lookup"><span data-stu-id="78a44-227">On some other clouds, the concept of network security groups is much more prevalent.</span></span> <span data-ttu-id="78a44-228">例如，AWS 上的默认策略是在由 NSG 中的规则启用之前，资源不能相互通信。</span><span class="sxs-lookup"><span data-stu-id="78a44-228">For instance, the default policy on AWS is that resources can't communicate among themselves until enabled by rules in an NSG.</span></span> <span data-ttu-id="78a44-229">虽然开发的速度较慢，但更严格的环境却提供了更安全的默认值。</span><span class="sxs-lookup"><span data-stu-id="78a44-229">While slower to develop this, more restrictive environment provides a more secure default.</span></span> <span data-ttu-id="78a44-230">使用适当的 DevOps 做法，尤其是使用[Azure 资源管理器或 Terraform](infrastructure-as-code.md)管理权限时，可以更轻松地控制规则。</span><span class="sxs-lookup"><span data-stu-id="78a44-230">Making use of proper DevOps practices, especially using [Azure Resource Manager or Terraform](infrastructure-as-code.md) to manage permissions can make controlling the rules easier.</span></span>

<span data-ttu-id="78a44-231">设置本地资源与云资源之间的通信时，虚拟网络也非常有用。</span><span class="sxs-lookup"><span data-stu-id="78a44-231">Virtual Networks can also be useful when setting up communication between on-premises and cloud resources.</span></span> <span data-ttu-id="78a44-232">虚拟专用网络可用于无缝地将两个网络连接在一起。</span><span class="sxs-lookup"><span data-stu-id="78a44-232">A virtual private network can be used to seamlessly attach the two networks together.</span></span> <span data-ttu-id="78a44-233">这允许在所有用户都位于现场的情况下，在没有任何网关的情况下运行虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="78a44-233">This allows running a virtual network without any sort of gateway for scenarios where all the users are on-site.</span></span> <span data-ttu-id="78a44-234">可使用多种技术来建立此网络。</span><span class="sxs-lookup"><span data-stu-id="78a44-234">There are a number of technologies that can be used to establish this network.</span></span> <span data-ttu-id="78a44-235">最简单的是使用可在多个路由器和 Azure 之间建立的[站点到站点 VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%2fazure%2fvirtual-network%2ftoc.json#s2smulti) 。</span><span class="sxs-lookup"><span data-stu-id="78a44-235">The simplest is to use a [site-to-site VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%2fazure%2fvirtual-network%2ftoc.json#s2smulti) that can be established between many routers and Azure.</span></span> <span data-ttu-id="78a44-236">流量通过 Internet 进行加密和隧道连接，其成本与任何其他流量相同。</span><span class="sxs-lookup"><span data-stu-id="78a44-236">Traffic is encrypted and tunneled over the Internet at the same cost per byte as any other traffic.</span></span> <span data-ttu-id="78a44-237">如果需要更多的带宽或更高的安全性，Azure 提供名为[Express Route](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%2fazure%2fvirtual-network%2ftoc.json#ExpressRoute)的服务，该服务使用本地网络和 Azure 之间的专用线路。</span><span class="sxs-lookup"><span data-stu-id="78a44-237">For scenarios where more bandwidth or more security is desirable, Azure offers a service called [Express Route](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways?toc=%2fazure%2fvirtual-network%2ftoc.json#ExpressRoute) that uses a private circuit between an on-premises network and Azure.</span></span> <span data-ttu-id="78a44-238">建立成本更高且难以建立，并且更安全。</span><span class="sxs-lookup"><span data-stu-id="78a44-238">It's more costly and difficult to establish but also more secure.</span></span>

## <a name="role-based-access-control-for-restricting-access-to-azure-resources"></a><span data-ttu-id="78a44-239">基于角色的访问控制，用于限制对 Azure 资源的访问</span><span class="sxs-lookup"><span data-stu-id="78a44-239">Role-based access control for restricting access to Azure resources</span></span>

<span data-ttu-id="78a44-240">RBAC 是向在 Azure 中运行的应用程序提供标识的系统。</span><span class="sxs-lookup"><span data-stu-id="78a44-240">RBAC is a system that provides an identity to applications running in Azure.</span></span> <span data-ttu-id="78a44-241">应用程序可以使用此标识（而不是使用密钥或密码）访问资源。</span><span class="sxs-lookup"><span data-stu-id="78a44-241">Applications can access resources using this identity instead of or in addition to using keys or passwords.</span></span>

## <a name="security-principals"></a><span data-ttu-id="78a44-242">安全主体</span><span class="sxs-lookup"><span data-stu-id="78a44-242">Security Principals</span></span>

<span data-ttu-id="78a44-243">RBAC 中的第一个组件是一个安全主体。</span><span class="sxs-lookup"><span data-stu-id="78a44-243">The first component in RBAC is a security principal.</span></span> <span data-ttu-id="78a44-244">安全主体可以是用户、组、服务主体或托管标识。</span><span class="sxs-lookup"><span data-stu-id="78a44-244">A security principal can be a user, group, service principal, or managed identity.</span></span>

![图9-2 不同类型的安全主体](./media/rbac-security-principal.png)

<span data-ttu-id="78a44-246">**图 9-2**。</span><span class="sxs-lookup"><span data-stu-id="78a44-246">**Figure 9-2**.</span></span> <span data-ttu-id="78a44-247">不同类型的安全主体。</span><span class="sxs-lookup"><span data-stu-id="78a44-247">Different types of security principals.</span></span>

- <span data-ttu-id="78a44-248">用户-在 Azure Active Directory 中拥有帐户的任何用户都是用户。</span><span class="sxs-lookup"><span data-stu-id="78a44-248">User - Any user who has an account in Azure Active Directory is a user.</span></span>
- <span data-ttu-id="78a44-249">组-来自 Azure Active Directory 的用户集合。</span><span class="sxs-lookup"><span data-stu-id="78a44-249">Group - A collection of users from Azure Active Directory.</span></span> <span data-ttu-id="78a44-250">作为组的成员，用户除了自己的角色外，还会承担该组的角色。</span><span class="sxs-lookup"><span data-stu-id="78a44-250">As a member of a group, a user takes on the roles of that group in addition to their own.</span></span>
- <span data-ttu-id="78a44-251">服务主体-在其下运行服务或应用程序的安全标识。</span><span class="sxs-lookup"><span data-stu-id="78a44-251">Service principal - A security identity under which services or applications run.</span></span>
- <span data-ttu-id="78a44-252">托管标识-由 Azure 管理的 Azure Active Directory 标识。</span><span class="sxs-lookup"><span data-stu-id="78a44-252">Managed identity - An Azure Active Directory identity managed by Azure.</span></span> <span data-ttu-id="78a44-253">托管标识通常在开发云应用程序时使用，这些应用程序管理用于对 Azure 服务进行身份验证的凭据。</span><span class="sxs-lookup"><span data-stu-id="78a44-253">Managed identities are typically used when developing cloud applications that manage the credentials for authenticating to Azure services.</span></span>

<span data-ttu-id="78a44-254">安全主体可以应用于大多数资源。</span><span class="sxs-lookup"><span data-stu-id="78a44-254">The security principal can be applied to most any resource.</span></span> <span data-ttu-id="78a44-255">这意味着，可以将安全主体分配给在 Azure Kubernetes 中运行的容器，使其能够访问存储在 Key Vault 中的机密。</span><span class="sxs-lookup"><span data-stu-id="78a44-255">This means that it's possible to assign a security principal to a container running within Azure Kubernetes, allowing it to access secrets stored in Key Vault.</span></span> <span data-ttu-id="78a44-256">Azure Function 可以获取权限，使其能够与 Active Directory 实例通信，以验证调用用户的 JWT。</span><span class="sxs-lookup"><span data-stu-id="78a44-256">An Azure Function could take on a permission allowing it to talk to an Active Directory instance to validate a JWT for a calling user.</span></span> <span data-ttu-id="78a44-257">启用服务主体的服务后，即可使用角色和作用域对其权限进行粒度管理。</span><span class="sxs-lookup"><span data-stu-id="78a44-257">Once services are enabled with a service principal, their permissions can be managed granularly using roles and scopes.</span></span>

## <a name="roles"></a><span data-ttu-id="78a44-258">角色</span><span class="sxs-lookup"><span data-stu-id="78a44-258">Roles</span></span>

<span data-ttu-id="78a44-259">安全主体可以使用多个角色，或者使用更 sartorial 的类比，这是许多头衔。</span><span class="sxs-lookup"><span data-stu-id="78a44-259">A security principal can take on many roles or, using a more sartorial analogy, wear many hats.</span></span> <span data-ttu-id="78a44-260">每个角色定义一系列权限，如 "从 Azure 服务总线终结点读取消息"。</span><span class="sxs-lookup"><span data-stu-id="78a44-260">Each role defines a series of permissions such as "Read messages from Azure Service Bus endpoint".</span></span> <span data-ttu-id="78a44-261">安全主体的有效权限集是分配给安全主体所具有的所有角色的所有权限的组合。</span><span class="sxs-lookup"><span data-stu-id="78a44-261">The effective permission set of a security principal is the combination of all the permissions assigned to all the roles that security principal has.</span></span> <span data-ttu-id="78a44-262">Azure 具有大量内置角色，并且用户可以定义自己的角色。</span><span class="sxs-lookup"><span data-stu-id="78a44-262">Azure has a large number of built-in roles and users can define their own roles.</span></span>

![图 9-3 RBAC 角色定义](./media/rbac-role-definition.png)

<span data-ttu-id="78a44-264">**图 9-3**。</span><span class="sxs-lookup"><span data-stu-id="78a44-264">**Figure 9-3**.</span></span> <span data-ttu-id="78a44-265">RBAC 角色定义。</span><span class="sxs-lookup"><span data-stu-id="78a44-265">RBAC role definitions.</span></span>

<span data-ttu-id="78a44-266">内置于 Azure 中也是许多高级角色，如所有者、参与者、读者和用户帐户管理员。</span><span class="sxs-lookup"><span data-stu-id="78a44-266">Built into Azure are also a number of high-level roles such as Owner, Contributor, Reader, and User Account Administrator.</span></span> <span data-ttu-id="78a44-267">使用 "所有者" 角色，安全主体可以访问所有资源，并将权限分配给其他资源。</span><span class="sxs-lookup"><span data-stu-id="78a44-267">With the Owner role, a security principal can access all resources and assign permissions to others.</span></span> <span data-ttu-id="78a44-268">参与者对所有资源具有相同级别的访问权限，但无法分配权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-268">A contributor has the same level of access to all resources but they can't assign permissions.</span></span> <span data-ttu-id="78a44-269">读者只能查看现有的 Azure 资源，用户帐户管理员可以管理对 Azure 资源的访问权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-269">A Reader can only view existing Azure resources and a User Account Administrator can manage access to Azure resources.</span></span>

<span data-ttu-id="78a44-270">更精细的内置角色（如[DNS 区域参与者](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#dns-zone-contributor)）具有限制为单个服务的权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-270">More granular built-in roles such as [DNS Zone Contributor](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#dns-zone-contributor) have rights limited to a single service.</span></span> <span data-ttu-id="78a44-271">安全主体可以拥有任意数量的角色。</span><span class="sxs-lookup"><span data-stu-id="78a44-271">Security principals can take on any number of roles.</span></span>

## <a name="scopes"></a><span data-ttu-id="78a44-272">作用域</span><span class="sxs-lookup"><span data-stu-id="78a44-272">Scopes</span></span>

<span data-ttu-id="78a44-273">可以将角色应用到 Azure 中的一组有限的资源。</span><span class="sxs-lookup"><span data-stu-id="78a44-273">Roles can be applied to a restricted set of resources within Azure.</span></span> <span data-ttu-id="78a44-274">例如，将范围应用到前面从服务总线队列读取的示例时，可以将权限缩小到单个队列： "从 Azure 服务总线终结点读取消息 `blah.servicebus.windows.net/queue1` "</span><span class="sxs-lookup"><span data-stu-id="78a44-274">For instance, applying scope to the previous example of reading from a Service Bus queue, you can narrow the permission to a single queue: "Read messages from Azure Service Bus endpoint `blah.servicebus.windows.net/queue1`"</span></span>

<span data-ttu-id="78a44-275">作用域可以作为单个资源，也可以应用于整个资源组、订阅甚至管理组。</span><span class="sxs-lookup"><span data-stu-id="78a44-275">The scope can be as narrow as a single resource or it can be applied to an entire resource group, subscription, or even management group.</span></span>

<span data-ttu-id="78a44-276">在测试安全主体是否具有特定权限时，会考虑角色和作用域的组合。</span><span class="sxs-lookup"><span data-stu-id="78a44-276">When testing if a security principal has a certain permission, the combination of role and scope are taken into account.</span></span> <span data-ttu-id="78a44-277">这种组合提供了一种强大的授权机制。</span><span class="sxs-lookup"><span data-stu-id="78a44-277">This combination provides a powerful authorization mechanism.</span></span>

## <a name="deny"></a><span data-ttu-id="78a44-278">拒绝</span><span class="sxs-lookup"><span data-stu-id="78a44-278">Deny</span></span>

<span data-ttu-id="78a44-279">以前，RBAC 只允许使用 "允许" 规则。</span><span class="sxs-lookup"><span data-stu-id="78a44-279">Previously, only "allow" rules were permitted for RBAC.</span></span> <span data-ttu-id="78a44-280">此行为使某些范围的生成变得复杂。</span><span class="sxs-lookup"><span data-stu-id="78a44-280">This behavior made some scopes complicated to build.</span></span> <span data-ttu-id="78a44-281">例如，允许安全主体访问所有存储帐户，其中一个权限要求向可能会无穷的存储帐户列表授予显式权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-281">For instance, allowing a security principal access to all storage accounts except one required granting explicit permission to a potentially endless list of storage accounts.</span></span> <span data-ttu-id="78a44-282">每次创建新的存储帐户时，都必须将其添加到此帐户列表中。</span><span class="sxs-lookup"><span data-stu-id="78a44-282">Every time a new storage account was created, it would have to be added to this list of accounts.</span></span> <span data-ttu-id="78a44-283">这就增加了当然不需要的管理开销。</span><span class="sxs-lookup"><span data-stu-id="78a44-283">This added management overhead that certainly wasn't desirable.</span></span>

<span data-ttu-id="78a44-284">拒绝规则优先于允许规则。</span><span class="sxs-lookup"><span data-stu-id="78a44-284">Deny rules take precedence over allow rules.</span></span> <span data-ttu-id="78a44-285">现在表示相同的 "全部允许但不允许一个" 范围表示为两个规则： "全部允许" 和 "拒绝此特定规则"。</span><span class="sxs-lookup"><span data-stu-id="78a44-285">Now representing the same "allow all but one" scope could be represented as two rules "allow all" and "deny this one specific one".</span></span> <span data-ttu-id="78a44-286">拒绝规则不仅便于管理，而且允许通过拒绝对每个人的访问权限来实现额外安全的资源。</span><span class="sxs-lookup"><span data-stu-id="78a44-286">Deny rules not only ease management but allow for resources that are extra secure by denying access to everybody.</span></span>

## <a name="checking-access"></a><span data-ttu-id="78a44-287">检查访问权限</span><span class="sxs-lookup"><span data-stu-id="78a44-287">Checking access</span></span>

<span data-ttu-id="78a44-288">正如您所想象的那样，拥有大量的角色和作用域会使服务主体的有效权限变得非常困难。</span><span class="sxs-lookup"><span data-stu-id="78a44-288">As you can imagine, having a large number of roles and scopes can make figuring out the effective permission of a service principal quite difficult.</span></span> <span data-ttu-id="78a44-289">堆积上的拒绝规则仅用于提高复杂性。</span><span class="sxs-lookup"><span data-stu-id="78a44-289">Piling deny rules on top of that, only serves to increase the complexity.</span></span> <span data-ttu-id="78a44-290">幸运的是，有一个权限计算器可以显示任何服务主体的有效权限。</span><span class="sxs-lookup"><span data-stu-id="78a44-290">Fortunately, there's a permissions calculator that can show the effective permissions for any service principal.</span></span> <span data-ttu-id="78a44-291">它通常位于门户中的 "IAM" 选项卡下，如图10-3 所示。</span><span class="sxs-lookup"><span data-stu-id="78a44-291">It's typically found under the IAM tab in the portal, as shown in Figure 10-3.</span></span>

![图9-4 应用服务的权限计算器](./media/check-rbac.png)

<span data-ttu-id="78a44-293">**图 9-4**。</span><span class="sxs-lookup"><span data-stu-id="78a44-293">**Figure 9-4**.</span></span> <span data-ttu-id="78a44-294">应用服务的权限计算器。</span><span class="sxs-lookup"><span data-stu-id="78a44-294">Permission calculator for an app service.</span></span>

## <a name="securing-secrets"></a><span data-ttu-id="78a44-295">保护机密</span><span class="sxs-lookup"><span data-stu-id="78a44-295">Securing secrets</span></span>

<span data-ttu-id="78a44-296">密码和证书是攻击者的常见攻击媒介。</span><span class="sxs-lookup"><span data-stu-id="78a44-296">Passwords and certificates are a common attack vector for attackers.</span></span> <span data-ttu-id="78a44-297">密码破解硬件可以执行暴力攻击，尝试每秒猜测数十亿密码。</span><span class="sxs-lookup"><span data-stu-id="78a44-297">Password-cracking hardware can do a  brute-force attack and try to guess billions of passwords per second.</span></span> <span data-ttu-id="78a44-298">因此，用于访问资源的密码是强的，其中包含大量字符，这一点很重要。</span><span class="sxs-lookup"><span data-stu-id="78a44-298">So it's important that the passwords that are used to access resources are strong, with a large variety of characters.</span></span> <span data-ttu-id="78a44-299">这些密码与几乎不可能记住的密码种类完全相同。</span><span class="sxs-lookup"><span data-stu-id="78a44-299">These passwords are exactly the kind of passwords that are near impossible to remember.</span></span> <span data-ttu-id="78a44-300">幸运的是，Azure 中的密码实际上不需要由任何人知道。</span><span class="sxs-lookup"><span data-stu-id="78a44-300">Fortunately, the passwords in Azure don't actually need to be known by any human.</span></span>

<span data-ttu-id="78a44-301">许多安全[专家建议](https://www.troyhunt.com/password-managers-dont-have-to-be-perfect-they-just-have-to-be-better-than-not-having-one/)使用密码管理器来保留自己的密码，这是最佳方法。</span><span class="sxs-lookup"><span data-stu-id="78a44-301">Many security [experts suggest](https://www.troyhunt.com/password-managers-dont-have-to-be-perfect-they-just-have-to-be-better-than-not-having-one/) that using a password manager to keep your own passwords is the best approach.</span></span> <span data-ttu-id="78a44-302">尽管它在一个位置集中了密码，但它还允许使用非常复杂的密码，并确保它们对于每个帐户都是唯一的。</span><span class="sxs-lookup"><span data-stu-id="78a44-302">While it centralizes your passwords in one location, it also allows using highly complex passwords and ensuring they're unique for each account.</span></span> <span data-ttu-id="78a44-303">Azure 中存在相同的系统：机密的中心存储。</span><span class="sxs-lookup"><span data-stu-id="78a44-303">The same system exists within Azure: a central store for secrets.</span></span>

## <a name="azure-key-vault"></a><span data-ttu-id="78a44-304">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="78a44-304">Azure Key Vault</span></span>

<span data-ttu-id="78a44-305">Azure Key Vault 提供了一个集中位置，用于存储数据库、API 密钥和证书等东西的密码。</span><span class="sxs-lookup"><span data-stu-id="78a44-305">Azure Key Vault provides a centralized location to store passwords for things such as databases, API keys, and certificates.</span></span> <span data-ttu-id="78a44-306">在保管库中输入了机密后，就不会再次显示该密码，并且有意复杂的命令。</span><span class="sxs-lookup"><span data-stu-id="78a44-306">Once a secret is entered into the Vault, it's never shown again and the commands to extract and view it are purposefully complicated.</span></span> <span data-ttu-id="78a44-307">使用软件加密或 FIPS 140-2 第2级验证的硬件安全模块保护安全的信息。</span><span class="sxs-lookup"><span data-stu-id="78a44-307">The information in the safe is protected using either software encryption or FIPS 140-2 Level 2 validated Hardware Security Modules.</span></span>

<span data-ttu-id="78a44-308">通过 RBACs 提供对密钥保管库的访问权限，这意味着不只是任何用户都可以访问保管库中的信息。</span><span class="sxs-lookup"><span data-stu-id="78a44-308">Access to the key vault is provided through RBACs, meaning that not just any user can access the information in the vault.</span></span> <span data-ttu-id="78a44-309">假设 web 应用程序希望访问存储在 Azure Key Vault 中的数据库连接字符串。</span><span class="sxs-lookup"><span data-stu-id="78a44-309">Say a web application wishes to access the database connection string stored in Azure Key Vault.</span></span> <span data-ttu-id="78a44-310">若要获取访问权限，应用程序需要使用服务主体运行。</span><span class="sxs-lookup"><span data-stu-id="78a44-310">To gain access, applications need to run using a service principal.</span></span> <span data-ttu-id="78a44-311">在此假定的角色下，他们可以从 safe 中读取机密。</span><span class="sxs-lookup"><span data-stu-id="78a44-311">Under this assumed role, they can read the secrets from the safe.</span></span> <span data-ttu-id="78a44-312">有许多不同的安全设置可以进一步限制应用程序对保管库的访问权限，使其不能更新机密，而只读取它们。</span><span class="sxs-lookup"><span data-stu-id="78a44-312">There are a number of different security settings that can further limit the access that an application has to the vault, so that it can't update secrets but only read them.</span></span>

<span data-ttu-id="78a44-313">可以监视对密钥保管库的访问，以确保只有预期的应用程序访问保管库。</span><span class="sxs-lookup"><span data-stu-id="78a44-313">Access to the key vault can be monitored to ensure that only the expected applications are accessing the vault.</span></span> <span data-ttu-id="78a44-314">日志可以集成回 Azure Monitor，从而在遇到意外情况时解锁设置警报的功能。</span><span class="sxs-lookup"><span data-stu-id="78a44-314">The logs can be integrated back into Azure Monitor, unlocking the ability to set up alerts when unexpected conditions are encountered.</span></span>

## <a name="kubernetes"></a><span data-ttu-id="78a44-315">Kubernetes</span><span class="sxs-lookup"><span data-stu-id="78a44-315">Kubernetes</span></span>

<span data-ttu-id="78a44-316">在 Kubernetes 中，有一个类似的服务，用于维护少量的机密信息。</span><span class="sxs-lookup"><span data-stu-id="78a44-316">Within Kubernetes, there's a similar service for maintaining small pieces of secret information.</span></span> <span data-ttu-id="78a44-317">可以通过典型的 `kubectl` 可执行文件设置 Kubernetes 机密。</span><span class="sxs-lookup"><span data-stu-id="78a44-317">Kubernetes Secrets can be set via the typical `kubectl` executable.</span></span>

<span data-ttu-id="78a44-318">创建机密非常简单，只需要查找要存储的值的 base64 版本即可：</span><span class="sxs-lookup"><span data-stu-id="78a44-318">Creating a secret is as simple as finding the base64 version of the values to be stored:</span></span>

```console
echo -n 'admin' | base64
YWRtaW4=
echo -n '1f2d1e2e67df' | base64
MWYyZDFlMmU2N2Rm
```

<span data-ttu-id="78a44-319">然后，将其添加到名 `secret.yml` 为的机密文件中，如以下示例中所示：</span><span class="sxs-lookup"><span data-stu-id="78a44-319">Then adding it to a secrets file named `secret.yml` for example that looks similar to the following example:</span></span>

```yml
apiVersion: v1
kind: Secret
metadata:
  name: mysecret
type: Opaque
data:
  username: YWRtaW4=
  password: MWYyZDFlMmU2N2Rm
```

<span data-ttu-id="78a44-320">最后，可以通过运行以下命令将此文件加载到 Kubernetes 中：</span><span class="sxs-lookup"><span data-stu-id="78a44-320">Finally, this file can be loaded into Kubernetes by running the following command:</span></span>

```console
kubectl apply -f ./secret.yaml
```

<span data-ttu-id="78a44-321">然后，可以将这些机密装载到卷中，或通过环境变量向容器进程公开。</span><span class="sxs-lookup"><span data-stu-id="78a44-321">These secrets can then be mounted into volumes or exposed to container processes through environment variables.</span></span> <span data-ttu-id="78a44-322">用于生成应用程序的[十二因素应用](https://12factor.net/)程序建议使用最低的公共分母将设置传输到应用程序。</span><span class="sxs-lookup"><span data-stu-id="78a44-322">The [Twelve-factor app](https://12factor.net/) approach to building applications suggests using the lowest common denominator to transmit settings to an application.</span></span> <span data-ttu-id="78a44-323">环境变量是最小的常用分母，因为无论操作系统或应用程序是什么，它们都是受支持的。</span><span class="sxs-lookup"><span data-stu-id="78a44-323">Environment variables are the lowest common denominator, because they're supported no matter the operating system or application.</span></span>

<span data-ttu-id="78a44-324">使用内置 Kubernetes 机密的替代方法是从 Kubernetes 内访问 Azure Key Vault 中的机密。</span><span class="sxs-lookup"><span data-stu-id="78a44-324">An alternative to use the built-in Kubernetes secrets is to access the secrets in Azure Key Vault from within Kubernetes.</span></span> <span data-ttu-id="78a44-325">要执行此操作，最简单的方法是将 RBAC 角色分配给想要加载机密的容器。</span><span class="sxs-lookup"><span data-stu-id="78a44-325">The simplest way to do this is to assign an RBAC role to the container looking to load secrets.</span></span> <span data-ttu-id="78a44-326">然后，应用程序可以使用 Azure Key Vault Api 来访问机密。</span><span class="sxs-lookup"><span data-stu-id="78a44-326">The application can then use the Azure Key Vault APIs to access the secrets.</span></span> <span data-ttu-id="78a44-327">但是，这种方法需要修改代码，而不是使用环境变量的模式。</span><span class="sxs-lookup"><span data-stu-id="78a44-327">However, this approach requires modifications to the code and doesn't follow the pattern of using environment variables.</span></span> <span data-ttu-id="78a44-328">相反，可以通过使用[Azure Key Vault 注入器](https://mrdevops.io/introducing-azure-key-vault-to-kubernetes-931f82364354)将值注入到容器中。</span><span class="sxs-lookup"><span data-stu-id="78a44-328">Instead, it's possible to inject values into a container through the use of the [Azure Key Vault Injector](https://mrdevops.io/introducing-azure-key-vault-to-kubernetes-931f82364354).</span></span> <span data-ttu-id="78a44-329">此方法实际上比使用 Kubernetes 机密更为安全，因为它们可由群集上的用户进行访问。</span><span class="sxs-lookup"><span data-stu-id="78a44-329">This approach is actually more secure than using the Kubernetes secrets directly, as they can be accessed by users on the cluster.</span></span>

## <a name="encryption-in-transit-and-at-rest"></a><span data-ttu-id="78a44-330">传输和静态加密</span><span class="sxs-lookup"><span data-stu-id="78a44-330">Encryption in transit and at rest</span></span>

<span data-ttu-id="78a44-331">不管数据是在磁盘上还是在不同服务之间传输，都必须确保数据安全。</span><span class="sxs-lookup"><span data-stu-id="78a44-331">Keeping data safe is important whether it's on disk or transiting between various different services.</span></span> <span data-ttu-id="78a44-332">要防止数据泄露，最有效的方法是将其加密为其他人无法轻易读取的格式。</span><span class="sxs-lookup"><span data-stu-id="78a44-332">The most effective way to keep data from leaking is to encrypt it into a format that can't be easily read by others.</span></span> <span data-ttu-id="78a44-333">Azure 支持各种加密选项。</span><span class="sxs-lookup"><span data-stu-id="78a44-333">Azure supports a wide range of encryption options.</span></span>

### <a name="in-transit"></a><span data-ttu-id="78a44-334">传输中</span><span class="sxs-lookup"><span data-stu-id="78a44-334">In transit</span></span>

<span data-ttu-id="78a44-335">可以通过多种方式在 Azure 中的网络上加密流量。</span><span class="sxs-lookup"><span data-stu-id="78a44-335">There are several ways to encrypt traffic on the network in Azure.</span></span> <span data-ttu-id="78a44-336">通常通过使用传输层安全性（TLS）的连接来访问 Azure 服务。</span><span class="sxs-lookup"><span data-stu-id="78a44-336">The access to Azure services is typically done over connections that use Transport Layer Security (TLS).</span></span> <span data-ttu-id="78a44-337">例如，与 Azure Api 建立的所有连接都需要 TLS 连接。</span><span class="sxs-lookup"><span data-stu-id="78a44-337">For instance, all the connections to the Azure APIs require TLS connections.</span></span> <span data-ttu-id="78a44-338">同样，与 Azure 存储空间中的终结点的连接可以限制为仅使用 TLS 加密的连接。</span><span class="sxs-lookup"><span data-stu-id="78a44-338">Equally, connections to endpoints in Azure storage can be restricted to work only over TLS encrypted connections.</span></span>

<span data-ttu-id="78a44-339">TLS 是一种复杂的协议，只是知道连接使用 TLS 并不能确保安全性。</span><span class="sxs-lookup"><span data-stu-id="78a44-339">TLS is a complicated protocol and simply knowing that the connection is using TLS isn't sufficient to ensure security.</span></span> <span data-ttu-id="78a44-340">例如，TLS 1.0 是长期的不安全的，TLS 1.1 并不是更好。</span><span class="sxs-lookup"><span data-stu-id="78a44-340">For instance, TLS 1.0 is chronically insecure, and TLS 1.1 isn't much better.</span></span> <span data-ttu-id="78a44-341">即使在 TLS 的版本中，也可以通过各种设置来更轻松地对连接进行解密。</span><span class="sxs-lookup"><span data-stu-id="78a44-341">Even within the versions of TLS, there are various settings that can make the connections easier to decrypt.</span></span> <span data-ttu-id="78a44-342">最佳的操作过程是检查服务器连接是否正在使用最新且配置良好的协议。</span><span class="sxs-lookup"><span data-stu-id="78a44-342">The best course of action is to check and see if the server connection is using up-to-date and well configured protocols.</span></span>

<span data-ttu-id="78a44-343">此检查可通过外部服务完成，如 SSL 实验室的 SSL 服务器测试。</span><span class="sxs-lookup"><span data-stu-id="78a44-343">This check can be done by an external service such as SSL labs' SSL Server Test.</span></span> <span data-ttu-id="78a44-344">针对典型 Azure 终结点（在这种情况下为服务总线终结点）的测试运行将生成接近完美分数。</span><span class="sxs-lookup"><span data-stu-id="78a44-344">A test run against a typical Azure endpoint, in this case a service bus endpoint, yields a near perfect score of A.</span></span>

<span data-ttu-id="78a44-345">甚至是 Azure SQL 数据库之类的服务都使用 TLS 加密来使数据保持隐藏状态。</span><span class="sxs-lookup"><span data-stu-id="78a44-345">Even services like Azure SQL databases use TLS encryption to keep data hidden.</span></span> <span data-ttu-id="78a44-346">有关使用 TLS 对传输中的数据进行加密的有趣的部分是，即使 Microsoft 不能在运行 TLS 的计算机之间进行连接。</span><span class="sxs-lookup"><span data-stu-id="78a44-346">The interesting part about encrypting the data in transit using TLS is that it isn't possible, even for Microsoft, to listen in on the connection between computers running TLS.</span></span> <span data-ttu-id="78a44-347">这应该为关心以下问题的公司提供便利：他们的数据可能会受到 Microsoft 适当的威胁，甚至与标准攻击者相比，甚至具有更多资源的状态。</span><span class="sxs-lookup"><span data-stu-id="78a44-347">This should provide comfort for companies concerned that their data may be at risk from Microsoft proper or even a state actor with more resources than the standard attacker.</span></span>

![图 9-5 "SSL 实验室" 报表显示了服务总线终结点的分数。](./media/ssl-report.png)

<span data-ttu-id="78a44-349">**图 9-5**。</span><span class="sxs-lookup"><span data-stu-id="78a44-349">**Figure 9-5**.</span></span> <span data-ttu-id="78a44-350">显示服务总线终结点的分数的 SSL 实验室报表。</span><span class="sxs-lookup"><span data-stu-id="78a44-350">SSL labs report showing a score of A for a Service Bus endpoint.</span></span>

<span data-ttu-id="78a44-351">虽然这一级别的加密并不能满足所有时间的要求，但它也会让你相信 Azure TLS 连接相当安全。</span><span class="sxs-lookup"><span data-stu-id="78a44-351">While this level of encryption isn't going to be sufficient for all time, it should inspire confidence that Azure TLS connections are quite secure.</span></span> <span data-ttu-id="78a44-352">随着加密的提高，Azure 将继续发展其安全标准。</span><span class="sxs-lookup"><span data-stu-id="78a44-352">Azure will continue to evolve its security standards as encryption improves.</span></span> <span data-ttu-id="78a44-353">很好的一点是，在监视安全标准并更新 Azure 时，这是个很好的方法。</span><span class="sxs-lookup"><span data-stu-id="78a44-353">It's nice to know that there's somebody watching the security standards and updating Azure as they improve.</span></span>

### <a name="at-rest"></a><span data-ttu-id="78a44-354">静态</span><span class="sxs-lookup"><span data-stu-id="78a44-354">At rest</span></span>

<span data-ttu-id="78a44-355">在任何应用程序中，数据放置在磁盘上的位置很多。</span><span class="sxs-lookup"><span data-stu-id="78a44-355">In any application, there are a number of places where data rests on disk.</span></span> <span data-ttu-id="78a44-356">应用程序代码本身从某种存储机制加载。</span><span class="sxs-lookup"><span data-stu-id="78a44-356">The application code itself is loaded from some storage mechanism.</span></span> <span data-ttu-id="78a44-357">大多数应用程序还使用某种类型的数据库，例如 SQL Server、Cosmos DB 甚至极为经济高效的表存储。</span><span class="sxs-lookup"><span data-stu-id="78a44-357">Most applications also use some kind of database such as SQL Server, Cosmos DB, or even the amazingly price-efficient Table Storage.</span></span> <span data-ttu-id="78a44-358">这些数据库都使用加密过大的存储，以确保没有任何具有适当权限的应用程序可以读取数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-358">These databases all use heavily encrypted storage to ensure that nobody other than the applications with proper permissions can read your data.</span></span> <span data-ttu-id="78a44-359">即使系统操作员也不能读取已加密的数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-359">Even the system operators can't read data that has been encrypted.</span></span> <span data-ttu-id="78a44-360">因此，客户可以放心地保密信息。</span><span class="sxs-lookup"><span data-stu-id="78a44-360">So customers can remain confident their secret information remains secret.</span></span>

### <a name="storage"></a><span data-ttu-id="78a44-361">存储</span><span class="sxs-lookup"><span data-stu-id="78a44-361">Storage</span></span>

<span data-ttu-id="78a44-362">大多数 Azure 的基础是 Azure 存储引擎。</span><span class="sxs-lookup"><span data-stu-id="78a44-362">The underpinning of much of Azure is the Azure Storage engine.</span></span> <span data-ttu-id="78a44-363">虚拟机磁盘装载在 Azure 存储的顶层。</span><span class="sxs-lookup"><span data-stu-id="78a44-363">Virtual machine disks are mounted on top of Azure Storage.</span></span> <span data-ttu-id="78a44-364">Azure Kubernetes 服务在其自身托管于 Azure 存储上的虚拟机上运行。</span><span class="sxs-lookup"><span data-stu-id="78a44-364">Azure Kubernetes Services run on virtual machines that, themselves, are hosted on Azure Storage.</span></span> <span data-ttu-id="78a44-365">即使是无服务器技术（例如 Azure Functions 应用和 Azure 容器实例），也不是 Azure 存储中的一部分磁盘。</span><span class="sxs-lookup"><span data-stu-id="78a44-365">Even serverless technologies, such as Azure Functions Apps and Azure Container Instances, run out of disk that is part of Azure Storage.</span></span>

<span data-ttu-id="78a44-366">如果 Azure 存储已进行了很好的加密，则它为其他所有其他内容提供了一个基础。</span><span class="sxs-lookup"><span data-stu-id="78a44-366">If Azure Storage is well encrypted, then it provides for a foundation for most everything else to also be encrypted.</span></span> <span data-ttu-id="78a44-367">Azure 存储是通过符合[FIPS 140-2](https://en.wikipedia.org/wiki/FIPS_140)的[256 位 AES](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)[进行加密](https://docs.microsoft.com/azure/storage/common/storage-service-encryption)的。</span><span class="sxs-lookup"><span data-stu-id="78a44-367">Azure Storage [is encrypted](https://docs.microsoft.com/azure/storage/common/storage-service-encryption) with [FIPS 140-2](https://en.wikipedia.org/wiki/FIPS_140) compliant [256-bit AES](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard).</span></span> <span data-ttu-id="78a44-368">这是一种很好的加密技术，在过去的20年或几年中，我们一直在进行丰富的学术审查。</span><span class="sxs-lookup"><span data-stu-id="78a44-368">This is a well-regarded encryption technology having been the subject of extensive academic scrutiny over the last 20 or so years.</span></span> <span data-ttu-id="78a44-369">目前，没有任何已知的实际攻击会使不知道密钥的人了解通过 AES 加密的数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-369">At present, there's no known practical attack that would allow someone without knowledge of the key to read data encrypted by AES.</span></span>

<span data-ttu-id="78a44-370">默认情况下，用于加密 Azure 存储的密钥由 Microsoft 管理。</span><span class="sxs-lookup"><span data-stu-id="78a44-370">By default, the keys used for encrypting Azure Storage are managed by Microsoft.</span></span> <span data-ttu-id="78a44-371">提供了广泛的保护措施，以确保防止恶意访问这些密钥。</span><span class="sxs-lookup"><span data-stu-id="78a44-371">There are extensive protections in place to ensure to prevent malicious access to these keys.</span></span> <span data-ttu-id="78a44-372">但是，具有特定加密要求的用户还可以[提供自己的存储密钥](https://docs.microsoft.com/azure/storage/common/storage-encryption-keys-powershell)，这些密钥在 Azure Key Vault 管理。</span><span class="sxs-lookup"><span data-stu-id="78a44-372">However, users with particular encryption requirements can also [provide their own storage keys](https://docs.microsoft.com/azure/storage/common/storage-encryption-keys-powershell) that are managed in Azure Key Vault.</span></span> <span data-ttu-id="78a44-373">这些密钥可以随时撤消，这会使存储帐户的内容无法访问。</span><span class="sxs-lookup"><span data-stu-id="78a44-373">These keys can be revoked at any time, which would effectively render the contents of the Storage account using them inaccessible.</span></span>

<span data-ttu-id="78a44-374">虚拟机使用加密存储，但通过使用 Windows 上的 BitLocker 或 Linux 上的 Dm-crypt，可以提供另一层的加密。</span><span class="sxs-lookup"><span data-stu-id="78a44-374">Virtual machines use encrypted storage, but it's possible to provide another layer of encryption by using technologies like BitLocker on Windows or DM-Crypt on Linux.</span></span> <span data-ttu-id="78a44-375">这些技术意味着，即使磁盘映像是从存储中泄露的，也仍然无法读取。</span><span class="sxs-lookup"><span data-stu-id="78a44-375">These technologies mean that even if the disk image was leaked off of storage, it would remain near impossible to read it.</span></span>

### <a name="azure-sql"></a><span data-ttu-id="78a44-376">Azure SQL</span><span class="sxs-lookup"><span data-stu-id="78a44-376">Azure SQL</span></span>

<span data-ttu-id="78a44-377">托管在 Azure SQL 中的数据库使用称为[透明数据加密（TDE）](/sql/relational-databases/security/encryption/transparent-data-encryption)的技术来确保数据保持加密。</span><span class="sxs-lookup"><span data-stu-id="78a44-377">Databases hosted on Azure SQL use a technology called [Transparent Data Encryption (TDE)](/sql/relational-databases/security/encryption/transparent-data-encryption) to ensure data remains encrypted.</span></span> <span data-ttu-id="78a44-378">默认情况下，它在所有新创建的 SQL 数据库上都处于启用状态，但必须为旧数据库手动启用。</span><span class="sxs-lookup"><span data-stu-id="78a44-378">It's enabled by default on all newly created SQL databases, but must be enabled manually for legacy databases.</span></span> <span data-ttu-id="78a44-379">TDE 不仅执行数据库的实时加密和解密，而且还执行备份和事务日志。</span><span class="sxs-lookup"><span data-stu-id="78a44-379">TDE executes real-time encryption and decryption of not just the database, but also the backups and transaction logs.</span></span>

<span data-ttu-id="78a44-380">加密参数存储在数据库中， `master` 并在启动时读取到内存中以供剩余操作。</span><span class="sxs-lookup"><span data-stu-id="78a44-380">The encryption parameters are stored in the `master` database and, on startup, are read into memory for the remaining operations.</span></span> <span data-ttu-id="78a44-381">这意味着 `master` 数据库必须保持未加密状态。</span><span class="sxs-lookup"><span data-stu-id="78a44-381">This means that the `master` database must remain unencrypted.</span></span> <span data-ttu-id="78a44-382">实际密钥由 Microsoft 管理。</span><span class="sxs-lookup"><span data-stu-id="78a44-382">The actual key is managed by Microsoft.</span></span> <span data-ttu-id="78a44-383">但是，具有严格安全要求的用户可能会在 Key Vault 中提供自己的密钥，这一点与对 Azure 存储的处理方式几乎相同。</span><span class="sxs-lookup"><span data-stu-id="78a44-383">However, users with exacting security requirements may provide their own key in Key Vault in much the same way as is done for Azure Storage.</span></span> <span data-ttu-id="78a44-384">Key Vault 提供密钥轮换和吊销等服务。</span><span class="sxs-lookup"><span data-stu-id="78a44-384">The Key Vault provides for such services as key rotation and revocation.</span></span>

<span data-ttu-id="78a44-385">TDS 的 "透明" 部分的事实是，不需要对客户端进行任何更改即可使用加密的数据库。</span><span class="sxs-lookup"><span data-stu-id="78a44-385">The "Transparent" part of TDS comes from the fact that there aren't client changes needed to use an encrypted database.</span></span> <span data-ttu-id="78a44-386">虽然这种方法提供了良好的安全性，但泄漏数据库密码足以使用户能够对数据进行解密。</span><span class="sxs-lookup"><span data-stu-id="78a44-386">While this approach provides for good security, leaking the database password is enough for users to be able to decrypt the data.</span></span> <span data-ttu-id="78a44-387">还有另一种方法可加密数据库中的单个列或多个表。</span><span class="sxs-lookup"><span data-stu-id="78a44-387">There's another approach that encrypts individual columns or tables in a database.</span></span> <span data-ttu-id="78a44-388">[Always Encrypted](https://docs.microsoft.com/azure/sql-database/sql-database-always-encrypted-azure-key-vault)确保在数据库内以纯文本形式显示加密的数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-388">[Always Encrypted](https://docs.microsoft.com/azure/sql-database/sql-database-always-encrypted-azure-key-vault) ensures that at no point the encrypted data appears in plain text inside the database.</span></span>

<span data-ttu-id="78a44-389">设置此加密层需要在 SQL Server Management Studio 中通过向导运行，以选择加密的类型以及在 Key Vault 中存储关联密钥的位置。</span><span class="sxs-lookup"><span data-stu-id="78a44-389">Setting up this tier of encryption requires running through a wizard in SQL Server Management Studio to select the sort of encryption and where in Key Vault to store the associated keys.</span></span>

![图9-6 使用 Always Encrypted 选择要加密的表中的列](./media/always-encrypted.png)

<span data-ttu-id="78a44-391">**图 9-6**。</span><span class="sxs-lookup"><span data-stu-id="78a44-391">**Figure 9-6**.</span></span> <span data-ttu-id="78a44-392">选择要使用 Always Encrypted 加密的表中的列。</span><span class="sxs-lookup"><span data-stu-id="78a44-392">Selecting columns in a table to be encrypted using Always Encrypted.</span></span>

<span data-ttu-id="78a44-393">从这些加密列读取信息的客户端应用程序需要特别的补助来读取加密的数据。</span><span class="sxs-lookup"><span data-stu-id="78a44-393">Client applications that read information from these encrypted columns need to make special allowances to read encrypted data.</span></span> <span data-ttu-id="78a44-394">需要用更新连接字符串 `Column Encryption Setting=Enabled` ，并且必须从 Key Vault 检索客户端凭据。</span><span class="sxs-lookup"><span data-stu-id="78a44-394">Connection strings need to be updated with `Column Encryption Setting=Enabled` and client credentials must be retrieved from the Key Vault.</span></span> <span data-ttu-id="78a44-395">然后，SQL Server 客户端必须高速列加密密钥。</span><span class="sxs-lookup"><span data-stu-id="78a44-395">The SQL Server client must then be primed with the column encryption keys.</span></span> <span data-ttu-id="78a44-396">完成此操作后，剩余操作将使用标准接口到 SQL 客户端。</span><span class="sxs-lookup"><span data-stu-id="78a44-396">Once that is done, the remaining actions use the standard interfaces to SQL Client.</span></span> <span data-ttu-id="78a44-397">这就是，在 SQL 客户端上构建的 Dapper 和实体框架等工具将继续运行，而不会发生任何更改。</span><span class="sxs-lookup"><span data-stu-id="78a44-397">That is, tools like Dapper and Entity Framework, which are built on top of SQL Client, will continue to work without changes.</span></span> <span data-ttu-id="78a44-398">每种语言的每个 SQL Server 驱动程序的 Always Encrypted 可能尚未提供。</span><span class="sxs-lookup"><span data-stu-id="78a44-398">Always Encrypted may not yet be available for every SQL Server driver on every language.</span></span>

<span data-ttu-id="78a44-399">TDE 和 Always Encrypted 的组合，两者均可与客户端特定的密钥结合使用，可确保甚至支持最严格的加密要求。</span><span class="sxs-lookup"><span data-stu-id="78a44-399">The combination of TDE and Always Encrypted, both of which can be used with client-specific keys, ensures that even the most exacting encryption requirements are supported.</span></span>

### <a name="cosmos-db"></a><span data-ttu-id="78a44-400">Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="78a44-400">Cosmos DB</span></span>

<span data-ttu-id="78a44-401">Cosmos DB 是 Microsoft 在 Azure 中提供的最新数据库。</span><span class="sxs-lookup"><span data-stu-id="78a44-401">Cosmos DB is the newest database provided by Microsoft in Azure.</span></span> <span data-ttu-id="78a44-402">它已从头开始构建安全性和加密。</span><span class="sxs-lookup"><span data-stu-id="78a44-402">It has been built from the ground up with security and cryptography in mind.</span></span> <span data-ttu-id="78a44-403">对于所有 Cosmos DB 数据库，AES-256bit 加密是标准的，不能禁用。</span><span class="sxs-lookup"><span data-stu-id="78a44-403">AES-256bit encryption is standard for all Cosmos DB databases and can't be disabled.</span></span> <span data-ttu-id="78a44-404">与用于通信的 TLS 1.2 要求一起，整个存储解决方案已加密。</span><span class="sxs-lookup"><span data-stu-id="78a44-404">Coupled with the TLS 1.2 requirement for communication, the entire storage solution is encrypted.</span></span>

![图 9-7 Cosmos DB 内的数据加密流](./media/cosmos-encryption.png)

<span data-ttu-id="78a44-406">**图 9-7**。</span><span class="sxs-lookup"><span data-stu-id="78a44-406">**Figure 9-7**.</span></span> <span data-ttu-id="78a44-407">Cosmos DB 中的数据加密流。</span><span class="sxs-lookup"><span data-stu-id="78a44-407">The flow of data encryption within Cosmos DB.</span></span>

<span data-ttu-id="78a44-408">尽管 Cosmos DB 不提供提供客户的加密密钥，但团队已经完成了一项重要的工作，以确保它保持符合 PCI DSS 的标准。</span><span class="sxs-lookup"><span data-stu-id="78a44-408">While Cosmos DB doesn't provide for supplying customer encryption keys, there has been significant work done by the team to ensure it remains PCI-DSS compliant without that.</span></span> <span data-ttu-id="78a44-409">Cosmos DB 还不支持与 Azure SQL 的 Always Encrypted 相似的任何一列的加密。</span><span class="sxs-lookup"><span data-stu-id="78a44-409">Cosmos DB also doesn't support any sort of single column encryption similar to Azure SQL's Always Encrypted yet.</span></span>

## <a name="keeping-secure"></a><span data-ttu-id="78a44-410">保持安全</span><span class="sxs-lookup"><span data-stu-id="78a44-410">Keeping secure</span></span>

<span data-ttu-id="78a44-411">Azure 提供了发布高度安全的产品所需的所有工具。</span><span class="sxs-lookup"><span data-stu-id="78a44-411">Azure has all the tools necessary to release a highly secure product.</span></span> <span data-ttu-id="78a44-412">但是，链的优点只是其最弱的链接。</span><span class="sxs-lookup"><span data-stu-id="78a44-412">However, a chain is only as strong as its weakest link.</span></span> <span data-ttu-id="78a44-413">如果部署在 Azure 之上的应用程序未使用适当的安全思维和良好的安全审核来开发，则它们将成为链中的弱链接。</span><span class="sxs-lookup"><span data-stu-id="78a44-413">If the applications deployed on top of Azure aren't developed with a proper security mindset and good security audits, then they become the weak link in the chain.</span></span> <span data-ttu-id="78a44-414">可以使用很多极佳的静态分析工具、加密库和安全做法，以确保在 Azure 上安装的软件与 Azure 本身的安全性相同。</span><span class="sxs-lookup"><span data-stu-id="78a44-414">There are many great static analysis tools, encryption libraries, and security practices that can be used to ensure that the software installed on Azure is as secure as Azure itself.</span></span> <span data-ttu-id="78a44-415">示例包括[静态分析工具](https://www.whitesourcesoftware.com/)、[加密库](https://www.libressl.org/)和[安全实践](https://azure.microsoft.com/resources/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/)。</span><span class="sxs-lookup"><span data-stu-id="78a44-415">Examples include [static analysis tools](https://www.whitesourcesoftware.com/), [encryption libraries](https://www.libressl.org/), and [security practices](https://azure.microsoft.com/resources/videos/red-vs-blue-internal-security-penetration-testing-of-microsoft-azure/).</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="78a44-416">[上一页](security.md)
>[下一页](devops.md)</span><span class="sxs-lookup"><span data-stu-id="78a44-416">[Previous](security.md)
[Next](devops.md)</span></span>
