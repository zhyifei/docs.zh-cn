---
title: 无服务器体系结构注意事项 - 无服务器应用
description: 从状态管理和持久存储到缩放、日志记录、跟踪和诊断，了解构建无服务器应用程序所面临的挑战。
author: JEREMYLIKNESS
ms.author: jeliknes
ms.date: 06/26/2018
ms.openlocfilehash: c856683cf6910be98661e634246cd003b93a6d76
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/14/2020
ms.locfileid: "72522428"
---
# <a name="serverless-architecture-considerations"></a>无服务器体系结构注意事项

采用无服务器体系结构确实带来一些挑战。 本节探讨了一些需要注意的较为常见的注意事项。 所有这些挑战都具有解决方案。 与所有体系结构选择一样，只有在仔细权衡利弊之后才可以决定采用无服务器。 根据应用程序的需求，你可能会认为无服务器实现并非某些组件的正确解决方案。

## <a name="managing-state"></a>管理状态

与一般的微服务一样，无服务器函数默认情况下是无状态的。 避免状态使无服务器生存期变短、可横向扩展并在中心点故障的情况下提供复原能力。 在某些情况下，业务流程需要状态。 如果流程需要状态，则有两个选择。 你可以采用无服务器以外的模型，也可以与提供状态的单独服务进行交互。 添加状态会使解决方案复杂化，使其难以缩放，并可能产生单一故障点。 仔细考虑功能是否绝对需要状态。 如果答案是“是”，请确定使用无服务器实现它是否仍然有意义。

有几种解决方案可以采用状态而不会削弱无服务器的优势。 一些更常见的解决方案包括：

- 使用临时数据存储或分布式缓存，例如 Redis
- 将状态存储在数据库中，例如 SQL 或 CosmosDB
- 通过工作流引擎（如持久函数）处理状态

关键在于，你应该明白正在考虑使用无服务器实现的进程中是否需要进行任何状态管理。

## <a name="long-running-processes"></a>长时间运行的进程

无服务器的诸多优势均依赖于短暂的进程。 较短的运行时间使无服务器提供程序更容易在函数结束时释放资源并在主机之间共享函数。 大多数云提供商将函数可以运行的总时间限制在 10 分钟左右。 如果进程可能花费更长时间，则可以考虑使用其他方式实现。

有几个例外情况和解决方案。 一种解决方法是将进程分解为单独花费更少运行时间的小组件。 如果进程因依赖项而导致运行时间很长，那么还可以考虑使用诸如持久函数之类的解决方案来实现异步工作流。 持久函数会在等待外部进程完成的时间内暂停并维护进程状态。 异步处理减少了实际进程运行的时间。

## <a name="startup-time"></a>启动时间

无服务器实现的一个潜在问题是启动时间。 为了节省资源，许多无服务器提供程序都可以“按需”创建基础结构。 如果在一段时间后触发了无服务器函数，则可能需要创建或重启托管该函数的资源。 在某些情况下，冷启动可能会导致几秒钟的延迟。 启动时间因提供程序和服务级别而异。 如果尽量减少启动时间对于软件是否成功来说非常重要，那么有几种方法可以解决启动时间问题。

- 一些提供程序允许用户为可保证基础结构“始终可用”的服务级别付费。
- 实现一个保持连接的机制（对终结点执行 ping 操作以使其保持“唤醒”状态）。
- 将 Kubernetes 之类的业务流程与容器化函数方法结合使用（主机已经在运行，因此配置新实例的速度非常快）。

## <a name="database-updates-and-migrations"></a>数据库更新和迁移

无服务器代码的一个优点是不必重新部署整个应用程序就可以释放新函数。 当涉及到关系数据库时，此优势可能成为一个缺点。 对数据库架构的更改很难与无服务器更新同步。 当出现问题并且必须回滚这些更改时，还会带来其他挑战。 数据完整性是微服务最佳做法的原因之一，无服务器函数最佳做法原因之一是它们拥有自己的数据。 可以将更改作为计算和数据的单个单元部署。 现实情况是，许多旧的系统都具有大型后端数据库，该数据库必须与无服务器体系结构进行协调。

解决架构版本控制的常用方法是从不修改现有属性和列，而是添加新信息。 例如，考虑从待办事项列表的布尔“已完成”标记移动到“完成日期”的更改。 数据库更改不会删除旧字段，而是会：

1. 添加新的“完成日期”字段。
1. 将“已完成”布尔字段转换为计算函数，该函数计算完成日期是否在当前日期之后。
1. 当“已完成”布尔值设置为 true 时，添加触发器以将“完成日期”设置为当前日期。

更改顺序确保旧代码继续“按原样”运行，而更新的无服务器函数可以利用新的字段。

有关无服务器体系结构中数据的详细信息，请参阅[分布式数据管理的挑战和解决方案](../microservices/architect-microservice-container-applications/distributed-data-management.md)。

## <a name="scaling"></a>缩放

无服务器意味着“没有服务器”，这是一个常见的误解。 事实上，这是“更少服务器”的意思。 事实证明，有一个后备基础结构对于了解缩放很重要。 大多数无服务器平台都提供一组控件，以处理事件密度增加时基础结构应如何缩放。 你可以从多种选项中进行选择，但是策略可能因函数而异。 而且，函数通常在相关主机下运行，因此同一主机上的函数具有相同的缩放选项。 因此，有必要根据缩放要求来组织和规划将哪些函数托管在一起。

规则通常会根据不同参数指定如何纵向扩展（增加主机资源）和横向扩展（增加主机实例的数量）。 缩放的触发器可能包括日程安排、请求速率、CPU 使用率和内存使用率。 更高的性能通常要付出更高的成本。 当请求率突然增加时，较便宜的基于消耗的方法可能无法迅速缩放。 在预先付费“保险成本”与严格即付“即用”之间存在权衡，由于需求突然增加而导致风险响应速度变慢。

## <a name="monitoring-tracing-and-logging"></a>监视、跟踪和日志记录

DevOps 经常被忽略的方面是一旦部署就会监视应用程序。 制定监视无服务器函数的策略非常重要。 最大的挑战通常是关联的，或者在用户将多个函数作为同一交互的一部分调用时进行识别。 大多数无服务器平台允许可导入第三方工具的控制台日志记录。 还提供了一些选项，可用于自动收集遥测数据、生成和跟踪相关 ID 以及监视特定操作，以提供详细的见解。 Azure 提供了用于监视和分析的高级 [Application Insights 平台](https://docs.microsoft.com/azure/azure-functions/functions-monitoring)。

## <a name="inter-service-dependencies"></a>服务间依赖项

无服务器体系结构可包含依赖于其他函数的函数。 实际上，在无服务器体系结构中，将多个服务作为交互或分布式事务的一部分相互调用并不罕见。 为避免强耦合，建议服务不要直接相互引用。 当服务的终结点需要更改时，直接引用可能会导致主要重构。 建议的解决方案是提供一种服务发现机制（例如注册表），该机制为请求类型提供适当的终结点。 另一个解决方案是利用消息服务（例如队列或主题）在服务之间进行通信。

## <a name="managing-failure-and-providing-resiliency"></a>管理故障并提供复原能力

考虑使用断路器模式  也很重要：如果由于某种原因而导致服务继续失败，则不建议重复调用该服务。 相反，调用替代服务或返回一条消息，直到重新建立依赖服务的运行状况。 无服务器体系结构需要考虑建立解决和管理服务间依赖项的策略。

要继续使用断路器模式，服务需要具有容错能力并可复原。 容错是指即使遇到意外异常或无效状态，应用程序也可以继续运行的能力。 容错通常是代码本身的一项功能，以及如何编写它来处理异常。 复原能力是指应用程序从故障中恢复的能力。 复原能力通常由无服务器平台管理。 当现有无服务器函数实例出现故障时，该平台应能够启动一个新的无服务器函数实例。 该平台还应该足够智能，可在每个新实例失败时停止启动新实例。

有关详细信息，请参阅[实现断路器模式](../microservices/implement-resilient-applications/implement-circuit-breaker-pattern.md)。

## <a name="versioning-and-greenblue-deployments"></a>版本控制和绿色/蓝色部署

无服务器的主要优势是无需重新部署整个应用程序即可升级特定函数。 为使升级成功，必须对函数进行版本控制，以便将调用它们的服务路由到正确的代码版本。 部署新版本的策略也很重要。 一种常见的方法是使用“绿色/蓝色部署”。 绿色部署是当前函数。 新的“蓝色”版本已部署到生产环境中并进行了测试。 测试通过时，绿色和蓝色版本会互换，因此新版本生效。 如果遇到任何问题，可以将它们调换回来。 支持版本控制和绿色/蓝色部署需要编写函数以适应版本更改以及与无服务器平台一起处理部署的组合。 一种可能的方法是使用代理，这些代理在 [Azure 无服务器平台](azure-functions.md#proxies)一章中进行了介绍。

>[!div class="step-by-step"]
>[上一页](serverless-architecture.md)
>[下一页](serverless-design-examples.md)
