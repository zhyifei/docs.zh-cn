---
title: 加载延迟的内容（WCF 数据服务）
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF Data Services, client library
- WCF Data Services, deferred content
- WCF Data Services, loading data
ms.assetid: 32f9b588-c832-44c4-a7e0-fcce635df59a
ms.openlocfilehash: ee7b0b40d74d908dc4f25372273f852662370df0
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "62037123"
---
# <a name="loading-deferred-content-wcf-data-services"></a><span data-ttu-id="1600e-102">加载延迟的内容（WCF 数据服务）</span><span class="sxs-lookup"><span data-stu-id="1600e-102">Loading Deferred Content (WCF Data Services)</span></span>
<span data-ttu-id="1600e-103">默认情况下，[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] 会限制查询返回的数据量。</span><span class="sxs-lookup"><span data-stu-id="1600e-103">By default, [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] limits the amount of data that a query returns.</span></span> <span data-ttu-id="1600e-104">不过，如果需要，您可以从该数据服务显式加载其他数据，包括相关实体、分页响应数据以及二进制数据流。</span><span class="sxs-lookup"><span data-stu-id="1600e-104">However, you can explicitly load additional data, including related entities, paged response data, and binary data streams, from the data service when it is needed.</span></span> <span data-ttu-id="1600e-105">本主题介绍如何将这种延迟的内容加载到应用程序。</span><span class="sxs-lookup"><span data-stu-id="1600e-105">This topic describes how to load such deferred content into your application.</span></span>  
  
## <a name="related-entities"></a><span data-ttu-id="1600e-106">相关实体</span><span class="sxs-lookup"><span data-stu-id="1600e-106">Related Entities</span></span>  
 <span data-ttu-id="1600e-107">执行查询时，仅返回所处理实体集中的实体。</span><span class="sxs-lookup"><span data-stu-id="1600e-107">When you execute a query, only entities in the addressed entity set are returned.</span></span> <span data-ttu-id="1600e-108">例如，当针对 Northwind 数据服务的某个查询返回 `Customers` 实体时，默认情况下不会返回相关的 `Orders` 实体，即使 `Customers` 和 `Orders` 之间存在关系也是如此。</span><span class="sxs-lookup"><span data-stu-id="1600e-108">For example, when a query against the Northwind data service returns `Customers` entities, by default the related `Orders` entities are not returned, even though there is a relationship between `Customers` and `Orders`.</span></span> <span data-ttu-id="1600e-109">此外，如果数据服务中启用了分页，则必须从该服务显式加载后续数据页。</span><span class="sxs-lookup"><span data-stu-id="1600e-109">Also, when paging is enabled in the data service, you must explicitly load subsequent data pages from the service.</span></span> <span data-ttu-id="1600e-110">可通过以下两种方法来加载相关实体：</span><span class="sxs-lookup"><span data-stu-id="1600e-110">There are two ways to load related entities:</span></span>  
  
- <span data-ttu-id="1600e-111">**预先加载**:可以使用`$expand`查询选项来请求查询返回与该实体的关联相关的实体集所请求的查询。</span><span class="sxs-lookup"><span data-stu-id="1600e-111">**Eager loading**: You can use the `$expand` query option to request that the query return entities that are related by an association to the entity set that the query requested.</span></span> <span data-ttu-id="1600e-112">使用 <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A> 的 <xref:System.Data.Services.Client.DataServiceQuery%601> 方法将 `$expand` 选项添加到发送给数据服务的查询。</span><span class="sxs-lookup"><span data-stu-id="1600e-112">Use the <xref:System.Data.Services.Client.DataServiceQuery%601.Expand%2A> method on the <xref:System.Data.Services.Client.DataServiceQuery%601> to add the `$expand` option to the query that is sent to the data service.</span></span> <span data-ttu-id="1600e-113">可以请求多个相关的实体集，方法是用逗号分隔它们，如下面的示例所示。</span><span class="sxs-lookup"><span data-stu-id="1600e-113">You can request multiple related entity sets by separating them by a comma, as in the following example.</span></span> <span data-ttu-id="1600e-114">查询请求的所有实体均在单个响应中返回。</span><span class="sxs-lookup"><span data-stu-id="1600e-114">All entities requested by the query are returned in a single response.</span></span> <span data-ttu-id="1600e-115">下面的示例将返回 `Order_Details` 以及 `Customers` 和 `Orders` 实体集：</span><span class="sxs-lookup"><span data-stu-id="1600e-115">The following example returns `Order_Details` and `Customers` together with the `Orders` entity set:</span></span>  
  
     [!code-csharp[Astoria Northwind Client#ExpandOrderDetailsSpecific](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#expandorderdetailsspecific)]
     [!code-vb[Astoria Northwind Client#ExpandOrderDetailsSpecific](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#expandorderdetailsspecific)]  
  
     [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]<span data-ttu-id="1600e-116">将实体集数量限制为 12，这是可通过使用 `$expand` 查询选项包括在单个查询中的数量。</span><span class="sxs-lookup"><span data-stu-id="1600e-116">limits to 12 the number of entity sets that can be included in a single query by using the `$expand` query option.</span></span>  
  
- <span data-ttu-id="1600e-117">**显式加载**:您可以调用<xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A>方法<xref:System.Data.Services.Client.DataServiceContext>要显式加载相关的实体实例。</span><span class="sxs-lookup"><span data-stu-id="1600e-117">**Explicit loading**: You can call the <xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A> method on the <xref:System.Data.Services.Client.DataServiceContext> instance to explicitly load related entities.</span></span> <span data-ttu-id="1600e-118">每次调用 <xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A> 方法都会创建一个对数据服务的单独请求。</span><span class="sxs-lookup"><span data-stu-id="1600e-118">Each call to the <xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A> method creates a separate request to the data service.</span></span> <span data-ttu-id="1600e-119">下面的示例为 `Order_Details` 实体显式加载 `Orders`：</span><span class="sxs-lookup"><span data-stu-id="1600e-119">The following example explicitly loads `Order_Details` for an `Orders` entity:</span></span>  
  
     [!code-csharp[Astoria Northwind Client#LoadRelatedOrderDetailsSpecific](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#loadrelatedorderdetailsspecific)]
     [!code-vb[Astoria Northwind Client#LoadRelatedOrderDetailsSpecific](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#loadrelatedorderdetailsspecific)]  
  
 <span data-ttu-id="1600e-120">在考虑要使用哪个选项时，请注意在对数据服务的请求数与单个响应中返回的数据量之间进行权衡。</span><span class="sxs-lookup"><span data-stu-id="1600e-120">When you consider which option to use, realize that there is a tradeoff between the number of requests to the data service and the amount of data that is returned in a single response.</span></span> <span data-ttu-id="1600e-121">如果您的应用程序需要关联的对象，并且您希望避免因显式检索这些对象的额外请求而导致延迟增加，请使用预先加载。</span><span class="sxs-lookup"><span data-stu-id="1600e-121">Use eager loading when your application requires associated objects and you want to avoid the added latency of additional requests to explicitly retrieve them.</span></span> <span data-ttu-id="1600e-122">不过，如果应用程序仅需要特定相关实体实例的数据，则应考虑通过调用 <xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A> 方法显式加载这些实体。</span><span class="sxs-lookup"><span data-stu-id="1600e-122">However, if there are cases when the application only needs the data for specific related entity instances, you should consider explicitly loading those entities by calling the <xref:System.Data.Services.Client.DataServiceContext.LoadProperty%2A> method.</span></span> <span data-ttu-id="1600e-123">有关详细信息，请参阅[如何：加载相关的实体](../../../../docs/framework/data/wcf/how-to-load-related-entities-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="1600e-123">For more information, see [How to: Load Related Entities](../../../../docs/framework/data/wcf/how-to-load-related-entities-wcf-data-services.md).</span></span>  
  
## <a name="paged-content"></a><span data-ttu-id="1600e-124">分页内容</span><span class="sxs-lookup"><span data-stu-id="1600e-124">Paged Content</span></span>  
 <span data-ttu-id="1600e-125">如果在数据服务中启用了分页，则数据服务返回的源中的项数受数据服务的配置的限制。</span><span class="sxs-lookup"><span data-stu-id="1600e-125">When paging is enabled in the data service, the number of entries in the feed that the data service returns is limited by the configuration of the data service.</span></span> <span data-ttu-id="1600e-126">可以为每个实体集单独设置页限制。</span><span class="sxs-lookup"><span data-stu-id="1600e-126">Page limits can be set separately for each entity set.</span></span> <span data-ttu-id="1600e-127">有关详细信息，请参阅[数据服务配置](../../../../docs/framework/data/wcf/configuring-the-data-service-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="1600e-127">For more information, see [Configuring the Data Service](../../../../docs/framework/data/wcf/configuring-the-data-service-wcf-data-services.md).</span></span> <span data-ttu-id="1600e-128">启用分页后，源中的最后一项包含指向下一页数据的链接。</span><span class="sxs-lookup"><span data-stu-id="1600e-128">When paging is enabled, the final entry in the feed contains a link to the next page of data.</span></span> <span data-ttu-id="1600e-129">此链接包含在一个 <xref:System.Data.Services.Client.DataServiceQueryContinuation%601> 对象中。</span><span class="sxs-lookup"><span data-stu-id="1600e-129">This link is contained in a <xref:System.Data.Services.Client.DataServiceQueryContinuation%601> object.</span></span> <span data-ttu-id="1600e-130">通过对执行 <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> 时返回的 <xref:System.Data.Services.Client.QueryOperationResponse%601> 调用 <xref:System.Data.Services.Client.DataServiceQuery%601> 方法可以获取指向下一页数据的 URI。</span><span class="sxs-lookup"><span data-stu-id="1600e-130">You obtain the URI to the next page of data by calling the <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> method on the <xref:System.Data.Services.Client.QueryOperationResponse%601> returned when the <xref:System.Data.Services.Client.DataServiceQuery%601> is executed.</span></span> <span data-ttu-id="1600e-131">然后，使用返回的 <xref:System.Data.Services.Client.DataServiceQueryContinuation%601> 对象加载下一页结果。</span><span class="sxs-lookup"><span data-stu-id="1600e-131">The returned <xref:System.Data.Services.Client.DataServiceQueryContinuation%601> object is then used to load the next page of results.</span></span> <span data-ttu-id="1600e-132">必须先枚举查询结果，然后再调用 <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="1600e-132">You must enumerate the query result before you call the <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> method.</span></span> <span data-ttu-id="1600e-133">请考虑使用 `do…while` 循环首先枚举查询结果，然后再检查 `non-null` 下一个链接值。</span><span class="sxs-lookup"><span data-stu-id="1600e-133">Consider using a `do…while` loop to first enumerate the query result and then check for a `non-null` next link value.</span></span> <span data-ttu-id="1600e-134">如果 <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> 方法返回 `null`（在 Visual Basic 中为 `Nothing`），则表示原始查询没有任何其他结果页。</span><span class="sxs-lookup"><span data-stu-id="1600e-134">When the <xref:System.Data.Services.Client.QueryOperationResponse%601.GetContinuation%2A> method returns `null` (`Nothing` in Visual Basic), there are no additional result pages for the original query.</span></span> <span data-ttu-id="1600e-135">下面的示例所演示的 `do…while` 循环从 Northwind 示例数据服务中加载分页的客户数据。</span><span class="sxs-lookup"><span data-stu-id="1600e-135">The following example shows a `do…while` loop that loads paged customer data from the Northwind sample data service.</span></span>  
  
 [!code-csharp[Astoria Northwind Client#LoadNextLink](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#loadnextlink)]
 [!code-vb[Astoria Northwind Client#LoadNextLink](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#loadnextlink)]  
  
 <span data-ttu-id="1600e-136">如果某个查询请求在单个响应中与所请求的实体集一起返回相关的实体，则分页限制可能会影响以内联形式包含在该响应中的嵌套源。</span><span class="sxs-lookup"><span data-stu-id="1600e-136">When a query requests that related entities are returned in a single response together with the requested entity set, paging limits may affect nested feeds that are included inline with the response.</span></span> <span data-ttu-id="1600e-137">例如，如果在 Northwind 示例数据服务中为 `Customers` 实体集设置了分页限制，则还可以为相关的 `Orders` 实体集设置单独的分页限制，如下面来自定义 Northwind 示例数据服务的 Northwind.svc.cs 文件的示例所示。</span><span class="sxs-lookup"><span data-stu-id="1600e-137">For example, when a paging limit is set in the Northwind sample data service for the `Customers` entity set, an independent paging limit can also be set for the related `Orders` entity set, as in the following example from the Northwind.svc.cs file that defines the Northwind sample data service.</span></span>  
  
 [!code-csharp[Astoria Northwind Service#DataServiceConfigPaging](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_service/cs/northwind.svc.cs#dataserviceconfigpaging)]
 [!code-vb[Astoria Northwind Service#DataServiceConfigPaging](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_service/vb/northwind.svc.vb#dataserviceconfigpaging)]  
  
 <span data-ttu-id="1600e-138">在这种情况下，必须同时为顶级 `Customers` 和嵌套的 `Orders` 实体源实现分页。</span><span class="sxs-lookup"><span data-stu-id="1600e-138">In this case, you must implement paging for both the top-level `Customers` and the nested `Orders` entity feeds.</span></span> <span data-ttu-id="1600e-139">下面的示例所演示的 `while` 循环用于加载与所选 `Orders` 实体相关的 `Customers` 实体的页。</span><span class="sxs-lookup"><span data-stu-id="1600e-139">The following example shows the `while` loop used to load pages of `Orders` entities related to a selected `Customers` entity.</span></span>  
  
 [!code-csharp[Astoria Northwind Client#LoadNextOrdersLink](../../../../samples/snippets/csharp/VS_Snippets_Misc/astoria_northwind_client/cs/source.cs#loadnextorderslink)]
 [!code-vb[Astoria Northwind Client#LoadNextOrdersLink](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/astoria_northwind_client/vb/source.vb#loadnextorderslink)]  
  
 <span data-ttu-id="1600e-140">有关详细信息，请参阅[如何：加载分页结果](../../../../docs/framework/data/wcf/how-to-load-paged-results-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="1600e-140">For more information, see [How to: Load Paged Results](../../../../docs/framework/data/wcf/how-to-load-paged-results-wcf-data-services.md).</span></span>  
  
## <a name="binary-data-streams"></a><span data-ttu-id="1600e-141">二进制数据流</span><span class="sxs-lookup"><span data-stu-id="1600e-141">Binary Data Streams</span></span>  
 <span data-ttu-id="1600e-142">通过 [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] 能以数据流形式访问二进制大型对象 (BLOB) 数据。</span><span class="sxs-lookup"><span data-stu-id="1600e-142">[!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] enables you to access binary large object (BLOB) data as a data stream.</span></span> <span data-ttu-id="1600e-143">流式处理会将对二进制数据的加载推迟到需要时再加载，并且客户端可以更有效地处理此数据。</span><span class="sxs-lookup"><span data-stu-id="1600e-143">Streaming defers the loading of binary data until it is needed, and the client can more efficiently process this data.</span></span> <span data-ttu-id="1600e-144">为了利用此功能，数据服务必须实现 <xref:System.Data.Services.Providers.IDataServiceStreamProvider> 提供程序。</span><span class="sxs-lookup"><span data-stu-id="1600e-144">In order to take advantage of this functionality, the data service must implement the <xref:System.Data.Services.Providers.IDataServiceStreamProvider> provider.</span></span> <span data-ttu-id="1600e-145">有关详细信息，请参阅[流式处理提供程序](../../../../docs/framework/data/wcf/streaming-provider-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="1600e-145">For more information, see [Streaming Provider](../../../../docs/framework/data/wcf/streaming-provider-wcf-data-services.md).</span></span> <span data-ttu-id="1600e-146">启用流式处理后，会在没有相关二进制数据的情况下返回实体类型。</span><span class="sxs-lookup"><span data-stu-id="1600e-146">When streaming is enabled, entity types are returned without the related binary data.</span></span> <span data-ttu-id="1600e-147">在这种情况下，必须使用<xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A>方法的<xref:System.Data.Services.Client.DataServiceContext>类，以从服务访问二进制数据的数据流。</span><span class="sxs-lookup"><span data-stu-id="1600e-147">In this case, you must use the <xref:System.Data.Services.Client.DataServiceContext.GetReadStream%2A> method of the <xref:System.Data.Services.Client.DataServiceContext> class to access the data stream for the binary data from the service.</span></span> <span data-ttu-id="1600e-148">同样，使用 <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> 方法可以作为流添加或更改实体的二进制数据。</span><span class="sxs-lookup"><span data-stu-id="1600e-148">Similarly, use the <xref:System.Data.Services.Client.DataServiceContext.SetSaveStream%2A> method to add or change binary data for an entity as a stream.</span></span> <span data-ttu-id="1600e-149">有关详细信息，请参阅[处理二进制数据](../../../../docs/framework/data/wcf/working-with-binary-data-wcf-data-services.md)。</span><span class="sxs-lookup"><span data-stu-id="1600e-149">For more information, see [Working with Binary Data](../../../../docs/framework/data/wcf/working-with-binary-data-wcf-data-services.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1600e-150">请参阅</span><span class="sxs-lookup"><span data-stu-id="1600e-150">See also</span></span>

- [<span data-ttu-id="1600e-151">WCF Data Services 客户端库</span><span class="sxs-lookup"><span data-stu-id="1600e-151">WCF Data Services Client Library</span></span>](../../../../docs/framework/data/wcf/wcf-data-services-client-library.md)
- [<span data-ttu-id="1600e-152">查询数据服务</span><span class="sxs-lookup"><span data-stu-id="1600e-152">Querying the Data Service</span></span>](../../../../docs/framework/data/wcf/querying-the-data-service-wcf-data-services.md)
