---
title: OLE DB、ODBC 和 Oracle 连接池
ms.date: 03/30/2017
ms.assetid: 2bd83b1e-3ea9-43c4-bade-d9cdb9bbbb04
ms.openlocfilehash: 7c17863facd962583e0da03e810c9a8150cda0a6
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59208886"
---
# <a name="ole-db-odbc-and-oracle-connection-pooling"></a><span data-ttu-id="ee4b5-102">OLE DB、ODBC 和 Oracle 连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-102">OLE DB, ODBC, and Oracle Connection Pooling</span></span>
<span data-ttu-id="ee4b5-103">池连接可以显著提高应用程序的性能和可缩放性。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-103">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="ee4b5-104">本节介绍用于 OLE DB、ODBC 和 Oracle 的 .NET Framework 数据提供程序的连接池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-104">This section discusses connection pooling for the .NET Framework data providers for OLE DB, ODBC and Oracle.</span></span>  
  
## <a name="connection-pooling-for-oledb"></a><span data-ttu-id="ee4b5-105">OleDb 连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-105">Connection Pooling for OleDb</span></span>  
 <span data-ttu-id="ee4b5-106">OLE DB .NET Framework 数据提供程序使用 OLE DB 会话池自动管理连接池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-106">The .NET Framework Data Provider for OLE DB automatically pools connections using OLE DB session pooling.</span></span> <span data-ttu-id="ee4b5-107">连接字符串自变量可用于启用或禁用包括池在内的 OLE DB 服务。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-107">Connection string arguments can be used to enable or disable OLE DB services including pooling.</span></span> <span data-ttu-id="ee4b5-108">例如，以下连接字符串禁用 OLE DB 会话池和自动事务登记。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-108">For example, the following connection string disables OLE DB session pooling and automatic transaction enlistment.</span></span>  
  
```  
Provider=SQLOLEDB;OLE DB Services=-4;Data Source=localhost;Integrated Security=SSPI;  
```  
  
 <span data-ttu-id="ee4b5-109">我们建议您在使用完连接后始终将其关闭或释放，以便连接可以返回到池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-109">We recommend that you always close or dispose of a connection when you are finished using it in order to return the connection to the pool.</span></span> <span data-ttu-id="ee4b5-110">不是显式关闭的连接可能无法返回池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-110">Connections that are not explicitly closed may not get returned to the pool.</span></span> <span data-ttu-id="ee4b5-111">例如，如果连接已超出范围但没有显式关闭，则仅当达到最大池大小而该连接仍然有效时，该连接才会返回到连接池中。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-111">For example, a connection that has gone out of scope but that has not been explicitly closed will only be returned to the connection pool if the maximum pool size has been reached and the connection is still valid.</span></span>  
  
 <span data-ttu-id="ee4b5-112">有关 OLE DB 会话或资源池，以及如何通过重写 OLE DB 提供程序服务默认值禁用池的详细信息，请参阅[OLE DB 程序员指南](https://go.microsoft.com/fwlink/?linkid=45232)。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-112">For more information about OLE DB session or resource pooling, as well as how to disable pooling by overriding OLE DB provider service defaults, see the [OLE DB Programmer's Guide](https://go.microsoft.com/fwlink/?linkid=45232).</span></span>  
  
## <a name="connection-pooling-for-odbc"></a><span data-ttu-id="ee4b5-113">Odbc 连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-113">Connection Pooling for Odbc</span></span>  
 <span data-ttu-id="ee4b5-114">ODBC .NET Framework 数据提供程序的连接池由用于该连接的 ODBC 驱动程序管理器管理，不受 ODBC .NET Framework 数据提供程序的影响。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-114">Connection pooling for the .NET Framework Data Provider for ODBC is managed by the ODBC Driver Manager that is used for the connection, and is not affected by the .NET Framework Data Provider for ODBC.</span></span>  
  
 <span data-ttu-id="ee4b5-115">若要启用或禁用连接池，请打开**ODBC 数据源管理器**控制面板的管理工具文件夹中。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-115">To enable or disable connection pooling, open **ODBC Data Source Administrator** in the Administrative Tools folder of Control Panel.</span></span> <span data-ttu-id="ee4b5-116">**连接池**选项卡允许你指定连接池的每个安装的 ODBC 驱动程序的参数。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-116">The **Connection Pooling** tab allows you to specify connection pooling parameters for each ODBC driver installed.</span></span> <span data-ttu-id="ee4b5-117">请注意，对特定 ODBC 驱动程序所做的更改会影响所有使用该 ODBC 驱动程序的应用程序。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-117">Note that connection pooling changes for a specific ODBC driver affect all applications that use that ODBC driver.</span></span>  
  
## <a name="connection-pooling-for-oracleclient"></a><span data-ttu-id="ee4b5-118">OracleClient 连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-118">Connection Pooling for OracleClient</span></span>  
 <span data-ttu-id="ee4b5-119">Oracle .NET Framework 数据提供程序自动为 ADO.NET 客户端应用程序提供连接池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-119">The .NET Framework Data Provider for Oracle provides connection pooling automatically for your ADO.NET client application.</span></span> <span data-ttu-id="ee4b5-120">您也可以提供几个连接字符串修饰符，用于控制连接池的行为（请参见本主题后文的“使用连接字符串关键字控制连接池”）。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-120">You can also supply several connection string modifiers to control connection pooling behavior (see "Controlling Connection Pooling with Connection String Keywords," later in this topic).</span></span>  
  
### <a name="pool-creation-and-assignment"></a><span data-ttu-id="ee4b5-121">池的创建和分配</span><span class="sxs-lookup"><span data-stu-id="ee4b5-121">Pool Creation and Assignment</span></span>  
 <span data-ttu-id="ee4b5-122">当连接打开时，将根据一种精确的匹配算法来创建连接池，该算法会使连接池与连接中的字符串相关联。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-122">When a connection is opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="ee4b5-123">每个连接池都与一个不同的连接字符串相关联。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-123">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="ee4b5-124">打开新连接时，如果连接字符串并非与现有池完全匹配，将创建一个新池。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-124">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span>  
  
 <span data-ttu-id="ee4b5-125">连接池一旦创建，直到活动进程终止时才会被毁坏。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-125">Once created, connection pools are not destroyed until the active process ends.</span></span> <span data-ttu-id="ee4b5-126">维护不活动的池或空池占用的系统资源非常少。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-126">Maintaining inactive or empty pools uses very few system resources.</span></span>  
  
### <a name="connection-addition"></a><span data-ttu-id="ee4b5-127">连接的添加</span><span class="sxs-lookup"><span data-stu-id="ee4b5-127">Connection Addition</span></span>  
 <span data-ttu-id="ee4b5-128">连接池是为每个唯一的连接字符串创建的。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-128">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="ee4b5-129">当创建一个池后，将创建多个连接对象并将其添加到该池中，以满足最小池大小的需求。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-129">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="ee4b5-130">连接将根据需要添加到池中，直至达到最大池大小。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-130">Connections are added to the pool as needed, up to the maximum pool size.</span></span>  
  
 <span data-ttu-id="ee4b5-131">在请求 <xref:System.Data.OracleClient.OracleConnection> 对象时，如果存在可用的连接，则将从池中获取该对象。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-131">When an <xref:System.Data.OracleClient.OracleConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="ee4b5-132">要成为可用连接，该连接当前必须未被使用，具有匹配的事务上下文或者不与任何事务上下文相关联，并且具有与服务器的有效链接。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-132">To be usable, the connection must currently be unused, have a matching transaction context or not be associated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="ee4b5-133">如果已达到最大池大小且不存在可用的连接，则该请求将会排队。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-133">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="ee4b5-134">当连接被释放回池中时，连接池管理程序通过重新分配连接来满足这些请求。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-134">The connection pooler satisfies these requests by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="ee4b5-135">连接在关闭或断开时释放回池中。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-135">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
### <a name="connection-removal"></a><span data-ttu-id="ee4b5-136">连接的移除</span><span class="sxs-lookup"><span data-stu-id="ee4b5-136">Connection Removal</span></span>  
 <span data-ttu-id="ee4b5-137">如果连接长时间空闲，或池进程检测到与服务器的连接已断开，连接池进程会将该连接从池中移除。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-137">The connection pooler removes a connection from the pool after it has been idle for an extended period of time, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="ee4b5-138">请注意，只有在尝试与服务器进行通信后，才可以检测到这种情况。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-138">Note that this can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="ee4b5-139">如果发现某连接不再连接到服务器，则会将其标记为无效。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-139">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="ee4b5-140">连接池管理程序会定期扫描连接池，查找已释放到池中并标记为无效的对象。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-140">The connection pooler periodically scans connection pools looking for objects that have been released to the pool and are marked as invalid.</span></span> <span data-ttu-id="ee4b5-141">找到后，这些连接将被永久移除。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-141">These connections are then permanently removed.</span></span>  
  
 <span data-ttu-id="ee4b5-142">如果存在一个与已消失的服务器的连接，如果连接池进程尚未检测到断开的连接并将连接标记为无效，可以从池中提取此连接。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-142">If a connection exists to a server that has disappeared, this connection can be drawn from the pool if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="ee4b5-143">当发生这种情况时，将生成异常。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-143">When this occurs, an exception is generated.</span></span> <span data-ttu-id="ee4b5-144">但是，为了将该连接释放回池中，仍必须将其关闭。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-144">However, you must still close the connection in order to release it back into the pool.</span></span>  
  
 <span data-ttu-id="ee4b5-145">不要在类的 `Close` 方法中对 `Dispose`、`Connection` 或任何其他托管对象调用 `DataReader` 或 `Finalize`。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-145">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="ee4b5-146">在终结器中，仅释放类直接拥有的非托管资源。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-146">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="ee4b5-147">如果类不拥有任何非托管资源，则不要在类定义中包含 `Finalize` 方法。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-147">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="ee4b5-148">有关详细信息，请参阅[垃圾回收](../../../../docs/standard/garbage-collection/index.md)。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-148">For more information, see [Garbage Collection](../../../../docs/standard/garbage-collection/index.md).</span></span>  
  
### <a name="transaction-support"></a><span data-ttu-id="ee4b5-149">事务支持</span><span class="sxs-lookup"><span data-stu-id="ee4b5-149">Transaction Support</span></span>  
 <span data-ttu-id="ee4b5-150">连接是根据事务上下文来从池中取出并进行分配的。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-150">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="ee4b5-151">请求线程和所分配的连接的上下文必须匹配。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-151">The context of the requesting thread and the assigned connection must match.</span></span> <span data-ttu-id="ee4b5-152">因此，每个连接池实际上划分成连接相关联，并到没有事务上下文*N*各自包含与特定事务上下文的连接。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-152">Therefore, each connection pool is actually subdivided into connections with no transaction context associated with them, and into *N* subdivisions that each contain connections with a particular transaction context.</span></span>  
  
 <span data-ttu-id="ee4b5-153">当连接关闭时，它将被释放回池中，并根据其事务上下文放入相应的子部分。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-153">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="ee4b5-154">因此，即使分布式事务仍然挂起，仍可以关闭该连接而不会生成错误。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-154">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="ee4b5-155">这样，你就可以在随后提交或中止分布式事务。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-155">This allows you to commit or abort the distributed transaction at a later time.</span></span>  
  
### <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="ee4b5-156">使用连接字符串关键字控制连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-156">Controlling Connection Pooling with Connection String Keywords</span></span>  
 <span data-ttu-id="ee4b5-157"><xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> 对象的 <xref:System.Data.OracleClient.OracleConnection> 属性支持连接字符串键/值对，可以用于调整连接池逻辑的行为。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-157">The <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> property of the <xref:System.Data.OracleClient.OracleConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span>  
  
 <span data-ttu-id="ee4b5-158">下表描述了可用于调整连接池行为的 <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> 值。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-158">The following table describes the <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A> values you can use to adjust connection pooling behavior.</span></span>  
  
|<span data-ttu-id="ee4b5-159">名称</span><span class="sxs-lookup"><span data-stu-id="ee4b5-159">Name</span></span>|<span data-ttu-id="ee4b5-160">默认</span><span class="sxs-lookup"><span data-stu-id="ee4b5-160">Default</span></span>|<span data-ttu-id="ee4b5-161">描述</span><span class="sxs-lookup"><span data-stu-id="ee4b5-161">Description</span></span>|  
|----------|-------------|-----------------|  
|`Connection Lifetime`|<span data-ttu-id="ee4b5-162">0</span><span class="sxs-lookup"><span data-stu-id="ee4b5-162">0</span></span>|<span data-ttu-id="ee4b5-163">连接返回到池中后，创建时间将与当前时间进行比较，如果时间跨度（秒）超过 `Connection Lifetime` 指定的值，该连接将被破坏。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-163">When a connection is returned to the pool, its creation time is compared with the current time, and the connection is destroyed if that time span (in seconds) exceeds the value specified by `Connection Lifetime`.</span></span> <span data-ttu-id="ee4b5-164">在聚集配置中可以使用它来强制在运行服务器和刚联机的服务器之间达到负载平衡。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-164">This is useful in clustered configurations to force load balancing between a running server and a server just brought online.</span></span><br /><br /> <span data-ttu-id="ee4b5-165">如果值为零 (0)，则将使池连接具有最大的超时期限。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-165">A value of zero (0) will cause pooled connections to have the maximum time-out.</span></span>|  
|`Enlist`|<span data-ttu-id="ee4b5-166">'true'</span><span class="sxs-lookup"><span data-stu-id="ee4b5-166">'true'</span></span>|<span data-ttu-id="ee4b5-167">当为 `true` 时，如果存在事务上下文，池管理程序将自动在创建线程的当前事务上下文中登记连接。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-167">When `true`, the pooler automatically enlists the connection in the current transaction context of the creation thread if a transaction context exists.</span></span>|  
|`Max Pool Size`|<span data-ttu-id="ee4b5-168">100</span><span class="sxs-lookup"><span data-stu-id="ee4b5-168">100</span></span>|<span data-ttu-id="ee4b5-169">池中允许的最大连接数。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-169">The maximum number of connections allowed in the pool.</span></span>|  
|`Min Pool Size`|<span data-ttu-id="ee4b5-170">0</span><span class="sxs-lookup"><span data-stu-id="ee4b5-170">0</span></span>|<span data-ttu-id="ee4b5-171">池中维护的最小连接数。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-171">The minimum number of connections maintained in the pool.</span></span>|  
|`Pooling`|<span data-ttu-id="ee4b5-172">'true'</span><span class="sxs-lookup"><span data-stu-id="ee4b5-172">'true'</span></span>|<span data-ttu-id="ee4b5-173">当为 `true` 时，将从相应的池中取出连接，或者在必要时创建连接并将其添加到相应的池中。</span><span class="sxs-lookup"><span data-stu-id="ee4b5-173">When `true`, the connection is drawn from the appropriate pool, or if necessary, created and added to the appropriate pool.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="ee4b5-174">请参阅</span><span class="sxs-lookup"><span data-stu-id="ee4b5-174">See also</span></span>

- [<span data-ttu-id="ee4b5-175">连接池</span><span class="sxs-lookup"><span data-stu-id="ee4b5-175">Connection Pooling</span></span>](../../../../docs/framework/data/adonet/connection-pooling.md)
- [<span data-ttu-id="ee4b5-176">性能计数器</span><span class="sxs-lookup"><span data-stu-id="ee4b5-176">Performance Counters</span></span>](../../../../docs/framework/data/adonet/performance-counters.md)
- [<span data-ttu-id="ee4b5-177">ADO.NET 托管提供程序和数据集开发人员中心</span><span class="sxs-lookup"><span data-stu-id="ee4b5-177">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
