---
title: 重写服务标识以便进行身份验证
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
ms.openlocfilehash: 3df1f2490f8636d52ac75fad2469adadec2a57da
ms.sourcegitcommit: 15109844229ade1c6449f48f3834db1b26907824
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2018
---
# <a name="overriding-the-identity-of-a-service-for-authentication"></a><span data-ttu-id="1244f-102">重写服务标识以便进行身份验证</span><span class="sxs-lookup"><span data-stu-id="1244f-102">Overriding the Identity of a Service for Authentication</span></span>
<span data-ttu-id="1244f-103">通常情况下不需要设置服务上的标识，因为客户端凭据类型的选择即规定了服务元数据中公开的标识的类型。</span><span class="sxs-lookup"><span data-stu-id="1244f-103">Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.</span></span> <span data-ttu-id="1244f-104">例如，下面的配置代码使用[ \<wsHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md)元素并设置`clientCredentialType`Windows 属性。</span><span class="sxs-lookup"><span data-stu-id="1244f-104">For example, the following configuration code uses the [\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.</span></span>  
  
  
  
 <span data-ttu-id="1244f-105">下面的 Web 服务描述语言 (WSDL) 片断演示前面定义的终结点的标识。</span><span class="sxs-lookup"><span data-stu-id="1244f-105">The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.</span></span> <span data-ttu-id="1244f-106">在此示例中，服务作为一个自承载服务在特定用户帐户下运行 (username@contoso.com)，因此用户主体名称 (UPN) 标识包含帐户名称。</span><span class="sxs-lookup"><span data-stu-id="1244f-106">In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name.</span></span> <span data-ttu-id="1244f-107">在 Windows 域中，UPN 也称为用户登录名。</span><span class="sxs-lookup"><span data-stu-id="1244f-107">The UPN is also known as the user logon name in a Windows domain.</span></span>  
  
  
  
 <span data-ttu-id="1244f-108">有关演示如何标识设置的示例应用，请参阅[服务标识示例](../../../../docs/framework/wcf/samples/service-identity-sample.md)。</span><span class="sxs-lookup"><span data-stu-id="1244f-108">For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md).</span></span> <span data-ttu-id="1244f-109">有关服务标识的详细信息，请参阅[服务标识和身份验证](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)。</span><span class="sxs-lookup"><span data-stu-id="1244f-109">For more information about service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
## <a name="kerberos-authentication-and-identity"></a><span data-ttu-id="1244f-110">Kerberos 身份验证和标识</span><span class="sxs-lookup"><span data-stu-id="1244f-110">Kerberos Authentication and Identity</span></span>  
 <span data-ttu-id="1244f-111">默认情况下，当服务配置为使用 Windows 凭据， [\<标识 >](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md)包含的元素[ \<userPrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md)或[ \<servicePrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md)元素生成的 WSDL 中。</span><span class="sxs-lookup"><span data-stu-id="1244f-111">By default, when a service is configured to use a Windows credential, an [\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL.</span></span> <span data-ttu-id="1244f-112">如果服务下运行`LocalSystem`， `LocalService`，或`NetworkService`帐户、 服务主体名称 (SPN) 生成的窗体在默认情况下`host/` \<*主机名*> 因为这些帐户有权访问计算机的 SPN 数据。</span><span class="sxs-lookup"><span data-stu-id="1244f-112">If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\<*hostname*> because those accounts have access to the computer's SPN data.</span></span> <span data-ttu-id="1244f-113">如果服务在不同帐户下运行，Windows Communication Foundation (WCF) 生成的形式的 UPN \<*用户名*>@<*domainName* `>`.</span><span class="sxs-lookup"><span data-stu-id="1244f-113">If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of \<*username*>@<*domainName*`>`.</span></span> <span data-ttu-id="1244f-114">发生这种情况的原因是 Kerberos 身份验证要求向客户端提供 UPN 或 SPN，以便对服务进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="1244f-114">This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.</span></span>  
  
 <span data-ttu-id="1244f-115">您还可以使用 Setspn.exe 工具向域中服务的帐户注册其他 SPN。</span><span class="sxs-lookup"><span data-stu-id="1244f-115">You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.</span></span> <span data-ttu-id="1244f-116">然后，可以使用该 SPN 作为服务的标识。</span><span class="sxs-lookup"><span data-stu-id="1244f-116">You can then use the SPN as the identity of the service.</span></span> <span data-ttu-id="1244f-117">若要下载该工具，请参阅[Windows 2000 资源工具包工具： Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752)。</span><span class="sxs-lookup"><span data-stu-id="1244f-117">To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752).</span></span> <span data-ttu-id="1244f-118">有关工具的详细信息，请参阅[Setspn 概述](http://go.microsoft.com/fwlink/?LinkId=61374)。</span><span class="sxs-lookup"><span data-stu-id="1244f-118">For more information about the tool, see [Setspn Overview](http://go.microsoft.com/fwlink/?LinkId=61374).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="1244f-119">若要使用不带协商的 Windows 凭据类型，服务的用户帐户必须有权访问向 Active Directory 域注册的 SPN。</span><span class="sxs-lookup"><span data-stu-id="1244f-119">To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.</span></span> <span data-ttu-id="1244f-120">可以使用下列方式来实现：</span><span class="sxs-lookup"><span data-stu-id="1244f-120">You can do this in the following ways:</span></span>  
  
-   <span data-ttu-id="1244f-121">使用 NetworkService 或 LocalSystem 帐户运行服务。</span><span class="sxs-lookup"><span data-stu-id="1244f-121">Use the NetworkService or LocalSystem account to run your service.</span></span> <span data-ttu-id="1244f-122">因为这些帐户有权访问的计算机在计算机连接 Active Directory 域时建立的 SPN，WCF 将自动在服务的元数据 (WSDL) 中生成服务的终结点内正确的 SPN 元素。</span><span class="sxs-lookup"><span data-stu-id="1244f-122">Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, WCF automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).</span></span>  
  
-   <span data-ttu-id="1244f-123">使用任意 Active Directory 域帐户运行服务。</span><span class="sxs-lookup"><span data-stu-id="1244f-123">Use an arbitrary Active Directory domain account to run your service.</span></span> <span data-ttu-id="1244f-124">在这种情况下，需要为该域帐户建立一个 SPN，这可以使用 Setspn.exe 实用工具来完成。</span><span class="sxs-lookup"><span data-stu-id="1244f-124">In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.</span></span> <span data-ttu-id="1244f-125">一旦创建了服务的帐户的 SPN，配置 WCF 将该 SPN 发布到通过其元数据 (WSDL) 的服务的客户端。</span><span class="sxs-lookup"><span data-stu-id="1244f-125">Once you create the SPN for the service's account, configure WCF to publish that SPN to the service's clients through its metadata (WSDL).</span></span> <span data-ttu-id="1244f-126">这可以通过为公开的终结点设置终结点标识（借助于应用程序配置文件或代码）来完成。</span><span class="sxs-lookup"><span data-stu-id="1244f-126">This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.</span></span>  
  
 <span data-ttu-id="1244f-127">有关 Spn 的详细信息、 Kerberos 协议和 Active Directory，请参阅[技术补充面向 Windows 的 Kerberos](http://go.microsoft.com/fwlink/?LinkId=88330)。</span><span class="sxs-lookup"><span data-stu-id="1244f-127">For more information about SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](http://go.microsoft.com/fwlink/?LinkId=88330).</span></span>  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a><span data-ttu-id="1244f-128">当 SPN 或 UPN 等于空字符串时</span><span class="sxs-lookup"><span data-stu-id="1244f-128">When SPN or UPN Equals the Empty String</span></span>  
 <span data-ttu-id="1244f-129">如果将 SPN 或 UPN 设置为等于空字符串，将出现多种不同的情况，具体取决于所使用的安全级别和身份验证模式：</span><span class="sxs-lookup"><span data-stu-id="1244f-129">If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:</span></span>  
  
-   <span data-ttu-id="1244f-130">如果使用传输级安全，则会选择 NT LanMan (NTLM) 身份验证。</span><span class="sxs-lookup"><span data-stu-id="1244f-130">If you are using transport level security, NT LanMan (NTLM) authentication is chosen.</span></span>  
  
-   <span data-ttu-id="1244f-131">如果使用消息级安全，则根据身份验证模式的不同，身份验证可能会失败：</span><span class="sxs-lookup"><span data-stu-id="1244f-131">If you are using message level security, authentication may fail, depending on the authentication mode:</span></span>  
  
-   <span data-ttu-id="1244f-132">如果使用 `spnego` 模式，并且 `AllowNtlm` 属性设置为 `false`，则身份验证将失败。</span><span class="sxs-lookup"><span data-stu-id="1244f-132">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.</span></span>  
  
-   <span data-ttu-id="1244f-133">在使用 `spnego` 模式并且 `AllowNtlm` 属性设置为 `true` 的情况下，如果 UPN 为空，则身份验证将失败；如果 SPN 为空，则身份验证将成功。</span><span class="sxs-lookup"><span data-stu-id="1244f-133">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.</span></span>  
  
-   <span data-ttu-id="1244f-134">如果使用 Kerberos direct（也称为“一次完成”），则身份验证将失败。</span><span class="sxs-lookup"><span data-stu-id="1244f-134">If you are using Kerberos direct (also known as "one-shot"), authentication fails.</span></span>  
  
### <a name="using-the-identity-element-in-configuration"></a><span data-ttu-id="1244f-135">使用\<标识 > 配置中的元素</span><span class="sxs-lookup"><span data-stu-id="1244f-135">Using the \<identity> Element in Configuration</span></span>  
 <span data-ttu-id="1244f-136">如果将前面演示的绑定中的客户端凭据类型更改为证书`,`，则生成的 WSDL 将包含一个 Base64 序列化 X.509 证书作为标识值，如下面的代码所示。</span><span class="sxs-lookup"><span data-stu-id="1244f-136">If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.</span></span> <span data-ttu-id="1244f-137">这是除 Windows 之外的所有客户端凭据类型的默认值。</span><span class="sxs-lookup"><span data-stu-id="1244f-137">This is the default for all client credential types other than Windows.</span></span>  
  
  
  
 <span data-ttu-id="1244f-138">通过在配置中使用 <`identity`> 元素或在代码中设置标识，可以更改默认服务标识值或更改该标识的类型。</span><span class="sxs-lookup"><span data-stu-id="1244f-138">You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code.</span></span> <span data-ttu-id="1244f-139">下面的配置代码使用值 `contoso.com` 设置域名系统 (DNS) 标识。</span><span class="sxs-lookup"><span data-stu-id="1244f-139">The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.</span></span>  
  
  
  
### <a name="setting-identity-programmatically"></a><span data-ttu-id="1244f-140">以编程方式设置标识</span><span class="sxs-lookup"><span data-stu-id="1244f-140">Setting Identity Programmatically</span></span>  
 <span data-ttu-id="1244f-141">你的服务不必显式指定标识，因为 WCF 自动确定。</span><span class="sxs-lookup"><span data-stu-id="1244f-141">Your service does not have to explicitly specify an identity, because WCF automatically determines it.</span></span> <span data-ttu-id="1244f-142">但是，WCF 允许你指定一个标识终结点，如果需要。</span><span class="sxs-lookup"><span data-stu-id="1244f-142">However, WCF allows you to specify an identity on an endpoint, if required.</span></span> <span data-ttu-id="1244f-143">下面的代码使用特定的 DNS 标识添加了一个新的服务终结点。</span><span class="sxs-lookup"><span data-stu-id="1244f-143">The following code adds a new service endpoint with a specific DNS identity.</span></span>  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a><span data-ttu-id="1244f-144">请参阅</span><span class="sxs-lookup"><span data-stu-id="1244f-144">See Also</span></span>  
 [<span data-ttu-id="1244f-145">如何：创建自定义客户端标识验证工具</span><span class="sxs-lookup"><span data-stu-id="1244f-145">How to: Create a Custom Client Identity Verifier</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)  
 [<span data-ttu-id="1244f-146">服务标识和身份验证</span><span class="sxs-lookup"><span data-stu-id="1244f-146">Service Identity and Authentication</span></span>](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)
