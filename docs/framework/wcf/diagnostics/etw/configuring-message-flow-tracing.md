---
title: 配置消息流跟踪
ms.date: 03/30/2017
ms.assetid: 15571ca2-bee2-47fb-ba10-fcbc09152ad0
ms.openlocfilehash: 02c43b152cb1aef1684185e56eb7f172036ac46b
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "61999513"
---
# <a name="configuring-message-flow-tracing"></a><span data-ttu-id="ef1ad-102">配置消息流跟踪</span><span class="sxs-lookup"><span data-stu-id="ef1ad-102">Configuring Message Flow Tracing</span></span>
<span data-ttu-id="ef1ad-103">启用 Windows Communication Foundation (WCF) 的活动跟踪后，端到端活动 Id 将分配给在整个 WCF 堆栈的逻辑活动。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-103">When Windows Communication Foundation (WCF) activity tracing is enabled, End-To-End Activity IDs are assigned to logical activities throughout the WCF stack.</span></span> <span data-ttu-id="ef1ad-104">在 [!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)] 中，此功能现在具备性能更高的版本。它与 Windows 事件跟踪 (ETW) 一起使用，称为消息流跟踪。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-104">In [!INCLUDE[netfx_current_short](../../../../../includes/netfx-current-short-md.md)], there is now a higher performance version of this feature that works with Event Tracing for Windows (ETW) called message flow tracing.</span></span> <span data-ttu-id="ef1ad-105">启用此功能时，端对端活动 ID 取自（如果为空，则分配到）传入消息，并传播到在通道解码消息之后发出的所有跟踪事件。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-105">When enabled, End-To-End activity IDs are taken from (or assigned to if empty) incoming messages and are propagated to all tracing events that are emitted after the message has been decoded by the channel.</span></span> <span data-ttu-id="ef1ad-106">客户通过此功能，可以在解码来自不同服务的跟踪日志后重新构造消息流。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-106">Customers can use this feature to reconstruct message flows with trace logs from different services after decoding.</span></span>  
  
 <span data-ttu-id="ef1ad-107">检测到应用程序存在问题后，可以启用跟踪，然后在解决问题之后立即禁用跟踪。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-107">Tracing can be enabled after a problem is detected with the application and then disabled once the problem is resolved.</span></span>  
  
## <a name="enabling-tracing"></a><span data-ttu-id="ef1ad-108">启用跟踪</span><span class="sxs-lookup"><span data-stu-id="ef1ad-108">Enabling Tracing</span></span>  
 <span data-ttu-id="ef1ad-109">通过将 .NET Framework 4 `messageFlowTracing` 配置元素设置为 `true`，可以启用消息流跟踪，如下面的示例所示。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-109">You can enable message flow tracing by setting the .NET Framework 4 `messageFlowTracing` configuration element to `true`, as shown in the following example.</span></span>  
  
```xml  
<system.servicemodel>  
  <diagnostics>  
    <endToEndTracing propagateActivity="true" messageFlowTracing="true" />  
  </diagnostics>  
</system.servicemodel>  
```  
  
> [!NOTE]
>  <span data-ttu-id="ef1ad-110">由于 `endToEndTracing` 配置元素驻留在 Web.config 文件中，因此不能采用与 ETW 一样的方法来动态配置该配置元素。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-110">Because the `endToEndTracing` configuration element resides in a Web.config file, it cannot be dynamically configured in the same way as ETW.</span></span> <span data-ttu-id="ef1ad-111">若要使 `endToEndTracing` 配置元素生效，必须回收应用程序。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-111">For the `endToEndTracing` configuration element to take effect, the application must be recycled.</span></span>  
  
 <span data-ttu-id="ef1ad-112">活动通过一个标识符（称为活动 ID）的交换进行关联。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-112">Activities are correlated by the interchange of an identifier called the activity ID.</span></span> <span data-ttu-id="ef1ad-113">此标识符是 GUID，由 System.Diagnostics.CorrelationManager 类生成。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-113">This identifier is a GUID, and is generated by the System.Diagnostics.CorrelationManager class.</span></span> <span data-ttu-id="ef1ad-114">如果你操作 System.Diagnostics.Trace.CorrelationManager.ActivityID，请确保在执行控制传输回 WCF 代码时，值设置为原始值。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-114">If you manipulate System.Diagnostics.Trace.CorrelationManager.ActivityID, ensure that the value is set to original when execution control transfers back to WCF code.</span></span>  <span data-ttu-id="ef1ad-115">此外，如果您使用异步 WCF 编程模型，请确保在线程之间传输 System.Diagnostics.Trace.CorrelationManager.ActivityID。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-115">Also, if you use an asynchronous WCF programming model ensure that System.Diagnostics.Trace.CorrelationManager.ActivityID is transferred between the threads.</span></span>  
  
## <a name="message-flow-tracing-and-rest-services"></a><span data-ttu-id="ef1ad-116">消息流跟踪和 REST 服务</span><span class="sxs-lookup"><span data-stu-id="ef1ad-116">Message Flow Tracing and REST Services</span></span>  
 <span data-ttu-id="ef1ad-117">消息流跟踪使您能够端对端跟踪请求。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-117">Message flow tracing allows you to trace a request end to end.</span></span>  <span data-ttu-id="ef1ad-118">借助于基于 SOAP 的服务，将在 SOAP 消息标头中发送活动 ID。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-118">With SOAP-based services an Activity ID is sent in a SOAP message header.</span></span> <span data-ttu-id="ef1ad-119">REST 请求不包含此标头，因此改用特殊的 HTTP 事件标头。</span><span class="sxs-lookup"><span data-stu-id="ef1ad-119">REST requests do not contain this header so a special HTTP event header is used instead.</span></span> <span data-ttu-id="ef1ad-120">下面的代码段演示如何以编程方式检索活动 ID的值：</span><span class="sxs-lookup"><span data-stu-id="ef1ad-120">The following code snippet shows how you can programmatically retrieve the Activity ID value:</span></span>  
  
```csharp
Object output = null;
if (OperationContext.Current.IncomingMessageProperties.TryGetValue(HttpRequestMessageProperty.Name, out output))
{
   HttpRequestMessageProperty httpHeaders = output as HttpRequestMessageProperty;
   // Retrieve the Activity Id from the HTTP header    string e2eId = httpHeaders.Headers["E2EActivity"];
   // ...
}
```

 <span data-ttu-id="ef1ad-121">你可以使用下面的代码，以编程方式添加标头：</span><span class="sxs-lookup"><span data-stu-id="ef1ad-121">You can programmatically add the header using the following code:</span></span>  
  
```csharp  
HttpContent content = new StreamContent(contentStream);  
Guid correlation = Guid.NewGuid();  
content.Headers.Add("E2EActivity", Convert.ToBase64String(correlation.ToByteArray()));  
```
