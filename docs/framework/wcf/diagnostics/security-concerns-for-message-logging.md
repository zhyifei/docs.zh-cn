---
title: 消息日志记录的安全问题
ms.date: 03/30/2017
ms.assetid: 21f513f2-815b-47f3-85a6-03c008510038
author: BrucePerlerMS
manager: mbaldwin
ms.openlocfilehash: 6da641ec5da20c80f4c1034ded8a3be7d036b5a8
ms.sourcegitcommit: c7f3e2e9d6ead6cc3acd0d66b10a251d0c66e59d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/08/2018
ms.locfileid: "44185975"
---
# <a name="security-concerns-for-message-logging"></a><span data-ttu-id="8f941-102">消息日志记录的安全问题</span><span class="sxs-lookup"><span data-stu-id="8f941-102">Security Concerns for Message Logging</span></span>
<span data-ttu-id="8f941-103">本主题描述如何防止在消息日志以及由消息日志记录生成的事件中公开敏感数据。</span><span class="sxs-lookup"><span data-stu-id="8f941-103">This topic describes how you can protect sensitive data from being exposed in message logs, as well as events generated by message logging.</span></span>  
  
## <a name="security-concerns"></a><span data-ttu-id="8f941-104">安全问题</span><span class="sxs-lookup"><span data-stu-id="8f941-104">Security Concerns</span></span>  
  
### <a name="logging-sensitive-information"></a><span data-ttu-id="8f941-105">记录敏感信息</span><span class="sxs-lookup"><span data-stu-id="8f941-105">Logging Sensitive Information</span></span>  
 <span data-ttu-id="8f941-106">Windows Communication Foundation (WCF) 不会修改特定于应用程序的标头和正文中的任何数据。</span><span class="sxs-lookup"><span data-stu-id="8f941-106">Windows Communication Foundation (WCF) does not modify any data in application-specific headers and body.</span></span> <span data-ttu-id="8f941-107">WCF 还不跟踪特定于应用程序的标头或正文数据中的个人信息。</span><span class="sxs-lookup"><span data-stu-id="8f941-107">WCF also does not track personal information in application-specific headers or body data.</span></span>  
  
 <span data-ttu-id="8f941-108">启用消息日志记录后，特定于应用程序的标头中的个人信息（例如查询字符串）以及正文信息（例如信用卡号）会在日志中变为可见。</span><span class="sxs-lookup"><span data-stu-id="8f941-108">When message logging is enabled, personal information in application-specific headers, such as, a query string; and body information, such as, a credit card number, can become visible in the logs.</span></span> <span data-ttu-id="8f941-109">应用程序部署人员负责对配置和日志文件实施访问控制。</span><span class="sxs-lookup"><span data-stu-id="8f941-109">The application deployer is responsible for enforcing access control on the configuration and log files.</span></span> <span data-ttu-id="8f941-110">如果您不希望此类信息可见，应当禁用日志记录，或者如果您希望共享日志，则筛选出其中的部分数据。</span><span class="sxs-lookup"><span data-stu-id="8f941-110">If you do not want this kind of information to be visible, you should disable logging, or filter out part of the data if you want to share the logs.</span></span>  
  
 <span data-ttu-id="8f941-111">下面的提示有助于您避免意外公开日志文件的内容：</span><span class="sxs-lookup"><span data-stu-id="8f941-111">The following tips can help you to prevent the content of a log file from being exposed unintentionally:</span></span>  
  
-   <span data-ttu-id="8f941-112">确保在 Web 承载和自承载方案中都使用访问控制列表 (ACL) 对日志文件进行保护。</span><span class="sxs-lookup"><span data-stu-id="8f941-112">Ensure that the log files are protected by Access Control Lists (ACL) both in Web-host and self-host scenarios.</span></span>  
  
-   <span data-ttu-id="8f941-113">选择无法使用 Web 请求轻松提供的文件扩展名。</span><span class="sxs-lookup"><span data-stu-id="8f941-113">Choose a file extension that cannot be easily served using a Web request.</span></span> <span data-ttu-id="8f941-114">例如，.xml 文件扩展名不是一个安全的选择。</span><span class="sxs-lookup"><span data-stu-id="8f941-114">For example, the .xml file extension is not a safe choice.</span></span> <span data-ttu-id="8f941-115">可以参考 Internet 信息服务 (IIS) 管理指南以查看可提供的扩展名的列表。</span><span class="sxs-lookup"><span data-stu-id="8f941-115">You can check the Internet Information Services (IIS) administration guide to see a list of extensions that can be served.</span></span>  
  
-   <span data-ttu-id="8f941-116">为日志文件位置指定绝对路径，该位置应当在 Web 主机虚拟根目录公共目录之外，以防止外部方使用 Web 浏览器进行访问。</span><span class="sxs-lookup"><span data-stu-id="8f941-116">Specify an absolute path for the log file location, which should be outside of the Web host vroot public directory to prevent it from being accessed by an external party using a Web browser.</span></span>  
  
 <span data-ttu-id="8f941-117">默认情况下，不会在跟踪和已记录消息中记录密钥和个人身份信息 (PII)（例如用户名和密码）。</span><span class="sxs-lookup"><span data-stu-id="8f941-117">By default, keys and personally identifiable information (PII) such as username and password are not logged in traces and logged messages.</span></span> <span data-ttu-id="8f941-118">但是，计算机管理员可以在 Machine.config 文件的 `enableLoggingKnownPII` 元素中使用 `machineSettings` 属性来允许计算机上运行的应用程序记录已知的个人身份信息 (PII)。</span><span class="sxs-lookup"><span data-stu-id="8f941-118">A machine administrator, however, can use the `enableLoggingKnownPII` attribute in the `machineSettings` element of the Machine.config file to permit applications running on the machine to log known personally identifiable information (PII).</span></span> <span data-ttu-id="8f941-119">下面的配置演示如何执行该操作：</span><span class="sxs-lookup"><span data-stu-id="8f941-119">The following configuration demonstrates how to do this:</span></span>  
  
```xml  
<configuration>  
   <system.serviceModel>  
      <machineSettings enableLoggingKnownPii="true"/>  
   </system.serviceModel>  
</configuration>   
```  
  
 <span data-ttu-id="8f941-120">应用程序部署人员然后可以使用 App.config 或 Web.config 文件中的 `logKnownPii` 属性来启用 PII 日志记录，如下所示：</span><span class="sxs-lookup"><span data-stu-id="8f941-120">An application deployer can then use the `logKnownPii` attribute in either the App.config or Web.config file to enable PII logging as follows:</span></span>  
  
```xml  
<system.diagnostics>  
  <sources>  
      <source name="System.ServiceModel.MessageLogging"  
        logKnownPii="true">  
        <listeners>  
                 <add name="messages"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="c:\logs\messages.svclog" />  
          </listeners>  
      </source>  
    </sources>  
</system.diagnostics>  
```  
  
 <span data-ttu-id="8f941-121">只有当两个设置都为 `true` 时，才会启用 PII 日志记录。</span><span class="sxs-lookup"><span data-stu-id="8f941-121">Only when both settings are `true` is PII logging enabled.</span></span> <span data-ttu-id="8f941-122">两个开关的组合为记录每个应用程序的已知 PII 带来了很大的灵活性。</span><span class="sxs-lookup"><span data-stu-id="8f941-122">The combination of two switches allows the flexibility to log known PII for each application.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="8f941-123">在 [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] 中，`logEntireMessage` 和 `logKnownPii` 标志还必须在 Web.config 文件或 App.config 文件中设置为 `true` 以启用 PII 日志记录，如下面的示例 `<system.serviceModel><messageLogging logEntireMessage="true" logKnownPii="true" …` 所示。</span><span class="sxs-lookup"><span data-stu-id="8f941-123">In [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] the `logEntireMessage` and `logKnownPii` flags must also be set to `true` in the Web.config file or the App.config file to enable PII logging, as show in the following example `<system.serviceModel><messageLogging logEntireMessage="true" logKnownPii="true" …`.</span></span>  
  
 <span data-ttu-id="8f941-124">您应当注意，如果在一个配置文件中指定了两个或更多自定义源，则只读取第一个源的特性，</span><span class="sxs-lookup"><span data-stu-id="8f941-124">You should be aware that if you specify two or more custom sources in a configuration file, only the attributes of the first source are read.</span></span> <span data-ttu-id="8f941-125">而忽略其他源的属性。</span><span class="sxs-lookup"><span data-stu-id="8f941-125">The others are ignored.</span></span> <span data-ttu-id="8f941-126">这意味着，对于以下 App.config 文件，即使已为第二个源显式启用了 PII 日志记录，也不会同时为这两个源记录 PII。</span><span class="sxs-lookup"><span data-stu-id="8f941-126">This means that, for the following App.config, file, PII is not logged for both sources even though PII logging is explicitly enabled for the second source.</span></span>  
  
```xml  
<system.diagnostics>  
   <sources>  
      <source name="System.ServiceModel.MessageLogging"  
              logKnownPii="false">  
              <listeners>  
                 <add name="messages"  
                      type="System.Diagnostics.XmlWriterTraceListener"  
                      initializeData="c:\logs\messages.svclog" />  
              </listeners>  
            </source>  
      <source name="System.ServiceModel"   
              logKnownPii="true">  
              <listeners>  
                 <add name="traces"  
                      type="System.Diagnostics.XmlWriterTraceListener"  
                      initializeData="c:\logs\traces.svclog" />  
              </listeners>  
      </source>  
   </sources>  
</system.diagnostics>  
```  
  
 <span data-ttu-id="8f941-127">如果 `<machineSettings enableLoggingKnownPii="Boolean"/>`<xref:System.Configuration.ConfigurationErrorsException> 元素不在 Machine.config 文件中，则系统引发。</span><span class="sxs-lookup"><span data-stu-id="8f941-127">If the `<machineSettings enableLoggingKnownPii="Boolean"/>` element exists outside the Machine.config file, the system throws a <xref:System.Configuration.ConfigurationErrorsException>.</span></span>  
  
 <span data-ttu-id="8f941-128">只有当应用程序启动或重新启动之后，更改才有效。</span><span class="sxs-lookup"><span data-stu-id="8f941-128">The changes are effective only when the application starts or restarts.</span></span> <span data-ttu-id="8f941-129">在两个属性都设置为 `true` 的情况下，会在启动时记录一个事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-129">An event is logged at startup when both attributes are set to `true`.</span></span> <span data-ttu-id="8f941-130">如果 `logKnownPii` 设置为 `true` 但 `enableLoggingKnownPii` 设置为 `false`，也会记录一个事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-130">An event is also logged if `logKnownPii` is set to `true` but `enableLoggingKnownPii` is `false`.</span></span>  
  
 <span data-ttu-id="8f941-131">计算机管理员和应用程序部署人员应谨慎使用这两个开关。</span><span class="sxs-lookup"><span data-stu-id="8f941-131">The machine administrator and application deployer should exercise extreme caution when using these two switches.</span></span> <span data-ttu-id="8f941-132">如果启用了 PII 日志记录，则会记录安全密钥和 PII。</span><span class="sxs-lookup"><span data-stu-id="8f941-132">If PII logging is enabled, security keys and PII are logged.</span></span> <span data-ttu-id="8f941-133">如果禁用了 PII 日志记录，仍会在消息头和正文中记录敏感数据和特定于应用程序的数据。</span><span class="sxs-lookup"><span data-stu-id="8f941-133">If it is disabled, sensitive and application-specific data is still logged in message headers and bodies.</span></span> <span data-ttu-id="8f941-134">有关隐私以及防止公开 PII 的更深入讨论，请参阅[用户隐私](https://go.microsoft.com/fwlink/?LinkID=94647)。</span><span class="sxs-lookup"><span data-stu-id="8f941-134">For a more thorough discussion about privacy and protecting PII from being exposed, see [User Privacy](https://go.microsoft.com/fwlink/?LinkID=94647).</span></span>  
  
> [!CAUTION]
>  <span data-ttu-id="8f941-135">在格式不正确的消息中不会隐藏 PII。</span><span class="sxs-lookup"><span data-stu-id="8f941-135">PII is not hidden in malformed messages.</span></span> <span data-ttu-id="8f941-136">这样的消息按原样记录，不进行任何修改。</span><span class="sxs-lookup"><span data-stu-id="8f941-136">Such messaged are logged as-is without any modification.</span></span> <span data-ttu-id="8f941-137">前面提到的属性对此没有影响。</span><span class="sxs-lookup"><span data-stu-id="8f941-137">Attributes mentioned previously have no effect on this.</span></span>  
  
### <a name="custom-trace-listener"></a><span data-ttu-id="8f941-138">自定义跟踪侦听器</span><span class="sxs-lookup"><span data-stu-id="8f941-138">Custom Trace Listener</span></span>  
 <span data-ttu-id="8f941-139">在消息日志记录跟踪源上添加定义跟踪侦听器是一种只限于管理员的特权。</span><span class="sxs-lookup"><span data-stu-id="8f941-139">Adding a custom trace listener on the Message Logging trace source is a privilege that should be restricted to the administrator.</span></span> <span data-ttu-id="8f941-140">这是因为恶意自定义侦听器可以配置为远程发送消息，从而导致敏感信息泄漏。</span><span class="sxs-lookup"><span data-stu-id="8f941-140">This is because malicious custom listeners can be configured to send messages remotely, which leads to sensitive information disclosure.</span></span> <span data-ttu-id="8f941-141">此外，如果您将自定义侦听器配置为在网络上发送消息（例如发送到远程数据库），您应该对远程计算机上的消息日志施加适当的访问控制。</span><span class="sxs-lookup"><span data-stu-id="8f941-141">In addition, if you configure a custom listener to send messages on the wire, such as, to a remote database, you should enforce proper access control on the message logs in the remote machine.</span></span>  
  
## <a name="events-triggered-by-message-logging"></a><span data-ttu-id="8f941-142">消息日志记录触发的事件</span><span class="sxs-lookup"><span data-stu-id="8f941-142">Events Triggered by Message Logging</span></span>  
 <span data-ttu-id="8f941-143">下面列出了消息日志记录发出的所有事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-143">The following lists all the events emitted by message logging.</span></span>  
  
-   <span data-ttu-id="8f941-144">启用消息日志记录：当在配置中或通过 WMI 启用消息日志记录时发出此事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-144">Message logging on: This event is emitted when message logging is enabled in configuration, or through WMI.</span></span> <span data-ttu-id="8f941-145">此事件的内容是“消息日志记录已打开。</span><span class="sxs-lookup"><span data-stu-id="8f941-145">The content of the event is "Message logging has been turned on.</span></span> <span data-ttu-id="8f941-146">将记录敏感信息，即使已在网络上对其进行加密: 例如，消息正文。”</span><span class="sxs-lookup"><span data-stu-id="8f941-146">Sensitive information may be logged in clear text, even if they were encrypted on the wire, for example, message bodies."</span></span>  
  
-   <span data-ttu-id="8f941-147">禁用消息日志记录：当通过 WMI 禁用消息日志记录时发出此事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-147">Message logging off: This event is emitted when message logging is disabled through WMI.</span></span> <span data-ttu-id="8f941-148">此事件的内容是“消息日志记录已关闭”。</span><span class="sxs-lookup"><span data-stu-id="8f941-148">The content of the event is "Message logging has been turned off."</span></span>  
  
-   <span data-ttu-id="8f941-149">启用记录已知 PII：当启用记录已知 PII 时发出此事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-149">Log Known PII On: This event is emitted when logging of known PII is enabled.</span></span> <span data-ttu-id="8f941-150">发生这种情况时`enableLoggingKnownPii`中的属性`machineSettings`Machine.config 文件的元素设置为`true`，和`logKnownPii`属性的`source`App.config 或 Web.config 文件中的元素设置为`true`.</span><span class="sxs-lookup"><span data-stu-id="8f941-150">This happens when the `enableLoggingKnownPii` attribute in the `machineSettings` element of the Machine.config file is set to `true`, and the `logKnownPii` attribute of the `source` element in either the App.config or Web.config file is set to `true`.</span></span>  
  
-   <span data-ttu-id="8f941-151">不允许记录已知 PII：当不允许记录已知 PII 时发出此事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-151">Log Known PII Not Allowed: This event is emitted when logging of known PII is not allowed.</span></span> <span data-ttu-id="8f941-152">发生这种情况时`logKnownPii`的属性`source`App.config 或 Web.config 文件中的元素设置为`true`，但`enableLoggingKnownPii`属性中`machineSettings`Machine.config 文件的元素设置为`false`.</span><span class="sxs-lookup"><span data-stu-id="8f941-152">This happens when the `logKnownPii` attribute of the `source` element in either the App.config or Web.config file is set to `true`, but the `enableLoggingKnownPii` attribute in the `machineSettings` element of the Machine.config file is set to `false`.</span></span> <span data-ttu-id="8f941-153">不引发异常。</span><span class="sxs-lookup"><span data-stu-id="8f941-153">No exception is thrown.</span></span>  
  
 <span data-ttu-id="8f941-154">可以在 Windows 附带的事件查看器工具中查看这些事件。</span><span class="sxs-lookup"><span data-stu-id="8f941-154">These events can be viewed in the Event Viewer tool that comes with Windows.</span></span> <span data-ttu-id="8f941-155">有关这方面的详细信息，请参阅[事件日志记录](../../../../docs/framework/wcf/diagnostics/event-logging/index.md)。</span><span class="sxs-lookup"><span data-stu-id="8f941-155">For more information on this, see [Event Logging](../../../../docs/framework/wcf/diagnostics/event-logging/index.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8f941-156">请参阅</span><span class="sxs-lookup"><span data-stu-id="8f941-156">See Also</span></span>  
 [<span data-ttu-id="8f941-157">消息日志记录</span><span class="sxs-lookup"><span data-stu-id="8f941-157">Message Logging</span></span>](../../../../docs/framework/wcf/diagnostics/message-logging.md)  
 [<span data-ttu-id="8f941-158">有关跟踪的安全注意事项和有用提示</span><span class="sxs-lookup"><span data-stu-id="8f941-158">Security Concerns and Useful Tips for Tracing</span></span>](../../../../docs/framework/wcf/diagnostics/tracing/security-concerns-and-useful-tips-for-tracing.md)
