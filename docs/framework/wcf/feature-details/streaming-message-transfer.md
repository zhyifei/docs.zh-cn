---
title: 流消息传输
ms.date: 03/30/2017
ms.assetid: 72a47a51-e5e7-4b76-b24a-299d51e0ae5a
ms.openlocfilehash: e58b0ce698df310a5e18bcd24201fb2e27a9c1aa
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59136872"
---
# <a name="streaming-message-transfer"></a><span data-ttu-id="e9f01-102">流消息传输</span><span class="sxs-lookup"><span data-stu-id="e9f01-102">Streaming Message Transfer</span></span>
<span data-ttu-id="e9f01-103">Windows Communication Foundation (WCF) 传输来传输消息支持两种模式：</span><span class="sxs-lookup"><span data-stu-id="e9f01-103">Windows Communication Foundation (WCF) transports support two modes for transferring messages:</span></span>  
  
-   <span data-ttu-id="e9f01-104">缓冲传输将整个消息保留在内存缓冲区中，直到传输完成。</span><span class="sxs-lookup"><span data-stu-id="e9f01-104">Buffered transfers hold the entire message in a memory buffer until the transfer is complete.</span></span> <span data-ttu-id="e9f01-105">必须完整传递缓冲的消息，接收方才能读取该消息。</span><span class="sxs-lookup"><span data-stu-id="e9f01-105">A buffered message must be completely delivered before a receiver can read it.</span></span>  
  
-   <span data-ttu-id="e9f01-106">流传输以流的形式公开消息。</span><span class="sxs-lookup"><span data-stu-id="e9f01-106">Streamed transfers expose the message as a stream.</span></span> <span data-ttu-id="e9f01-107">接收方在消息完整传递之前即可开始处理消息。</span><span class="sxs-lookup"><span data-stu-id="e9f01-107">The receiver starts processing the message before it is completely delivered.</span></span>  
  
-   <span data-ttu-id="e9f01-108">流传输消除了对大型内存缓冲区的要求，从而提高了服务的可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="e9f01-108">Streamed transfers can improve the scalability of a service by eliminating the requirement for large memory buffers.</span></span> <span data-ttu-id="e9f01-109">更改传输模式是否能够提高可伸缩性取决于所传输的消息大小。</span><span class="sxs-lookup"><span data-stu-id="e9f01-109">Whether changing the transfer mode improves scalability depends on the size of the messages being transferred.</span></span> <span data-ttu-id="e9f01-110">消息大小越大，使用流传输越有利。</span><span class="sxs-lookup"><span data-stu-id="e9f01-110">Large message sizes favor using streamed transfers.</span></span>  
  
 <span data-ttu-id="e9f01-111">默认情况下，HTTP、TCP/IP 和命名管道传输协议使用缓冲传输。</span><span class="sxs-lookup"><span data-stu-id="e9f01-111">By default, the HTTP, TCP/IP, and named pipe transports use buffered transfers.</span></span> <span data-ttu-id="e9f01-112">本文档介绍如何将这些传输协议从缓冲传输模式切换到流传输模式以及这样做的结果。</span><span class="sxs-lookup"><span data-stu-id="e9f01-112">This document describes how to switch these transports from a buffered to streamed transfer mode and the consequences of doing so.</span></span>  
  
## <a name="enabling-streamed-transfers"></a><span data-ttu-id="e9f01-113">启用流传输</span><span class="sxs-lookup"><span data-stu-id="e9f01-113">Enabling Streamed Transfers</span></span>  
 <span data-ttu-id="e9f01-114">在缓冲和流传输模式之间进行选择是在传输协议的绑定元素上完成的。</span><span class="sxs-lookup"><span data-stu-id="e9f01-114">Selecting between buffered and streamed transfer modes is done on the binding element of the transport.</span></span> <span data-ttu-id="e9f01-115">该绑定元素具有一个 <xref:System.ServiceModel.TransferMode> 属性，该属性可以设置为 `Buffered`、`Streamed`、`StreamedRequest` 或 `StreamedResponse`。</span><span class="sxs-lookup"><span data-stu-id="e9f01-115">The binding element has a <xref:System.ServiceModel.TransferMode> property that can be set to `Buffered`, `Streamed`, `StreamedRequest`, or `StreamedResponse`.</span></span> <span data-ttu-id="e9f01-116">将传输模式设置为 `Streamed` 将在两个方向上启用流通信。</span><span class="sxs-lookup"><span data-stu-id="e9f01-116">Setting the transfer mode to `Streamed` enables streaming communication in both directions.</span></span> <span data-ttu-id="e9f01-117">将传输模式设置为 `StreamedRequest` 或 `StreamedResponse` 将仅在指示的方向上启用流通信。</span><span class="sxs-lookup"><span data-stu-id="e9f01-117">Setting the transfer mode to `StreamedRequest` or `StreamedResponse` enables streaming communication in the indicated direction only.</span></span>  
  
 <span data-ttu-id="e9f01-118"><xref:System.ServiceModel.BasicHttpBinding>、<xref:System.ServiceModel.NetTcpBinding> 和 <xref:System.ServiceModel.NetNamedPipeBinding> 绑定公开了 <xref:System.ServiceModel.TransferMode> 属性。</span><span class="sxs-lookup"><span data-stu-id="e9f01-118">The <xref:System.ServiceModel.BasicHttpBinding>, <xref:System.ServiceModel.NetTcpBinding>, and <xref:System.ServiceModel.NetNamedPipeBinding> bindings expose the <xref:System.ServiceModel.TransferMode> property.</span></span> <span data-ttu-id="e9f01-119">对于其他传输，必须创建一个自定义绑定以设置传输模式。</span><span class="sxs-lookup"><span data-stu-id="e9f01-119">For other transports, you must create a custom binding to set the transfer mode.</span></span>  
  
 <span data-ttu-id="e9f01-120">使用缓冲传输还是流传输是在终结点本地决定的。</span><span class="sxs-lookup"><span data-stu-id="e9f01-120">The decision to use either buffered or streamed transfers is a local decision of the endpoint.</span></span> <span data-ttu-id="e9f01-121">对于 HTTP 传输协议，传输模式不会跨连接传播，也不会传播到服务器和其他中介。</span><span class="sxs-lookup"><span data-stu-id="e9f01-121">For HTTP transports, the transfer mode does not propagate across a connection, or to servers and other intermediaries.</span></span> <span data-ttu-id="e9f01-122">设置传输模式不会反映在服务接口的说明中。</span><span class="sxs-lookup"><span data-stu-id="e9f01-122">Setting the transfer mode is not reflected in the description of the service interface.</span></span> <span data-ttu-id="e9f01-123">在为服务生成一个客户端类后，必须为准备用于流传输的服务编辑配置文件，以设置该传输模式。</span><span class="sxs-lookup"><span data-stu-id="e9f01-123">After generating a client class for a service, you must edit the configuration file for services intended to be used with streamed transfers to set the mode.</span></span> <span data-ttu-id="e9f01-124">对于 TCP 和命名管道传输协议，该传输模式将作为策略断言传播。</span><span class="sxs-lookup"><span data-stu-id="e9f01-124">For TCP and named pipe transports, the transfer mode is propagated as a policy assertion.</span></span>  
  
 <span data-ttu-id="e9f01-125">有关代码示例，请参阅[如何：启用流式传输](../../../../docs/framework/wcf/feature-details/how-to-enable-streaming.md)。</span><span class="sxs-lookup"><span data-stu-id="e9f01-125">For code samples, see [How to: Enable Streaming](../../../../docs/framework/wcf/feature-details/how-to-enable-streaming.md).</span></span>  
  
## <a name="enabling-asynchronous-streaming"></a><span data-ttu-id="e9f01-126">启用异步流处理</span><span class="sxs-lookup"><span data-stu-id="e9f01-126">Enabling Asynchronous Streaming</span></span>  
 <span data-ttu-id="e9f01-127">若要启用异步流，请将 <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior> 终结点行为添加到服务主机，并将其 <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.AsynchronousSendEnabled%2A> 属性设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="e9f01-127">To enable asynchronous streaming, add the  <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior> endpoint behavior to the service host and set its <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.AsynchronousSendEnabled%2A> property to `true`.</span></span>  
  
 <span data-ttu-id="e9f01-128">此版本的 WCF 还在发送端添加真正异步流处理的能力。</span><span class="sxs-lookup"><span data-stu-id="e9f01-128">This version of WCF also adde the capability of true asynchronous streaming on the send side.</span></span> <span data-ttu-id="e9f01-129">在将消息流式处理到多个客户端的方案中，这可提高服务的可扩展性；其中某些客户端的读取速度较慢，这可能由于网络拥塞或根本无法阅读造成的。</span><span class="sxs-lookup"><span data-stu-id="e9f01-129">This improves scalability of the service in scenarios where it is streaming messages to multiple clients some of which are slow in reading; possibly due to network congestion or are not reading at all.</span></span> <span data-ttu-id="e9f01-130">在这些方案中，WCF 不再因每个客户端的服务阻止各个线程。</span><span class="sxs-lookup"><span data-stu-id="e9f01-130">In these scenarios WCF no longer blocks individual threads on the service per client.</span></span> <span data-ttu-id="e9f01-131">这确保服务能够处理多得多的客户端，进而提高服务的可扩展性。</span><span class="sxs-lookup"><span data-stu-id="e9f01-131">This ensures that the service is able to process many more clients thereby improving the scalability of the service.</span></span>  
  
## <a name="restrictions-on-streamed-transfers"></a><span data-ttu-id="e9f01-132">流传输的限制</span><span class="sxs-lookup"><span data-stu-id="e9f01-132">Restrictions on Streamed Transfers</span></span>  
 <span data-ttu-id="e9f01-133">使用流传输模式会导致运行库实施附加限制。</span><span class="sxs-lookup"><span data-stu-id="e9f01-133">Using the streamed transfer mode causes the run time to enforce additional restrictions.</span></span>  
  
 <span data-ttu-id="e9f01-134">在整个流传输中发生的操作最多只能与一个输入或输出参数之间具有协定。</span><span class="sxs-lookup"><span data-stu-id="e9f01-134">Operations that occur across a streamed transport can have a contract with at most one input or output parameter.</span></span> <span data-ttu-id="e9f01-135">该参数对应于整个消息正文，并且必须为 <xref:System.ServiceModel.Channels.Message>、<xref:System.IO.Stream> 的派生类型或 <xref:System.Xml.Serialization.IXmlSerializable> 实现。</span><span class="sxs-lookup"><span data-stu-id="e9f01-135">That parameter corresponds to the entire body of the message and must be a <xref:System.ServiceModel.Channels.Message>, a derived type of <xref:System.IO.Stream>, or an <xref:System.Xml.Serialization.IXmlSerializable> implementation.</span></span> <span data-ttu-id="e9f01-136">具有某个操作的返回值等效于具有一个输出参数。</span><span class="sxs-lookup"><span data-stu-id="e9f01-136">Having a return value for an operation is equivalent to having an output parameter.</span></span>  
  
 <span data-ttu-id="e9f01-137">某些 WCF 功能，例如可靠消息传递、 事务和 SOAP 消息级安全性依赖于缓冲消息以便进行传输。</span><span class="sxs-lookup"><span data-stu-id="e9f01-137">Some WCF features, such as reliable messaging, transactions, and SOAP message-level security, rely on buffering messages for transmissions.</span></span> <span data-ttu-id="e9f01-138">使用这些功能可能减小或消除通过使用流获得的性能好处。</span><span class="sxs-lookup"><span data-stu-id="e9f01-138">Using these features may reduce or eliminate the performance benefits gained by using streaming.</span></span> <span data-ttu-id="e9f01-139">若要保证流传输的安全，请只使用传输级安全，或者使用传输级安全外加仅进行身份验证的消息安全。</span><span class="sxs-lookup"><span data-stu-id="e9f01-139">To secure a streamed transport, use transport-level security only or use transport-level security plus authentication-only message security.</span></span>  
  
 <span data-ttu-id="e9f01-140">即使传输模式设置为流模式，SOAP 标头也总是被缓冲。</span><span class="sxs-lookup"><span data-stu-id="e9f01-140">SOAP headers are always buffered, even when the transfer mode is set to streamed.</span></span> <span data-ttu-id="e9f01-141">消息的标头不得超出 `MaxBufferSize` 传输配额的大小。</span><span class="sxs-lookup"><span data-stu-id="e9f01-141">The headers for a message must not exceed the size of the `MaxBufferSize` transport quota.</span></span> <span data-ttu-id="e9f01-142">有关此设置的详细信息，请参阅[传输配额](../../../../docs/framework/wcf/feature-details/transport-quotas.md)。</span><span class="sxs-lookup"><span data-stu-id="e9f01-142">For more information about this setting, see [Transport Quotas](../../../../docs/framework/wcf/feature-details/transport-quotas.md).</span></span>  
  
## <a name="differences-between-buffered-and-streamed-transfers"></a><span data-ttu-id="e9f01-143">缓冲传输和流传输之间的差异</span><span class="sxs-lookup"><span data-stu-id="e9f01-143">Differences Between Buffered and Streamed Transfers</span></span>  
 <span data-ttu-id="e9f01-144">将传输模式从缓冲模式更改为流模式还会更改 TCP 和命名管道传输协议的本机通道形状。</span><span class="sxs-lookup"><span data-stu-id="e9f01-144">Changing the transfer mode from buffered to streamed also changes the native channel shape of the TCP and named pipe transports.</span></span> <span data-ttu-id="e9f01-145">对于缓冲传输模式，本机通道形状为 <xref:System.ServiceModel.Channels.IDuplexSessionChannel>。</span><span class="sxs-lookup"><span data-stu-id="e9f01-145">For buffered transfers, the native channel shape is <xref:System.ServiceModel.Channels.IDuplexSessionChannel>.</span></span> <span data-ttu-id="e9f01-146">对于流传输模式，本机通道为 <xref:System.ServiceModel.Channels.IRequestChannel> 和 <xref:System.ServiceModel.Channels.IReplyChannel>。</span><span class="sxs-lookup"><span data-stu-id="e9f01-146">For streamed transfers, the native channels are <xref:System.ServiceModel.Channels.IRequestChannel> and <xref:System.ServiceModel.Channels.IReplyChannel>.</span></span> <span data-ttu-id="e9f01-147">在直接（即，不是通过服务协定）使用这些传输协议的现有应用程序中更改传输模式需要更改通道工厂和侦听器的预期通道形状。</span><span class="sxs-lookup"><span data-stu-id="e9f01-147">Changing the transfer mode in an existing application that uses these transports directly (that is, not through a service contract) requires changing the expected channel shape for channel factories and listeners.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e9f01-148">请参阅</span><span class="sxs-lookup"><span data-stu-id="e9f01-148">See also</span></span>

- [<span data-ttu-id="e9f01-149">如何：启用流式传输</span><span class="sxs-lookup"><span data-stu-id="e9f01-149">How to: Enable Streaming</span></span>](../../../../docs/framework/wcf/feature-details/how-to-enable-streaming.md)
