---
title: 工作流服务主机可扩展性
ms.date: 03/30/2017
ms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f
ms.openlocfilehash: 6541558601c8f5daf255f2e7e5d774e41b59be2d
ms.sourcegitcommit: fb78d8abbdb87144a3872cf154930157090dd933
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/26/2018
ms.locfileid: "47200422"
---
# <a name="workflow-service-host-extensibility"></a><span data-ttu-id="2df08-102">工作流服务主机可扩展性</span><span class="sxs-lookup"><span data-stu-id="2df08-102">Workflow Service Host Extensibility</span></span>
[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]<span data-ttu-id="2df08-103">提供用于承载工作流服务的 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 类。</span><span class="sxs-lookup"><span data-stu-id="2df08-103"> provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services.</span></span> <span data-ttu-id="2df08-104">当在托管应用程序或 Windows 服务中自承载工作流服务时，将使用该类。</span><span class="sxs-lookup"><span data-stu-id="2df08-104">This class is used when you are self-hosting a workflow service in a managed application or a Windows service.</span></span> <span data-ttu-id="2df08-105">同样，当使用 Internet 信息服务 (IIS) 或 Windows 进程激活服务 (WAS) 承载工作流服务时，也将使用该类。</span><span class="sxs-lookup"><span data-stu-id="2df08-105">This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS).</span></span> <span data-ttu-id="2df08-106">通过 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 类提供的扩展点，您可以添加自定义扩展、更改空闲行为以及承载非服务工作流（即不使用消息传递活动的工作流）。</span><span class="sxs-lookup"><span data-stu-id="2df08-106">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).</span></span>  
  
## <a name="workflow-service-host-extensions"></a><span data-ttu-id="2df08-107">工作流服务主机扩展</span><span class="sxs-lookup"><span data-stu-id="2df08-107">Workflow Service Host Extensions</span></span>  
 <span data-ttu-id="2df08-108"><xref:System.ServiceModel.Activities.WorkflowServiceHost> 包含一个 <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> 类型的 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> 属性，该属性提供向 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 添加扩展的方法。</span><span class="sxs-lookup"><span data-stu-id="2df08-108">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span></span> <span data-ttu-id="2df08-109">使用 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> 方法可以为各工作流服务实例添加扩展。</span><span class="sxs-lookup"><span data-stu-id="2df08-109">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance.</span></span> <span data-ttu-id="2df08-110">从永久性存储中创建或加载工作流服务实例时，会调用指定的委托以创建新扩展。</span><span class="sxs-lookup"><span data-stu-id="2df08-110">The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store.</span></span> <span data-ttu-id="2df08-111">使用 <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> 方法可以为各工作流服务主机添加扩展，所有工作流服务实例共享一个扩展实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-111">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.</span></span>  
  
## <a name="react-to-unhandled-exceptions"></a><span data-ttu-id="2df08-112">响应未经处理的异常</span><span class="sxs-lookup"><span data-stu-id="2df08-112">React to Unhandled Exceptions</span></span>  
 <span data-ttu-id="2df08-113">使用  <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> 可以指定工作流服务中出现未经处理的异常时所采取的操作。</span><span class="sxs-lookup"><span data-stu-id="2df08-113">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service.</span></span> <span data-ttu-id="2df08-114"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> 属性指定下列 <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> 值之一：</span><span class="sxs-lookup"><span data-stu-id="2df08-114">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:</span></span>  
  
-   <span data-ttu-id="2df08-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> - 中止工作流服务实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance.</span></span>  
  
-   <span data-ttu-id="2df08-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> - 回滚到最后保存的状态，并挂起工作流服务实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance.</span></span> <span data-ttu-id="2df08-117">仅当已至少保存一次工作流时，才会发生此状况。</span><span class="sxs-lookup"><span data-stu-id="2df08-117">This only occurs if the workflow has already been persisted at least once.</span></span> <span data-ttu-id="2df08-118">否则，将中止工作流实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-118">If not the workflow instance is aborted.</span></span>  
  
-   <span data-ttu-id="2df08-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> - 取消实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance.</span></span>  
  
-   <span data-ttu-id="2df08-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> - 终止实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance.</span></span>  
  
 <span data-ttu-id="2df08-121">可在代码中配置该行为，如下面的示例所示。</span><span class="sxs-lookup"><span data-stu-id="2df08-121">This behavior can be configured in code as shown in the following example.</span></span>  
  
```csharp  
host.Description.Behaviors.Add(new WorkflowUnhandledExceptionBehavior { Action = WorkflowUnhandledExceptionAction.Abandon });  
```  
  
 <span data-ttu-id="2df08-122">也可在配置文件中配置该行为，如下面的示例所示。</span><span class="sxs-lookup"><span data-stu-id="2df08-122">It can also be configured in a configuration file as shown in the following example.</span></span>  
  
```xml
<behaviors>  
      <serviceBehaviors>  
        <behavior>  
          <serviceMetadata httpGetEnabled="True"/>  
          <serviceDebug includeExceptionDetailInFaults="False" />  
          <workflowUnhandledExceptionBehavior action="Abandon" />        
        </behavior>  
      </serviceBehaviors>  
```  
  
## <a name="hosting-non-service-workflows"></a><span data-ttu-id="2df08-123">承载非服务工作流</span><span class="sxs-lookup"><span data-stu-id="2df08-123">Hosting Non-Service Workflows</span></span>  
 <span data-ttu-id="2df08-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> 可用于承载非服务工作流、未以 <xref:System.ServiceModel.Activities.Receive> 活动开头的工作流或未使用消息传递活动的工作流。</span><span class="sxs-lookup"><span data-stu-id="2df08-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities.</span></span> <span data-ttu-id="2df08-125">工作流服务通常以 <xref:System.ServiceModel.Activities.Receive> 活动开头。</span><span class="sxs-lookup"><span data-stu-id="2df08-125">Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity.</span></span> <span data-ttu-id="2df08-126">如果 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 在接收工作流服务的消息时未处于运行状态（或未保存），则会创建一个新的工作流服务实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-126">When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created.</span></span> <span data-ttu-id="2df08-127">如果工作流不以 Receive 活动开头，则无法通过发送消息来启动此工作流，因为没有用于接收消息的活动。</span><span class="sxs-lookup"><span data-stu-id="2df08-127">If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message.</span></span> <span data-ttu-id="2df08-128">若要承载非服务工作流，请从 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> 派生一个类，并重写 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> 和 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>。</span><span class="sxs-lookup"><span data-stu-id="2df08-128">To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>.</span></span> <span data-ttu-id="2df08-129">如果您想提供首选实例 ID，请重写 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>。</span><span class="sxs-lookup"><span data-stu-id="2df08-129">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID.</span></span> <span data-ttu-id="2df08-130">重写 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> 可以创建自定义工作流创建上下文或填充现有 <xref:System.ServiceModel.Activities.WorkflowCreationContext> 的实例。</span><span class="sxs-lookup"><span data-stu-id="2df08-130">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>.</span></span> <span data-ttu-id="2df08-131">重写 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> 可以从传入消息中手动提取书签。</span><span class="sxs-lookup"><span data-stu-id="2df08-131">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message.</span></span> <span data-ttu-id="2df08-132">如果重写此方法，则必须在其主体中调用 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A>，以便响应发送给 WorkflowHostingEndpoint 的消息。</span><span class="sxs-lookup"><span data-stu-id="2df08-132">If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint.</span></span> <span data-ttu-id="2df08-133">如果不这样做，则可能会最终超过 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> 限制。</span><span class="sxs-lookup"><span data-stu-id="2df08-133">If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded.</span></span> <span data-ttu-id="2df08-134">在双向协定中，您可能能够检测到未能调用 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A>，因为客户端未能接收响应。</span><span class="sxs-lookup"><span data-stu-id="2df08-134">In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response.</span></span> <span data-ttu-id="2df08-135">在单向协定中，您无法识别有关未能调用 <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> 的错误，直至超过 <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> 中止值之后，此时为时已晚。</span><span class="sxs-lookup"><span data-stu-id="2df08-135">In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded.</span></span> <span data-ttu-id="2df08-136">有关详细信息，请参阅[WorkflowHostingEndpoint 恢复书签](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)若要创建非服务工作流的新实例，声明一个服务协定用于定义创建一个新实例的操作。</span><span class="sxs-lookup"><span data-stu-id="2df08-136">For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../../../docs/framework/windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance.</span></span> <span data-ttu-id="2df08-137">创建操作应采用 IDictionary\<字符串、 对象 > 传递所有必需的工作流参数。</span><span class="sxs-lookup"><span data-stu-id="2df08-137">The creation operation should take an IDictionary\<string, object> to pass any required workflow parameters.</span></span> <span data-ttu-id="2df08-138">该协定由 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> 派生类隐式实现。</span><span class="sxs-lookup"><span data-stu-id="2df08-138">This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class.</span></span> <span data-ttu-id="2df08-139">当承载工作流时，请通过调用 <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> 向主机添加 <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> 派生类的实例，然后调用 <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>。</span><span class="sxs-lookup"><span data-stu-id="2df08-139">When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>.</span></span> <span data-ttu-id="2df08-140">若要创建工作流的实例，请创建所用服务协定类型的 <xref:System.ServiceModel.ChannelFactory%601>，并调用 <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>。</span><span class="sxs-lookup"><span data-stu-id="2df08-140">To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>.</span></span> <span data-ttu-id="2df08-141">然后，可调用在服务协定中定义的创建操作。</span><span class="sxs-lookup"><span data-stu-id="2df08-141">You can then call the create operation defined in your service contract.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2df08-142">请参阅</span><span class="sxs-lookup"><span data-stu-id="2df08-142">See Also</span></span>  
 [<span data-ttu-id="2df08-143">工作流服务</span><span class="sxs-lookup"><span data-stu-id="2df08-143">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)  
 [<span data-ttu-id="2df08-144">消息传递活动</span><span class="sxs-lookup"><span data-stu-id="2df08-144">Messaging Activities</span></span>](../../../../docs/framework/wcf/feature-details/messaging-activities.md)
