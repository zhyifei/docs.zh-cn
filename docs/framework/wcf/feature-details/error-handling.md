---
title: 错误处理
ms.date: 03/30/2017
ms.assetid: c948841a-7db9-40ae-9b78-587d216cbcaf
ms.openlocfilehash: f6c0d676a37648678b2b726a46a6238ccc1b3331
ms.sourcegitcommit: eff6adb61852369ab690f3f047818c90580e7eb1
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/07/2019
ms.locfileid: "72004884"
---
# <a name="error-handling-in-windows-communication-foundation-wcf"></a><span data-ttu-id="31ab1-102">Windows Communication Foundation （WCF）中的错误处理</span><span class="sxs-lookup"><span data-stu-id="31ab1-102">Error handling in Windows Communication Foundation (WCF)</span></span>

<span data-ttu-id="31ab1-103">在某一服务遇到意外的异常或错误时，有多种方式可以设计异常处理解决方案。</span><span class="sxs-lookup"><span data-stu-id="31ab1-103">When a service encounters an unexpected exception or error, there are multiple ways to design an exception-handling solution.</span></span> <span data-ttu-id="31ab1-104">尽管没有一种 "正确" 或 "最佳做法" 错误处理解决方案，但有多个有效路径需要考虑。</span><span class="sxs-lookup"><span data-stu-id="31ab1-104">While there is no single "correct" or "best practice" error-handling solution, there are multiple valid paths for one to consider.</span></span> <span data-ttu-id="31ab1-105">通常建议实现一种混合解决方案，将多个方法与以下列表组合在一起，具体取决于 WCF 实现的复杂性、异常的类型和频率、处理的与未处理的性质、异常以及任何关联的跟踪、日志记录或策略要求。</span><span class="sxs-lookup"><span data-stu-id="31ab1-105">It is normally recommended that one implement a hybrid solution that combines multiple approaches from the list below, depending on the complexity of the WCF implementation, the type and frequency of the exceptions, the handled vs. unhandled nature of the exceptions, and any associated tracing, logging, or policy requirements.</span></span>

<span data-ttu-id="31ab1-106">在本节的其余部分中将更深入地说明这些解决方案。</span><span class="sxs-lookup"><span data-stu-id="31ab1-106">These solutions are explained more deeply in the rest of this section.</span></span>

## <a name="the-microsoft-enterprise-library"></a><span data-ttu-id="31ab1-107">Microsoft 企业库</span><span class="sxs-lookup"><span data-stu-id="31ab1-107">The Microsoft Enterprise Library</span></span>

<span data-ttu-id="31ab1-108">Microsoft 企业库异常处理应用程序块帮助实现常见的设计模式并且创建一致的策略，以便处理在企业应用程序的所有体系结构层中出现的异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-108">The Microsoft Enterprise Library Exception Handling Application Block helps implement common design patterns and create a consistent strategy for processing exceptions that occur in all architectural layers of an enterprise application.</span></span> <span data-ttu-id="31ab1-109">它设计为支持在应用程序组件的 Catch 语句中包含的典型代码。</span><span class="sxs-lookup"><span data-stu-id="31ab1-109">It is designed to support the typical code contained in catch statements in application components.</span></span> <span data-ttu-id="31ab1-110">借助于该异常处理应用程序块，开发人员能够将该逻辑作为可重复使用的异常处理程序进行封装，而不必在应用程序的完全相同的 catch 块中重复此代码（例如将异常信息记入日志的代码）。</span><span class="sxs-lookup"><span data-stu-id="31ab1-110">Instead of repeating this code (such as code that logs exception information) in identical catch blocks throughout an application, the Exception Handling Application Block allows developers to encapsulate this logic as reusable exception handlers.</span></span>

<span data-ttu-id="31ab1-111">该库包含现成的错误协定异常处理程序。</span><span class="sxs-lookup"><span data-stu-id="31ab1-111">This Library includes out-of-the-box a Fault Contract Exception Handler.</span></span> <span data-ttu-id="31ab1-112">此异常处理程序专用于 WCF 服务边界，并从异常生成新的错误协定。</span><span class="sxs-lookup"><span data-stu-id="31ab1-112">This exception handler is designed for use at WCF service boundaries, and generates a new Fault Contract from the exception.</span></span>

<span data-ttu-id="31ab1-113">应用程序块旨在纳入常用的最佳做法并且为应用程序中的异常处理提供一般的方法。</span><span class="sxs-lookup"><span data-stu-id="31ab1-113">Application blocks aim to incorporate commonly used best practices and provide a common approach for exception handling throughout your application.</span></span> <span data-ttu-id="31ab1-114">另一方面，自定义的错误处理程序以及自己开发的错误协定也可能非常有用。</span><span class="sxs-lookup"><span data-stu-id="31ab1-114">On the other hand, custom error handlers and fault contracts developed on one’s own can also be very useful.</span></span> <span data-ttu-id="31ab1-115">例如，自定义错误处理程序提供了一个很好的机会，可自动将所有异常升级到 Faultexception，还可以向应用程序添加日志记录功能。</span><span class="sxs-lookup"><span data-stu-id="31ab1-115">For instance, custom error handlers provide an excellent opportunity to automatically promote all exceptions to FaultExceptions and also to add logging capabilities to your application.</span></span>

<span data-ttu-id="31ab1-116">有关详细信息，请参阅[Microsoft Enterprise Library](https://docs.microsoft.com/previous-versions/msp-n-p/ff632023(v=pandp.10))。</span><span class="sxs-lookup"><span data-stu-id="31ab1-116">For more information, please see [Microsoft Enterprise Library](https://docs.microsoft.com/previous-versions/msp-n-p/ff632023(v=pandp.10)).</span></span>

## <a name="dealing-with-expected-exceptions"></a><span data-ttu-id="31ab1-117">处理预期异常</span><span class="sxs-lookup"><span data-stu-id="31ab1-117">Dealing with expected exceptions</span></span>

<span data-ttu-id="31ab1-118">正确的操作过程是在每一个操作或相关扩展点中捕获预期异常，确定是否可以从中恢复，并在 FaultException @ no__t-0T > 中返回正确的自定义错误。</span><span class="sxs-lookup"><span data-stu-id="31ab1-118">The proper course of action is to catch expected exceptions in every operation or relevant extensibility point, decide whether they can be recovered from, and return the proper custom fault in a FaultException\<T>.</span></span>
  
## <a name="dealing-with-unexpected-exceptions-using-an-ierrorhandler"></a><span data-ttu-id="31ab1-119">使用 IErrorHandler 处理意外的异常</span><span class="sxs-lookup"><span data-stu-id="31ab1-119">Dealing with unexpected exceptions using an IErrorHandler</span></span>

<span data-ttu-id="31ab1-120">若要处理意外异常，推荐的操作过程是 "IErrorHandler"。</span><span class="sxs-lookup"><span data-stu-id="31ab1-120">To deal with unexpected exceptions, the recommended course of action is to "hook" an IErrorHandler.</span></span> <span data-ttu-id="31ab1-121">错误处理程序仅在 WCF 运行时级别（"服务模型" 层）捕获异常，而不是在通道层捕获异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-121">Error handlers only catch exceptions at the WCF runtime level (the "service model" layer), not at the channel layer.</span></span> <span data-ttu-id="31ab1-122">在通道层挂钩 IErrorHandler 的唯一方法是创建一个自定义通道，但在大多数情况下不建议这样做。</span><span class="sxs-lookup"><span data-stu-id="31ab1-122">The only way to hook an IErrorHandler at the channel level is to create a custom channel, which is not recommended in most scenarios.</span></span>

<span data-ttu-id="31ab1-123">通常，"意外的异常" 既不是不可恢复的异常，也不是处理异常;这是意外的用户异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-123">An "unexpected exception" is generally neither an irrecoverable exception nor a processing exception; it is, instead, an unexpected user exception.</span></span> <span data-ttu-id="31ab1-124">不能恢复的异常（如内存不足异常）–通常由[服务模型异常处理程序](xref:System.ServiceModel.Dispatcher.ExceptionHandler)自动处理–通常不能正常处理，也不能正常处理此类异常的唯一原因其他日志记录或将标准异常返回到客户端。</span><span class="sxs-lookup"><span data-stu-id="31ab1-124">An irrecoverable exception (such as an out-of-memory exception) – one generally handled by the [Service Model Exception Handler](xref:System.ServiceModel.Dispatcher.ExceptionHandler) automatically – cannot generally be handled gracefully, and the only reason to handle such an exception at all may be do additional logging or to return a standard exception to the client.</span></span> <span data-ttu-id="31ab1-125">在处理消息的过程中（例如，在序列化、编码器或格式化程序级别）发生的处理异常不能在 IErrorHandler 进行处理，因为就发生这些异常的时间而言，错误处理程序介入的时间要么过早，要么过晚。</span><span class="sxs-lookup"><span data-stu-id="31ab1-125">A processing exception occurs in the processing of the message – for example, at the serialization, encoder, or formatter level – generally cannot be handled at an IErrorHandler, because it is generally either too early or too late for the error handler to intervene by the time these exceptions occur.</span></span> <span data-ttu-id="31ab1-126">同样，不能在 IErrorHandler 处理传输异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-126">Similarly, transport exceptions cannot be handled at an IErrorHandler.</span></span>

<span data-ttu-id="31ab1-127">使用 IErrorHandler，您可以显式控制某一异常引发时您的应用程序的行为。</span><span class="sxs-lookup"><span data-stu-id="31ab1-127">With an IErrorHandler, you can explicitly control the behavior of your application when an exception is thrown.</span></span> <span data-ttu-id="31ab1-128">您可以：</span><span class="sxs-lookup"><span data-stu-id="31ab1-128">You may:</span></span>  

1. <span data-ttu-id="31ab1-129">确定是否将错误发送到客户端。</span><span class="sxs-lookup"><span data-stu-id="31ab1-129">Decide whether or not to send a fault to the client.</span></span>

2. <span data-ttu-id="31ab1-130">将异常替换为错误。</span><span class="sxs-lookup"><span data-stu-id="31ab1-130">Replace an exception with a fault.</span></span>

3. <span data-ttu-id="31ab1-131">将错误替换为其他错误。</span><span class="sxs-lookup"><span data-stu-id="31ab1-131">Replace a fault with another fault.</span></span>

4. <span data-ttu-id="31ab1-132">执行日志记录或跟踪。</span><span class="sxs-lookup"><span data-stu-id="31ab1-132">Perform logging or tracing.</span></span>

5. <span data-ttu-id="31ab1-133">执行其他自定义活动。</span><span class="sxs-lookup"><span data-stu-id="31ab1-133">Perform other custom activities.</span></span>

<span data-ttu-id="31ab1-134">可通过将自定义错误处理程序添加到您的服务的通道调度程序的 ErrorHandlers 属性，安装该错误处理程序。</span><span class="sxs-lookup"><span data-stu-id="31ab1-134">One can install a custom error handler by adding it to the ErrorHandlers property of the channel dispatchers for your service.</span></span>  <span data-ttu-id="31ab1-135">可以具有多个错误处理程序，并且按照将这些错误处理程序添加到该集合的顺序调用它们。</span><span class="sxs-lookup"><span data-stu-id="31ab1-135">It is possible to have more than one error handler and they are called in the order they are added to this collection.</span></span>

<span data-ttu-id="31ab1-136">IErrorHandler.ProvideFault 控制发送到客户端的错误消息。</span><span class="sxs-lookup"><span data-stu-id="31ab1-136">IErrorHandler.ProvideFault controls the fault message that is sent to the client.</span></span> <span data-ttu-id="31ab1-137">无论您的服务中的操作所引发的是何种异常类型，都会调用此方法。</span><span class="sxs-lookup"><span data-stu-id="31ab1-137">This method is called regardless of the type of the exception thrown by an operation in your service.</span></span> <span data-ttu-id="31ab1-138">如果未在此处执行任何操作，WCF 将假定其默认行为，并继续执行，就像没有任何自定义错误处理程序一样。</span><span class="sxs-lookup"><span data-stu-id="31ab1-138">If no operation is performed here, WCF assumes its default behavior and continues as if there were no custom error handlers in place.</span></span>

<span data-ttu-id="31ab1-139">您可能会使用此方法的一个方面是在您想要创建一个中心位置以便在将异常发送到客户端之前将异常转换为错误时（确保实例不会被释放并且通道不会转移到错误状态）。</span><span class="sxs-lookup"><span data-stu-id="31ab1-139">One area that you could perhaps use this approach is when you want to create a central place for converting exceptions to faults before they are sent to the client (ensuring that the instance is not disposed and the channel is not moved to the Faulted state).</span></span>

<span data-ttu-id="31ab1-140">IErrorHandler.HandleError 方法通常用来实现错误相关行为，例如错误日志记录、系统通知、关闭应用程序等。可以在服务内的多个地方调用 IErrorHandler.HandleError，并且根据引发错误的位置，HandleError 方法不一定被与操作相同的线程调用；在此方面不作任何保证。</span><span class="sxs-lookup"><span data-stu-id="31ab1-140">The IErrorHandler.HandleError method is usually used to implement error-related behaviors such as error logging, system notifications, shutting down the application, etc. IErrorHandler.HandleError can be called at multiple places inside the service, and depending on where the error is thrown, the HandleError method may or may not be called by the same thread as the operation; no guarantees are made in this regard.</span></span>

## <a name="dealing-with-exceptions-outside-wcf"></a><span data-ttu-id="31ab1-141">在 WCF 外处理异常</span><span class="sxs-lookup"><span data-stu-id="31ab1-141">Dealing with exceptions outside WCF</span></span>

<span data-ttu-id="31ab1-142">配置异常、数据库连接字符串异常以及其他类似异常经常可能会在 WCF 应用程序环境内发生，但它们本身不是服务模型或 Web 服务本身导致的异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-142">Often, configuration exceptions, database connection string exceptions, and other similar exceptions may occur within the context of a WCF application, but are themselves are not exceptions caused by the service model or the web service itself.</span></span> <span data-ttu-id="31ab1-143">这些异常是 web 服务外部的 "常规" 异常，应像处理环境中的其他外部异常一样进行处理。</span><span class="sxs-lookup"><span data-stu-id="31ab1-143">These exceptions are "regular" exceptions external to the web service, and should be handled just as other external exceptions in the environment are to be handled.</span></span>

## <a name="tracing-exceptions"></a><span data-ttu-id="31ab1-144">跟踪异常</span><span class="sxs-lookup"><span data-stu-id="31ab1-144">Tracing exceptions</span></span>

<span data-ttu-id="31ab1-145">跟踪是唯一一种可能会查看所有异常的 "全部捕获" 位置。</span><span class="sxs-lookup"><span data-stu-id="31ab1-145">Tracing is the only "catch-all" place where one can potentially see all exceptions.</span></span> <span data-ttu-id="31ab1-146">有关跟踪和日志记录异常的更多信息，请参见“跟踪和日志记录”。</span><span class="sxs-lookup"><span data-stu-id="31ab1-146">For more information on tracing and logging exceptions, see Tracing and Logging.</span></span>

## <a name="uri-template-errors-when-using-webgetattribute-and-webinvokeattribute"></a><span data-ttu-id="31ab1-147">使用 WebGetAttribute 和 WebInvokeAttribute 时的 URI 模板错误</span><span class="sxs-lookup"><span data-stu-id="31ab1-147">URI template errors when using WebGetAttribute and WebInvokeAttribute</span></span>

<span data-ttu-id="31ab1-148">通过 WebGet 和 WebInvoke 特性，你可以指定将请求地址的组件映射到操作参数的 URI 模板。</span><span class="sxs-lookup"><span data-stu-id="31ab1-148">The WebGet and WebInvoke attributes allow you to specify a URI template that maps components of the request address to operation parameters.</span></span> <span data-ttu-id="31ab1-149">例如，URI 模板“weather/{state}/{city}”将请求地址映射到文本标记、名为 state 的参数和名为 city 的参数。</span><span class="sxs-lookup"><span data-stu-id="31ab1-149">For example, the URI template "weather/{state}/{city}" maps the request address into literal tokens, a parameter named state, and a parameter named city.</span></span> <span data-ttu-id="31ab1-150">然后，可以将这些参数按名称绑定到该操作的某些形参上。</span><span class="sxs-lookup"><span data-stu-id="31ab1-150">These parameters might then be bound by name to some of the formal parameters of the operation.</span></span>

<span data-ttu-id="31ab1-151">模板参数在 URI 内以字符串的形式出现，而类型化协定的形参可能属于非字符串类型。</span><span class="sxs-lookup"><span data-stu-id="31ab1-151">The template parameters appear in the form of strings within the URI while the formal parameters of a typed contract might be of non-string types.</span></span> <span data-ttu-id="31ab1-152">因此，需要进行某种转换，才能调用该操作。</span><span class="sxs-lookup"><span data-stu-id="31ab1-152">Therefore, a conversion needs to take place before the operation can be invoked.</span></span> <span data-ttu-id="31ab1-153">[转换格式表](wcf-web-http-programming-model-overview.md)可用。</span><span class="sxs-lookup"><span data-stu-id="31ab1-153">A [table of conversion formats](wcf-web-http-programming-model-overview.md) is available.</span></span>

<span data-ttu-id="31ab1-154">但是，如果转换失败，则无法让该操作知道出现了问题。</span><span class="sxs-lookup"><span data-stu-id="31ab1-154">However, if the conversion fails, then there's no way to let the operation know that something has gone wrong.</span></span> <span data-ttu-id="31ab1-155">类型转换而是以调度失败的形式出现。</span><span class="sxs-lookup"><span data-stu-id="31ab1-155">The type conversion instead surfaces in the form of a dispatch failure.</span></span>

<span data-ttu-id="31ab1-156">可通过安装错误处理程序，像许多其他类型的调度失败一样检查类型转换调度失败。</span><span class="sxs-lookup"><span data-stu-id="31ab1-156">A type conversion dispatch failure can be inspected the same as with many other types of dispatch failures by installing an error handler.</span></span> <span data-ttu-id="31ab1-157">调用 IErrorHandler 扩展点处理服务级别异常。</span><span class="sxs-lookup"><span data-stu-id="31ab1-157">The IErrorHandler extensibility point is called to handle service-level exceptions.</span></span> <span data-ttu-id="31ab1-158">从中，可以选择要发送回调用方的响应，以及执行任何自定义任务和报告。</span><span class="sxs-lookup"><span data-stu-id="31ab1-158">From there, the response to be sent back to the caller – as well as perform any custom tasks and reporting – may be chosen.</span></span>

## <a name="see-also"></a><span data-ttu-id="31ab1-159">请参阅</span><span class="sxs-lookup"><span data-stu-id="31ab1-159">See also</span></span>

- [<span data-ttu-id="31ab1-160">基本 WCF 编程</span><span class="sxs-lookup"><span data-stu-id="31ab1-160">Basic WCF Programming</span></span>](../basic-wcf-programming.md)
