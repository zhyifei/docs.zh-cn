---
title: 如何：在联合身份验证服务上配置凭据
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, federation
- federation
ms.assetid: 149ab165-0ef3-490a-83a9-4322a07bd98a
ms.openlocfilehash: 33df685b4d14130ae00d59012706b7637924c9be
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59295427"
---
# <a name="how-to-configure-credentials-on-a-federation-service"></a><span data-ttu-id="7dc03-102">如何：在联合身份验证服务上配置凭据</span><span class="sxs-lookup"><span data-stu-id="7dc03-102">How to: Configure Credentials on a Federation Service</span></span>
<span data-ttu-id="7dc03-103">在 Windows Communication Foundation (WCF) 中，创建联合的服务包含以下主要步骤：</span><span class="sxs-lookup"><span data-stu-id="7dc03-103">In Windows Communication Foundation (WCF), creating a federated service consists of the following main procedures:</span></span>  
  
1. <span data-ttu-id="7dc03-104">配置 <xref:System.ServiceModel.WSFederationHttpBinding> 或类似的自定义绑定。</span><span class="sxs-lookup"><span data-stu-id="7dc03-104">Configuring a <xref:System.ServiceModel.WSFederationHttpBinding> or similar custom binding.</span></span> <span data-ttu-id="7dc03-105">有关创建适当绑定的详细信息，请参阅[如何：创建 WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="7dc03-105">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md).</span></span>  
  
2. <span data-ttu-id="7dc03-106">配置 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential>，它控制如何对提供给服务的已颁发令牌进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="7dc03-106">Configuring the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> that controls how issued tokens presented to the service are authenticated.</span></span>  
  
 <span data-ttu-id="7dc03-107">本主题提供有关第二个步骤的详细信息。</span><span class="sxs-lookup"><span data-stu-id="7dc03-107">This topic provides details about the second step.</span></span> <span data-ttu-id="7dc03-108">有关联合的服务的工作原理的详细信息，请参阅[联合身份验证](../../../../docs/framework/wcf/feature-details/federation.md)。</span><span class="sxs-lookup"><span data-stu-id="7dc03-108">For more information about how a federated service works, see [Federation](../../../../docs/framework/wcf/feature-details/federation.md).</span></span>  
  
### <a name="to-set-the-properties-of-issuedtokenservicecredential-in-code"></a><span data-ttu-id="7dc03-109">在代码中设置 IssuedTokenServiceCredential 的属性</span><span class="sxs-lookup"><span data-stu-id="7dc03-109">To set the properties of IssuedTokenServiceCredential in code</span></span>  
  
1. <span data-ttu-id="7dc03-110">使用 <xref:System.ServiceModel.Description.ServiceCredentials.IssuedTokenAuthentication%2A> 类的 <xref:System.ServiceModel.Description.ServiceCredentials> 属性返回对 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 实例的引用。</span><span class="sxs-lookup"><span data-stu-id="7dc03-110">Use the <xref:System.ServiceModel.Description.ServiceCredentials.IssuedTokenAuthentication%2A> property of the <xref:System.ServiceModel.Description.ServiceCredentials> class to return a reference to an <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> instance.</span></span> <span data-ttu-id="7dc03-111">该属性可从 <xref:System.ServiceModel.ServiceHostBase.Credentials%2A> 类的 <xref:System.ServiceModel.ServiceHostBase> 属性访问。</span><span class="sxs-lookup"><span data-stu-id="7dc03-111">The property is accessed from the <xref:System.ServiceModel.ServiceHostBase.Credentials%2A> property of the <xref:System.ServiceModel.ServiceHostBase> class.</span></span>  
  
2. <span data-ttu-id="7dc03-112">如果要对自行颁发的令牌（比如 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> 卡）进行身份验证，则将 `true` 属性设置为 [!INCLUDE[infocard](../../../../includes/infocard-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7dc03-112">Set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> property to `true` if self-issued tokens such as [!INCLUDE[infocard](../../../../includes/infocard-md.md)] cards are to be authenticated.</span></span> <span data-ttu-id="7dc03-113">默认值为 `false`。</span><span class="sxs-lookup"><span data-stu-id="7dc03-113">The default is `false`.</span></span>  
  
3. <span data-ttu-id="7dc03-114">用 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 类的实例填充由 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 属性返回的集合。</span><span class="sxs-lookup"><span data-stu-id="7dc03-114">Populate the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property with instances of the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class.</span></span> <span data-ttu-id="7dc03-115">每个实例表示一个颁发者，服务将从该颁发者对令牌进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="7dc03-115">Each instance represents an issuer from which the service will authenticate tokens.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="7dc03-116">与 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 属性返回的客户端集合不同，已知证书集合不是键控集合。</span><span class="sxs-lookup"><span data-stu-id="7dc03-116">Unlike the client-side collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property, the known certificates collection is not a keyed collection.</span></span> <span data-ttu-id="7dc03-117">不管发送包含已颁发令牌的消息的客户端地址是什么，服务都接受指定证书颁发的令牌（还受其他限制，这一点将在本主题的后面说明）。</span><span class="sxs-lookup"><span data-stu-id="7dc03-117">The service accepts the tokens that the specified certificates issue regardless of the address of the client that sent the message containing the issued token (subject to the further constraints, which are described later in this topic).</span></span>  
  
4. <span data-ttu-id="7dc03-118">将 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 属性设置为 <xref:System.ServiceModel.Security.X509CertificateValidationMode> 枚举值之一。</span><span class="sxs-lookup"><span data-stu-id="7dc03-118">Set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> property to one of the <xref:System.ServiceModel.Security.X509CertificateValidationMode> enumeration values.</span></span> <span data-ttu-id="7dc03-119">这只能在代码中完成。</span><span class="sxs-lookup"><span data-stu-id="7dc03-119">This can be done only in code.</span></span> <span data-ttu-id="7dc03-120">默认值为 <xref:System.IdentityModel.Selectors.X509CertificateValidator.ChainTrust%2A>。</span><span class="sxs-lookup"><span data-stu-id="7dc03-120">The default is <xref:System.IdentityModel.Selectors.X509CertificateValidator.ChainTrust%2A>.</span></span>  
  
5. <span data-ttu-id="7dc03-121">如果 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 属性设置为 <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>，则将自定义 <xref:System.IdentityModel.Selectors.X509CertificateValidator> 类的一个实例分配给 <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CustomCertificateValidator%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="7dc03-121">If the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> property is set to <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>, then assign an instance of the custom <xref:System.IdentityModel.Selectors.X509CertificateValidator> class to the <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CustomCertificateValidator%2A> property.</span></span>  
  
6. <span data-ttu-id="7dc03-122">如果 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 设置为 `ChainTrust` 或 `PeerOrChainTrust`，则将 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.RevocationMode%2A> 属性设置为 <xref:System.Security.Cryptography.X509Certificates.X509RevocationMode> 枚举中的适当值。</span><span class="sxs-lookup"><span data-stu-id="7dc03-122">If the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> is set to `ChainTrust` or `PeerOrChainTrust`, set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.RevocationMode%2A> property to an appropriate value from the <xref:System.Security.Cryptography.X509Certificates.X509RevocationMode> enumeration.</span></span> <span data-ttu-id="7dc03-123">请注意，在 `PeerTrust` 或 `Custom` 验证模式中不使用吊销模式。</span><span class="sxs-lookup"><span data-stu-id="7dc03-123">Note that the revocation mode is not used in `PeerTrust` or `Custom` validation modes.</span></span>  
  
7. <span data-ttu-id="7dc03-124">如果需要，将自定义 <xref:System.IdentityModel.Tokens.SamlSerializer> 类的一个实例分配给 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.SamlSerializer%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="7dc03-124">If needed, assign an instance of a custom <xref:System.IdentityModel.Tokens.SamlSerializer> class to the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.SamlSerializer%2A> property.</span></span> <span data-ttu-id="7dc03-125">例如，如果要分析自定义 SAML 断言，则需要自定义安全断言标记语言 (SAML) 序列化程序。</span><span class="sxs-lookup"><span data-stu-id="7dc03-125">A custom Security Assertions Markup Language (SAML) serializer is needed, for example, for parsing custom SAML assertions.</span></span>  
  
### <a name="to-set-the-properties-of-issuedtokenservicecredential-in-configuration"></a><span data-ttu-id="7dc03-126">在配置中设置 IssuedTokenServiceCredential 的属性</span><span class="sxs-lookup"><span data-stu-id="7dc03-126">To set the properties of IssuedTokenServiceCredential in configuration</span></span>  
  
1. <span data-ttu-id="7dc03-127">创建`<issuedTokenAuthentication>`的子元素 <`serviceCredentials`> 元素。</span><span class="sxs-lookup"><span data-stu-id="7dc03-127">Create an `<issuedTokenAuthentication>` element as a child of a <`serviceCredentials`> element.</span></span>  
  
2. <span data-ttu-id="7dc03-128">如果要验证自行颁发的令牌（比如 `allowUntrustedRsaIssuers` 卡），则将 `<issuedTokenAuthentication>` 元素的 `true` 属性设置为 [!INCLUDE[infocard](../../../../includes/infocard-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7dc03-128">Set the `allowUntrustedRsaIssuers` attribute of the `<issuedTokenAuthentication>` element to `true` if authenticating a self-issued token, such as an [!INCLUDE[infocard](../../../../includes/infocard-md.md)] card.</span></span>  
  
3. <span data-ttu-id="7dc03-129">创建一个 `<knownCertificates>` 元素，作为 `<issuedTokenAuthentication>` 元素的子元素。</span><span class="sxs-lookup"><span data-stu-id="7dc03-129">Create a `<knownCertificates>` element as a child of the `<issuedTokenAuthentication>` element.</span></span>  
  
4. <span data-ttu-id="7dc03-130">创建零个或多个 `<add>` 元素作为 `<knownCertificates>` 元素的子项，并指定如何使用 `storeLocation`、`storeName`、`x509FindType` 和 `findValue` 属性来定位证书。</span><span class="sxs-lookup"><span data-stu-id="7dc03-130">Create zero or more `<add>` elements as children of the `<knownCertificates>` element, and specify how to locate the certificate using the `storeLocation`, `storeName`, `x509FindType`, and `findValue` attributes.</span></span>  
  
5. <span data-ttu-id="7dc03-131">如有必要，设置`samlSerializer`属性的 <`issuedTokenAuthentication`> 元素的自定义的类型名称<xref:System.IdentityModel.Tokens.SamlSerializer>类。</span><span class="sxs-lookup"><span data-stu-id="7dc03-131">If necessary, set the `samlSerializer` attribute of the <`issuedTokenAuthentication`> element to the type name of the custom <xref:System.IdentityModel.Tokens.SamlSerializer> class.</span></span>  
  
## <a name="example"></a><span data-ttu-id="7dc03-132">示例</span><span class="sxs-lookup"><span data-stu-id="7dc03-132">Example</span></span>  
 <span data-ttu-id="7dc03-133">下面的示例在代码中设置 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 的属性。</span><span class="sxs-lookup"><span data-stu-id="7dc03-133">The following example sets the properties of an <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> in code.</span></span>  
  
 [!code-csharp[C_FederatedService#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_federatedservice/cs/source.cs#2)]
 [!code-vb[C_FederatedService#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_federatedservice/vb/source.vb#2)]  
  
 <span data-ttu-id="7dc03-134">为了使联合服务能够对客户端进行身份验证，必须满足有关已颁发令牌的下列各项条件：</span><span class="sxs-lookup"><span data-stu-id="7dc03-134">In order for a federated service to authenticate a client, the following must be true about the issued token:</span></span>  
  
-   <span data-ttu-id="7dc03-135">如果已颁发令牌的数字签名使用 RSA 安全密钥标识符，则 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> 属性必须为 `true`。</span><span class="sxs-lookup"><span data-stu-id="7dc03-135">When the issued token’s digital signature uses an RSA security key identifier, the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.AllowUntrustedRsaIssuers%2A> property must be `true`.</span></span>  
  
-   <span data-ttu-id="7dc03-136">如果已颁发令牌的签名使用 X.509 颁发者序列号、X.509 主题密钥标识符或 X.509 指纹安全标识符，则已颁发的令牌必须由 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 类的 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> 属性返回的集合中的证书进行签名。</span><span class="sxs-lookup"><span data-stu-id="7dc03-136">When the issued token’s signature uses an X.509 issuer serial number, X.509 subject key identifier, or X.509 thumbprint security identifier, the issued token must be signed by a certificate in the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property of the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> class.</span></span>  
  
-   <span data-ttu-id="7dc03-137">如果使用 X.509 证书对已颁发的令牌进行签名，该证书必须按照由 <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CertificateValidationMode%2A> 属性的值指定的语义进行验证，无论该证书是作为 <xref:System.IdentityModel.Tokens.X509RawDataKeyIdentifierClause> 发送给依赖方还是从 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> 属性获取。</span><span class="sxs-lookup"><span data-stu-id="7dc03-137">When the issued token is signed using an X.509 certificate, the certificate must validate per the semantics specified by the value of the <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CertificateValidationMode%2A> property, regardless of whether the certificate was sent to the relying party as a <xref:System.IdentityModel.Tokens.X509RawDataKeyIdentifierClause> or was obtained from the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> property.</span></span> <span data-ttu-id="7dc03-138">有关 X.509 证书验证的详细信息，请参阅[Working with Certificates](../../../../docs/framework/wcf/feature-details/working-with-certificates.md)。</span><span class="sxs-lookup"><span data-stu-id="7dc03-138">For more information about X.509 certificate validation, see [Working with Certificates](../../../../docs/framework/wcf/feature-details/working-with-certificates.md).</span></span>  
  
 <span data-ttu-id="7dc03-139">例如，将 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> 设置为 <xref:System.ServiceModel.Security.X509CertificateValidationMode.PeerTrust> 将对签名证书位于 `TrustedPeople` 证书存储中的任何已颁发令牌进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="7dc03-139">For example, setting the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A> to <xref:System.ServiceModel.Security.X509CertificateValidationMode.PeerTrust> would authenticate any issued token whose signing certificate is in the `TrustedPeople` certificate store.</span></span> <span data-ttu-id="7dc03-140">在这种情况下，请将 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.TrustedStoreLocation%2A> 属性设置为 <xref:System.Security.Cryptography.X509Certificates.StoreLocation.CurrentUser> 或 <xref:System.Security.Cryptography.X509Certificates.StoreLocation.LocalMachine>。</span><span class="sxs-lookup"><span data-stu-id="7dc03-140">In that case, set the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.TrustedStoreLocation%2A> property to either <xref:System.Security.Cryptography.X509Certificates.StoreLocation.CurrentUser> or <xref:System.Security.Cryptography.X509Certificates.StoreLocation.LocalMachine>.</span></span> <span data-ttu-id="7dc03-141">您可以选择其他模式，包括 <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>。</span><span class="sxs-lookup"><span data-stu-id="7dc03-141">You can select other modes, including <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>.</span></span> <span data-ttu-id="7dc03-142">如果选择了 `Custom`，则必须将 <xref:System.IdentityModel.Selectors.X509CertificateValidator> 类的一个实例分配给 <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CustomCertificateValidator%2A> 属性。</span><span class="sxs-lookup"><span data-stu-id="7dc03-142">When `Custom` is selected, you must assign an instance of the <xref:System.IdentityModel.Selectors.X509CertificateValidator> class to the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CustomCertificateValidator%2A> property.</span></span> <span data-ttu-id="7dc03-143">自定义验证程序可以使用它喜欢的任何条件来验证证书。</span><span class="sxs-lookup"><span data-stu-id="7dc03-143">The custom validator can validate certificates using any criteria it likes.</span></span> <span data-ttu-id="7dc03-144">有关详细信息，请参阅[如何：创建使用自定义证书验证程序的服务](../../../../docs/framework/wcf/extending/how-to-create-a-service-that-employs-a-custom-certificate-validator.md)。</span><span class="sxs-lookup"><span data-stu-id="7dc03-144">For more information, see [How to: Create a Service that Employs a Custom Certificate Validator](../../../../docs/framework/wcf/extending/how-to-create-a-service-that-employs-a-custom-certificate-validator.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7dc03-145">请参阅</span><span class="sxs-lookup"><span data-stu-id="7dc03-145">See also</span></span>

- [<span data-ttu-id="7dc03-146">联合</span><span class="sxs-lookup"><span data-stu-id="7dc03-146">Federation</span></span>](../../../../docs/framework/wcf/feature-details/federation.md)
- [<span data-ttu-id="7dc03-147">联合与信任</span><span class="sxs-lookup"><span data-stu-id="7dc03-147">Federation and Trust</span></span>](../../../../docs/framework/wcf/feature-details/federation-and-trust.md)
- [<span data-ttu-id="7dc03-148">联合示例</span><span class="sxs-lookup"><span data-stu-id="7dc03-148">Federation Sample</span></span>](../../../../docs/framework/wcf/samples/federation-sample.md)
- [<span data-ttu-id="7dc03-149">如何：禁用安全会话在 WSFederationHttpBinding 上</span><span class="sxs-lookup"><span data-stu-id="7dc03-149">How to: Disable Secure Sessions on a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-disable-secure-sessions-on-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="7dc03-150">如何：创建 WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="7dc03-150">How to: Create a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="7dc03-151">如何：创建联合客户端</span><span class="sxs-lookup"><span data-stu-id="7dc03-151">How to: Create a Federated Client</span></span>](../../../../docs/framework/wcf/feature-details/how-to-create-a-federated-client.md)
- [<span data-ttu-id="7dc03-152">使用证书</span><span class="sxs-lookup"><span data-stu-id="7dc03-152">Working with Certificates</span></span>](../../../../docs/framework/wcf/feature-details/working-with-certificates.md)
- [<span data-ttu-id="7dc03-153">SecurityBindingElement 身份验证模式</span><span class="sxs-lookup"><span data-stu-id="7dc03-153">SecurityBindingElement Authentication Modes</span></span>](../../../../docs/framework/wcf/feature-details/securitybindingelement-authentication-modes.md)
