---
title: 如何：创建联合客户端
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, federation
- federation
ms.assetid: 56ece47e-98bf-4346-b92b-fda1fc3b4d9c
ms.openlocfilehash: 19ffe7e3fb0de9b377279d9cd274f998a104c6b2
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/18/2019
ms.locfileid: "59303383"
---
# <a name="how-to-create-a-federated-client"></a><span data-ttu-id="39dbf-102">如何：创建联合客户端</span><span class="sxs-lookup"><span data-stu-id="39dbf-102">How to: Create a Federated Client</span></span>
<span data-ttu-id="39dbf-103">在 Windows Communication Foundation (WCF) 创建的客户端*联合服务*由三个主要步骤组成：</span><span class="sxs-lookup"><span data-stu-id="39dbf-103">In Windows Communication Foundation (WCF), creating a client for a *federated service* consists of three main steps:</span></span>  
  
1. <span data-ttu-id="39dbf-104">配置[ \<wsFederationHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md)或类似的自定义绑定。</span><span class="sxs-lookup"><span data-stu-id="39dbf-104">Configure a [\<wsFederationHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or similar custom binding.</span></span> <span data-ttu-id="39dbf-105">有关创建适当绑定的详细信息，请参阅[如何：创建 WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="39dbf-105">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="39dbf-106">或者，运行[ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)针对联合服务能够生成用于与联合的服务和一个或多个通信配置文件的元数据终结点安全令牌服务。</span><span class="sxs-lookup"><span data-stu-id="39dbf-106">Alternatively, run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) against the metadata endpoint of the federated service to generate a configuration file for communicating with the federated service and one or more security token services.</span></span>  
  
2. <span data-ttu-id="39dbf-107">设置 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 的属性，它可以控制客户端与安全令牌服务之间交互的各个方面。</span><span class="sxs-lookup"><span data-stu-id="39dbf-107">Set the properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> that controls various aspects of a client's interaction with a security token service.</span></span>  
  
3. <span data-ttu-id="39dbf-108">设置 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 的属性，它允许使用所需的证书来与给定终结点（例如安全令牌服务）进行安全通信。</span><span class="sxs-lookup"><span data-stu-id="39dbf-108">Set the properties of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential>, which allows certificates needed to communicate securely with given endpoints, such as security token services.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="39dbf-109">当客户端使用模拟凭据、<xref:System.Security.Cryptography.CryptographicException> 绑定或自定义颁发令牌以及非对称密钥时，可能会引发 <xref:System.ServiceModel.WSFederationHttpBinding>。</span><span class="sxs-lookup"><span data-stu-id="39dbf-109">A <xref:System.Security.Cryptography.CryptographicException> might be thrown when a client uses impersonated credentials, the <xref:System.ServiceModel.WSFederationHttpBinding> binding or a custom-issued token, and asymmetric keys.</span></span> <span data-ttu-id="39dbf-110">当将 <xref:System.ServiceModel.WSFederationHttpBinding> 和 <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> 属性分别设置为 <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> 时，将非对称密钥与 <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey> 绑定和自定义颁发令牌一起使用。</span><span class="sxs-lookup"><span data-stu-id="39dbf-110">Asymmetric keys are used with the <xref:System.ServiceModel.WSFederationHttpBinding> binding and custom-issued tokens when the <xref:System.ServiceModel.FederatedMessageSecurityOverHttp.IssuedKeyType%2A> and <xref:System.ServiceModel.Security.Tokens.IssuedSecurityTokenParameters.KeyType%2A> properties, respectively, are set to <xref:System.IdentityModel.Tokens.SecurityKeyType.AsymmetricKey>.</span></span> <span data-ttu-id="39dbf-111">当客户端尝试发送消息，而客户端模拟的标识不存在对应的用户配置文件时，将引发 <xref:System.Security.Cryptography.CryptographicException>。</span><span class="sxs-lookup"><span data-stu-id="39dbf-111">The <xref:System.Security.Cryptography.CryptographicException> is thrown when the client attempts to send a message and a user profile doesn’t exist for the identity that the client is impersonating.</span></span> <span data-ttu-id="39dbf-112">若要缓解此问题，请在发送消息之前登录客户端计算机或调用 `LoadUserProfile`。</span><span class="sxs-lookup"><span data-stu-id="39dbf-112">To mitigate this issue, log on to the client computer or call `LoadUserProfile` before sending the message.</span></span>  
  
 <span data-ttu-id="39dbf-113">本主题介绍有关这些过程的详细信息。</span><span class="sxs-lookup"><span data-stu-id="39dbf-113">This topic provides detailed information about these procedures.</span></span> <span data-ttu-id="39dbf-114">有关创建适当绑定的详细信息，请参阅[如何：创建 WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)。</span><span class="sxs-lookup"><span data-stu-id="39dbf-114">For more information about creating an appropriate binding, see [How to: Create a WSFederationHttpBinding](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md).</span></span> <span data-ttu-id="39dbf-115">有关联合的服务的工作原理的详细信息，请参阅[联合身份验证](../../../../docs/framework/wcf/feature-details/federation.md)。</span><span class="sxs-lookup"><span data-stu-id="39dbf-115">For more information about how a federated service works, see [Federation](../../../../docs/framework/wcf/feature-details/federation.md).</span></span>  
  
### <a name="to-generate-and-examine-the-configuration-for-a-federated-service"></a><span data-ttu-id="39dbf-116">生成并检查联合服务的配置</span><span class="sxs-lookup"><span data-stu-id="39dbf-116">To generate and examine the configuration for a federated service</span></span>  
  
1. <span data-ttu-id="39dbf-117">运行[ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)作为命令行参数的服务的元数据 URL 地址。</span><span class="sxs-lookup"><span data-stu-id="39dbf-117">Run the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) with the address of the metadata URL of the service as a command-line parameter.</span></span>  
  
2. <span data-ttu-id="39dbf-118">在适当的编辑器中打开生成的配置文件。</span><span class="sxs-lookup"><span data-stu-id="39dbf-118">Open the generated configuration file in an appropriate editor.</span></span>  
  
3. <span data-ttu-id="39dbf-119">检查属性和任何生成的内容[\<颁发者 >](../../../../docs/framework/configure-apps/file-schema/wcf/issuer.md)并[ \<issuerMetadata >](../../../../docs/framework/configure-apps/file-schema/wcf/issuermetadata.md)元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-119">Examine the attributes and content of any generated [\<issuer>](../../../../docs/framework/configure-apps/file-schema/wcf/issuer.md) and [\<issuerMetadata>](../../../../docs/framework/configure-apps/file-schema/wcf/issuermetadata.md) elements.</span></span> <span data-ttu-id="39dbf-120">这些是位于[\<安全 >](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md)元素[ \<wsFederationHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md)或自定义绑定元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-120">These are located within the [\<security>](../../../../docs/framework/configure-apps/file-schema/wcf/security-of-wsfederationhttpbinding.md) elements for the [\<wsFederationHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wsfederationhttpbinding.md) or custom bindings elements.</span></span> <span data-ttu-id="39dbf-121">确保地址包含所需的域名或其他地址信息。</span><span class="sxs-lookup"><span data-stu-id="39dbf-121">Ensure that the addresses contain the expected domain names or other address information.</span></span> <span data-ttu-id="39dbf-122">一定要检查此信息，因为客户端将对这些地址进行身份验证，可能会泄露信息（例如用户名/密码对）。</span><span class="sxs-lookup"><span data-stu-id="39dbf-122">It is important to check this information because the client authenticates to these addresses and may disclose information such as user name/password pairs.</span></span> <span data-ttu-id="39dbf-123">如果地址不是预期的地址，则会导致将信息泄漏给非目标接收方。</span><span class="sxs-lookup"><span data-stu-id="39dbf-123">If the address is not the expected address, this could result in information disclosure to an unintended recipient.</span></span>  
  
4. <span data-ttu-id="39dbf-124">检查任何其他[ \<issuedTokenParameters >](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md)元素内的带有注释掉 <`alternativeIssuedTokenParameters`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-124">Examine any additional [\<issuedTokenParameters>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md) elements inside the commented out <`alternativeIssuedTokenParameters`> element.</span></span> <span data-ttu-id="39dbf-125">当使用 Svcutil.exe 工具生成联合服务的配置时，如果联合服务或任何中间安全令牌服务没有指定颁发者地址，而是指定公开了多个终结点的安全令牌服务的元数据地址，则生成的配置文件将引用第一个终结点。</span><span class="sxs-lookup"><span data-stu-id="39dbf-125">When using the Svcutil.exe tool to generate configuration for a federated service, if the federated service or any intermediate security token services do not specify an issuer address, but rather specify a metadata address for a security token service that exposes multiple endpoints, the resulting configuration file refers to the first endpoint.</span></span> <span data-ttu-id="39dbf-126">其他终结点将在配置文件中作为注释掉的 <`alternativeIssuedTokenParameters`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-126">Additional endpoints are in the configuration file as commented-out <`alternativeIssuedTokenParameters`> elements.</span></span>  
  
     <span data-ttu-id="39dbf-127">确定其中是否有这些 <`issuedTokenParameters`> 优于配置中已存在的一个。</span><span class="sxs-lookup"><span data-stu-id="39dbf-127">Determine whether one of these <`issuedTokenParameters`> is preferable to the one already present in the configuration.</span></span> <span data-ttu-id="39dbf-128">例如，客户端可能倾向于使用 Windows [!INCLUDE[infocard](../../../../includes/infocard-md.md)] 令牌而非用户名/密码对来对安全令牌服务进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="39dbf-128">For example, the client may prefer to authenticate to a security token service using a Windows [!INCLUDE[infocard](../../../../includes/infocard-md.md)] token rather than a user name/password pair.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="39dbf-129">对于在与服务进行通信之前必须遍历多个安全令牌服务的情况，中间安全令牌服务有可能会将客户端引导到不正确的安全令牌服务。</span><span class="sxs-lookup"><span data-stu-id="39dbf-129">Where multiple security token services must be traversed before communicating with the service, it is possible for an intermediate security token service to direct the client to an incorrect security token service.</span></span> <span data-ttu-id="39dbf-130">因此，确保中的安全令牌服务的终结点[ \<issuedTokenParameters >](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md)是预期的安全令牌服务和不未知的安全令牌服务。</span><span class="sxs-lookup"><span data-stu-id="39dbf-130">Therefore, ensure that the endpoint for the security token service in the [\<issuedTokenParameters>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtokenparameters.md) is the expected security token service and not an unknown security token service.</span></span>  
  
### <a name="to-configure-an-issuedtokenclientcredential-in-code"></a><span data-ttu-id="39dbf-131">在代码中配置 IssuedTokenClientCredential</span><span class="sxs-lookup"><span data-stu-id="39dbf-131">To configure an IssuedTokenClientCredential in code</span></span>  
  
1. <span data-ttu-id="39dbf-132">通过 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 类的 <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> 属性（通过 <xref:System.ServiceModel.Description.ClientCredentials> 类的 <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> 属性或通过 <xref:System.ServiceModel.ClientBase%601> 类返回）访问 <xref:System.ServiceModel.ChannelFactory>，如以下示例代码中所示。</span><span class="sxs-lookup"><span data-stu-id="39dbf-132">Access the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.IssuedToken%2A> property of the <xref:System.ServiceModel.Description.ClientCredentials> class (returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, or through the <xref:System.ServiceModel.ChannelFactory> class), as shown in the following example code.</span></span>  
  
     [!code-csharp[c_CreateSTS#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#9)]
     [!code-vb[c_CreateSTS#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#9)]  
  
2. <span data-ttu-id="39dbf-133">如果不需要缓存令牌，则将 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> 属性设置为 `false`。</span><span class="sxs-lookup"><span data-stu-id="39dbf-133">If token caching is not required, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property to `false`.</span></span> <span data-ttu-id="39dbf-134"><xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> 属性控制是否缓存安全令牌服务中的这类令牌。</span><span class="sxs-lookup"><span data-stu-id="39dbf-134">The <xref:System.ServiceModel.Security.IssuedTokenClientCredential.CacheIssuedTokens%2A> property controls whether such tokens from a security token service are cached.</span></span> <span data-ttu-id="39dbf-135">如果将此属性设置为 `false`，则只要客户端必须向联合服务对自己重新进行身份验证，客户端就会从安全令牌服务请求一个新令牌，而不管上一个令牌是否仍然有效。</span><span class="sxs-lookup"><span data-stu-id="39dbf-135">If this property is set to `false`, the client requests a new token from the security token service whenever it must re-authenticate itself to the federated service, regardless of whether a previous token is still valid.</span></span> <span data-ttu-id="39dbf-136">如果将此属性设置为 `true`，则只要客户端必须向联合服务对自己重新进行身份验证，客户端就会重用现有的令牌（只要令牌未过期）。</span><span class="sxs-lookup"><span data-stu-id="39dbf-136">If this property is set to `true`, the client reuses an existing token whenever it must re-authenticate itself to the federated service (as long as the token has not expired).</span></span> <span data-ttu-id="39dbf-137">默认值为 `true`。</span><span class="sxs-lookup"><span data-stu-id="39dbf-137">The default is `true`.</span></span>  
  
3. <span data-ttu-id="39dbf-138">如果缓存令牌需要一个时间限制，则将 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> 属性设置为 <xref:System.TimeSpan> 值。</span><span class="sxs-lookup"><span data-stu-id="39dbf-138">If a time limit is required on cached tokens, set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.MaxIssuedTokenCachingTime%2A> property to a <xref:System.TimeSpan> value.</span></span> <span data-ttu-id="39dbf-139">该属性指定可以缓存令牌的时间。</span><span class="sxs-lookup"><span data-stu-id="39dbf-139">The property specifies how long a token can be cached.</span></span> <span data-ttu-id="39dbf-140">在指定的时间间隔结束之后，将从客户端缓存中移除令牌。</span><span class="sxs-lookup"><span data-stu-id="39dbf-140">After the specified time span has elapsed, the token is removed from the client cache.</span></span> <span data-ttu-id="39dbf-141">默认情况下，缓存令牌的时间将不限。</span><span class="sxs-lookup"><span data-stu-id="39dbf-141">By default, tokens are cached indefinitely.</span></span> <span data-ttu-id="39dbf-142">下面的示例将时间间隔设置为 10 分钟。</span><span class="sxs-lookup"><span data-stu-id="39dbf-142">The following example sets the time span to 10 minutes.</span></span>  
  
     [!code-csharp[c_CreateSTS#15](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#15)]
     [!code-vb[c_CreateSTS#15](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#15)]  
  
4. <span data-ttu-id="39dbf-143">可选。</span><span class="sxs-lookup"><span data-stu-id="39dbf-143">Optional.</span></span> <span data-ttu-id="39dbf-144">将 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> 设置为一个百分比。</span><span class="sxs-lookup"><span data-stu-id="39dbf-144">Set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> to a percentage.</span></span> <span data-ttu-id="39dbf-145">默认值为 60（百分比）。</span><span class="sxs-lookup"><span data-stu-id="39dbf-145">The default is 60 (percent).</span></span> <span data-ttu-id="39dbf-146">该属性指定令牌有效期的百分比。</span><span class="sxs-lookup"><span data-stu-id="39dbf-146">The property specifies a percentage of the token's validity period.</span></span> <span data-ttu-id="39dbf-147">例如，如果颁发的令牌在 10 个小时内有效，并将 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> 设置为 80，则在 8 小时后续订令牌。</span><span class="sxs-lookup"><span data-stu-id="39dbf-147">For example, if the issued token is valid for 10 hours and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuedTokenRenewalThresholdPercentage%2A> is set to 80, then the token is renewed after eight hours.</span></span> <span data-ttu-id="39dbf-148">下面的示例将值设置为 80％。</span><span class="sxs-lookup"><span data-stu-id="39dbf-148">The following example sets the value to 80 percent.</span></span>  
  
     [!code-csharp[c_CreateSTS#16](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#16)]
     [!code-vb[c_CreateSTS#16](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#16)]  
  
     <span data-ttu-id="39dbf-149">在缓存时间少于续订阈值时间的情况下，`IssuedTokenRenewalThresholdPercentage` 值将重写通过令牌有效期和 `MaxIssuedTokenCachingTime` 值确定的续订时间间隔。</span><span class="sxs-lookup"><span data-stu-id="39dbf-149">The renewal interval determined by the token validity period and the `IssuedTokenRenewalThresholdPercentage` value is overridden by the `MaxIssuedTokenCachingTime` value in cases where the caching time is shorter than the renewal threshold time.</span></span> <span data-ttu-id="39dbf-150">例如，如果 `IssuedTokenRenewalThresholdPercentage` 与令牌持续时间的乘积是 8 个小时，而 `MaxIssuedTokenCachingTime` 值为 10 分钟，则客户端每 10 分钟就会联系安全令牌服务以获取更新的令牌。</span><span class="sxs-lookup"><span data-stu-id="39dbf-150">For example, if the product of `IssuedTokenRenewalThresholdPercentage` and the token's duration is eight hours, and the `MaxIssuedTokenCachingTime` value is 10 minutes, the client contacts the security token service for an updated token every 10 minutes.</span></span>  
  
5. <span data-ttu-id="39dbf-151">如果在一个绑定上需要除 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy> 之外的密钥平均信息量模式，并且该绑定对消息凭据不使用消息安全或传输安全（例如，</span><span class="sxs-lookup"><span data-stu-id="39dbf-151">If a key entropy mode other than <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy> is needed on a binding that does not use message security or transport security with message credentials (for example.</span></span> <span data-ttu-id="39dbf-152">该绑定没有 <xref:System.ServiceModel.Channels.SecurityBindingElement>），则将 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> 属性设置为适当的值。</span><span class="sxs-lookup"><span data-stu-id="39dbf-152">the binding does not have a <xref:System.ServiceModel.Channels.SecurityBindingElement>), set the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property to an appropriate value.</span></span> <span data-ttu-id="39dbf-153">*平均信息量*模式将确定是否可以使用控制对称密钥<xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A>属性。</span><span class="sxs-lookup"><span data-stu-id="39dbf-153">The *entropy* mode determines whether symmetric keys can be controlled using the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> property.</span></span> <span data-ttu-id="39dbf-154">此默认值为 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>，其中，客户端和令牌颁发者都提供数据，并将这些数据组合在一起以生成实际密钥。</span><span class="sxs-lookup"><span data-stu-id="39dbf-154">This default is <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.CombinedEntropy>, where both the client and the token issuer provide data that is combined to produce the actual key.</span></span> <span data-ttu-id="39dbf-155">其他值为 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> 和 <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>，这意味着整个密钥由客户端或服务器分别指定。</span><span class="sxs-lookup"><span data-stu-id="39dbf-155">Other values are <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ClientEntropy> and <xref:System.ServiceModel.Security.SecurityKeyEntropyMode.ServerEntropy>, which means the entire key is specified by the client or the server, respectively.</span></span> <span data-ttu-id="39dbf-156">下面的示例将该属性设置为只使用服务器数据来生成密钥。</span><span class="sxs-lookup"><span data-stu-id="39dbf-156">The following example sets the property to use only the server data for the key.</span></span>  
  
     [!code-csharp[c_CreateSTS#17](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#17)]
     [!code-vb[c_CreateSTS#17](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#17)]  
  
    > [!NOTE]
    >  <span data-ttu-id="39dbf-157">如果在安全令牌服务或服务绑定中存在 <xref:System.ServiceModel.Channels.SecurityBindingElement>，则通过 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> 的 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 属性来重写 <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> 上的 `SecurityBindingElement` 集。</span><span class="sxs-lookup"><span data-stu-id="39dbf-157">If a <xref:System.ServiceModel.Channels.SecurityBindingElement> is present in a security token service or service binding, the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.DefaultKeyEntropyMode%2A> set on <xref:System.ServiceModel.Security.IssuedTokenClientCredential> is overridden by the <xref:System.ServiceModel.Channels.SecurityBindingElement.KeyEntropyMode%2A> property of the `SecurityBindingElement`.</span></span>  
  
6. <span data-ttu-id="39dbf-158">配置任何特定于颁发者的终结点行为，方法是将这些行为添加到由 <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A> 属性返回的集合中。</span><span class="sxs-lookup"><span data-stu-id="39dbf-158">Configure any issuer-specific endpoint behaviors by adding them to the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.IssuerChannelBehaviors%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#14](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#14)]
     [!code-vb[c_CreateSTS#14](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#14)]  
  
### <a name="to-configure-the-issuedtokenclientcredential-in-configuration"></a><span data-ttu-id="39dbf-159">在配置中配置 IssuedTokenClientCredential</span><span class="sxs-lookup"><span data-stu-id="39dbf-159">To configure the IssuedTokenClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="39dbf-160">创建[ \<issuedToken >](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md)的子元素[ \<issuedToken >](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md)中的终结点行为元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-160">Create an [\<issuedToken>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md) element as a child of the [\<issuedToken>](../../../../docs/framework/configure-apps/file-schema/wcf/issuedtoken.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="39dbf-161">如果不需要缓存令牌，设置`cacheIssuedTokens`属性 (的 <`issuedToken`> 元素) 到`false`。</span><span class="sxs-lookup"><span data-stu-id="39dbf-161">If token caching is not required, set the `cacheIssuedTokens` attribute (of the <`issuedToken`> element) to `false`.</span></span>  
  
3. <span data-ttu-id="39dbf-162">如果缓存令牌需要一个时间限制，设置`maxIssuedTokenCachingTime`特性，可以在 <`issuedToken`> 为适当的值的元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-162">If a time limit is required on cached tokens, set the `maxIssuedTokenCachingTime` attribute on the <`issuedToken`> element to an appropriate value.</span></span> <span data-ttu-id="39dbf-163">例如：</span><span class="sxs-lookup"><span data-stu-id="39dbf-163">For example:</span></span>  
    `<issuedToken maxIssuedTokenCachingTime='00:10:00' />`  
  
4. <span data-ttu-id="39dbf-164">如果首选非默认值，则设置`issuedTokenRenewalThresholdPercentage`特性，可以在 <`issuedToken`> 元素为适当的值，例如：</span><span class="sxs-lookup"><span data-stu-id="39dbf-164">If a value other than the default is preferred, set the `issuedTokenRenewalThresholdPercentage` attribute on the <`issuedToken`> element to an appropriate value, for example:</span></span>  
  
    ```xml  
    <issuedToken issuedTokenRenewalThresholdPercentage = "80" />  
    ```  
  
5. <span data-ttu-id="39dbf-165">如果在一个绑定上需要除 `CombinedEntropy` 之外的密钥平均信息量模式，并且该绑定对消息凭据不使用消息安全或传输安全（例如，该绑定没有 `SecurityBindingElement`），则根据需要将 `defaultKeyEntropyMode` 元素上的 `<issuedToken>` 属性设置为 `ServerEntropy` 或 `ClientEntropy`。</span><span class="sxs-lookup"><span data-stu-id="39dbf-165">If a key entropy mode other than `CombinedEntropy` is on a binding that does not use message security or transport security with message credentials (for example, the binding does not have a `SecurityBindingElement`), set the `defaultKeyEntropyMode` attribute on the `<issuedToken>` element to a either `ServerEntropy` or `ClientEntropy` as required.</span></span>  
  
    ```xml  
    <issuedToken defaultKeyEntropyMode = "ServerEntropy" />  
    ```  
  
6. <span data-ttu-id="39dbf-166">可选。</span><span class="sxs-lookup"><span data-stu-id="39dbf-166">Optional.</span></span> <span data-ttu-id="39dbf-167">通过创建配置任何特定于颁发者的自定义终结点行为 <`issuerChannelBehaviors`> 的子元素 <`issuedToken`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-167">Configure any issuer-specific custom endpoint behavior by creating an <`issuerChannelBehaviors`> element as a child of the <`issuedToken`> element.</span></span> <span data-ttu-id="39dbf-168">对于每个行为，创建 <`add`> 的子元素 <`issuerChannelBehaviors`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-168">For each behavior, create an <`add`> element as a child of the <`issuerChannelBehaviors`> element.</span></span> <span data-ttu-id="39dbf-169">通过设置指定的行为的颁发者地址`issuerAddress`特性，可以在 <`add`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-169">Specify the issuer address of the behavior by setting the `issuerAddress` attribute on the <`add`> element.</span></span> <span data-ttu-id="39dbf-170">通过设置指定行为本身`behaviorConfiguration`特性，可以在 <`add`> 元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-170">Specify the behavior itself by setting the `behaviorConfiguration` attribute on the <`add`> element.</span></span>  
  
    ```xml  
    <issuerChannelBehaviors>  
    <add issuerAddress="http://fabrikam.org/sts" behaviorConfiguration="FabrikamSTS" />  
    </issuerChannelBehaviors>  
    ```  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-code"></a><span data-ttu-id="39dbf-171">在代码中配置 X509CertificateRecipientClientCredential</span><span class="sxs-lookup"><span data-stu-id="39dbf-171">To configure an X509CertificateRecipientClientCredential in code</span></span>  
  
1. <span data-ttu-id="39dbf-172">通过 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 类的 <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> 属性的 <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> 属性或 <xref:System.ServiceModel.ClientBase%601> 属性来访问 <xref:System.ServiceModel.ChannelFactory>。</span><span class="sxs-lookup"><span data-stu-id="39dbf-172">Access the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> through the <xref:System.ServiceModel.Description.ClientCredentials.ServiceCertificate%2A> property of the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class or the <xref:System.ServiceModel.ChannelFactory> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#18](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#18)]
     [!code-vb[c_CreateSTS#18](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#18)]  
  
2. <span data-ttu-id="39dbf-173">如果 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 实例可用于给定终结点的证书，则使用通过 <xref:System.Collections.Generic.ICollection%601.Add%2A> 属性返回的集合的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="39dbf-173">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is available for the certificate for a given endpoint, use the <xref:System.Collections.Generic.ICollection%601.Add%2A> method of the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
     [!code-csharp[c_CreateSTS#19](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#19)]
     [!code-vb[c_CreateSTS#19](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#19)]  
  
3. <span data-ttu-id="39dbf-174">如果 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 实例不可用，则使用 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> 类的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 方法，如以下示例中所示。</span><span class="sxs-lookup"><span data-stu-id="39dbf-174">If an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> instance is not available, use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class as shown in the following example.</span></span>  
  
     [!code-csharp[c_CreateSTS#20](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_creatests/cs/source.cs#20)]
     [!code-vb[c_CreateSTS#20](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_creatests/vb/source.vb#20)]  
  
### <a name="to-configure-an-x509certificaterecipientclientcredential-in-configuration"></a><span data-ttu-id="39dbf-175">在配置中配置 X509CertificateRecipientClientCredential</span><span class="sxs-lookup"><span data-stu-id="39dbf-175">To configure an X509CertificateRecipientClientCredential in configuration</span></span>  
  
1. <span data-ttu-id="39dbf-176">创建[ \<scopedCertificates >](../../../../docs/framework/configure-apps/file-schema/wcf/scopedcertificates-element.md)的子元素[ \<serviceCertificate >](../../../../docs/framework/configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md)是自身的子级的元素[ \<clientCredentials >](../../../../docs/framework/configure-apps/file-schema/wcf/clientcredentials.md)中的终结点行为元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-176">Create a [\<scopedCertificates>](../../../../docs/framework/configure-apps/file-schema/wcf/scopedcertificates-element.md) element as a child of the [\<serviceCertificate>](../../../../docs/framework/configure-apps/file-schema/wcf/servicecertificate-of-clientcredentials-element.md) element that is itself a child of the [\<clientCredentials>](../../../../docs/framework/configure-apps/file-schema/wcf/clientcredentials.md) element in an endpoint behavior.</span></span>  
  
2. <span data-ttu-id="39dbf-177">创建一个 `<add>` 元素，作为 `<scopedCertificates>` 元素的子元素。</span><span class="sxs-lookup"><span data-stu-id="39dbf-177">Create an `<add>` element as a child of the `<scopedCertificates>` element.</span></span> <span data-ttu-id="39dbf-178">指定 `storeLocation`、`storeName`、`x509FindType` 和 `findValue` 属性的值以引用适当的证书。</span><span class="sxs-lookup"><span data-stu-id="39dbf-178">Specify values for the `storeLocation`, `storeName`, `x509FindType`, and `findValue` attributes to refer to the appropriate certificate.</span></span> <span data-ttu-id="39dbf-179">将 `targetUri` 属性设置为一个值，该值提供证书所要用于的终结点的地址，如以下示例中所示。</span><span class="sxs-lookup"><span data-stu-id="39dbf-179">Set the `targetUri` attribute to a value that provides the address of the endpoint that the certificate is to be used for, as shown in the following example.</span></span>  
  
    ```xml  
    <scopedCertificates>  
     <add targetUri="http://fabrikam.com/sts"   
          storeLocation="CurrentUser"  
          storeName="TrustedPeople"  
          x509FindType="FindBySubjectName"  
          findValue="FabrikamSTS" />  
    </scopedCertificates>  
    ```  
  
## <a name="example"></a><span data-ttu-id="39dbf-180">示例</span><span class="sxs-lookup"><span data-stu-id="39dbf-180">Example</span></span>  
 <span data-ttu-id="39dbf-181">下面的代码示例在代码中配置 <xref:System.ServiceModel.Security.IssuedTokenClientCredential> 类的实例。</span><span class="sxs-lookup"><span data-stu-id="39dbf-181">The following code sample configures an instance of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class in code.</span></span>  
  
 [!code-csharp[c_FederatedClient#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_federatedclient/cs/source.cs#2)]
 [!code-vb[c_FederatedClient#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_federatedclient/vb/source.vb#2)]  
  
## <a name="net-framework-security"></a><span data-ttu-id="39dbf-182">.NET Framework 安全性</span><span class="sxs-lookup"><span data-stu-id="39dbf-182">.NET Framework Security</span></span>  
 <span data-ttu-id="39dbf-183">要防止可能的信息泄漏，运行 Svcutil.exe 工具以处理联合终结点中的元数据的客户端应确保生成的安全令牌服务地址是预期的地址。</span><span class="sxs-lookup"><span data-stu-id="39dbf-183">To prevent possible information disclosure, clients that are running the Svcutil.exe tool to process metadata from federated endpoints should ensure that the resulting security token service addresses are what they expect.</span></span> <span data-ttu-id="39dbf-184">在安全令牌服务公开多个终结点时，这一点尤为重要，因为 Svcutil.exe 工具产生的最终配置文件会使用第一个此类终结点，而该终结点有可能不是客户端应在使用的那个终结点。</span><span class="sxs-lookup"><span data-stu-id="39dbf-184">This is especially important when a security token service exposes multiple endpoints, because the Svcutil.exe tool generates the resulting configuration file to use the first such endpoint, which may not be the one the client should be using.</span></span>  
  
## <a name="localissuer-required"></a><span data-ttu-id="39dbf-185">必需的 LocalIssuer</span><span class="sxs-lookup"><span data-stu-id="39dbf-185">LocalIssuer Required</span></span>  
 <span data-ttu-id="39dbf-186">如果客户端始终应使用一个本地颁发者，则请注意以下事项：如果链中的倒数第二个安全令牌服务指定了一个颁发者地址或颁发者元数据地址，则 Svcutil.exe 的默认输出会导致使用的不是本地颁发者。</span><span class="sxs-lookup"><span data-stu-id="39dbf-186">If clients are expected to always use a local issuer, note the following: the default output of Svcutil.exe results in the local issuer not being used if the second-to-last security token service in the chain specifies an issuer address or issuer metadata address.</span></span>  
  
 <span data-ttu-id="39dbf-187">有关设置的详细信息<xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A>， <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A>，并<xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A>的属性<xref:System.ServiceModel.Security.IssuedTokenClientCredential>类，请参阅[如何：配置本地颁发者](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md)。</span><span class="sxs-lookup"><span data-stu-id="39dbf-187">For more information about setting the <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerAddress%2A>, <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerBinding%2A>, and <xref:System.ServiceModel.Security.IssuedTokenClientCredential.LocalIssuerChannelBehaviors%2A> properties of the <xref:System.ServiceModel.Security.IssuedTokenClientCredential> class, see [How to: Configure a Local Issuer](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md).</span></span>  
  
## <a name="scoped-certificates"></a><span data-ttu-id="39dbf-188">作用域证书</span><span class="sxs-lookup"><span data-stu-id="39dbf-188">Scoped Certificates</span></span>  
 <span data-ttu-id="39dbf-189">如果必须指定服务证书才能与任何安全令牌服务进行通信，则通常是因为没有使用证书协商，可以使用 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 类的 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> 属性来指定证书。</span><span class="sxs-lookup"><span data-stu-id="39dbf-189">If service certificates must be specified for communicating with any of the security token services, typically because certificate negotiation is not being used, they can be specified using the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property of the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential> class.</span></span> <span data-ttu-id="39dbf-190"><xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> 方法采用 <xref:System.Uri> 和 <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> 作为参数。</span><span class="sxs-lookup"><span data-stu-id="39dbf-190">The <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetDefaultCertificate%2A> method takes a <xref:System.Uri> and an <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> as parameters.</span></span> <span data-ttu-id="39dbf-191">在与指定的 URI 处的终结点进行通信时将使用指定的证书。</span><span class="sxs-lookup"><span data-stu-id="39dbf-191">The specified certificate is used when communicating with endpoints at the specified URI.</span></span> <span data-ttu-id="39dbf-192">或者，可以使用 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> 方法将证书添加到由 <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> 属性返回的集合中。</span><span class="sxs-lookup"><span data-stu-id="39dbf-192">Alternatively, you can use the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.SetScopedCertificate%2A> method to add a certificate to the collection returned by the <xref:System.ServiceModel.Security.X509CertificateRecipientClientCredential.ScopedCertificates%2A> property.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="39dbf-193">作用域限定为给定的 URI 的证书的客户端想法仅适用于对服务（这些服务公开这些 URI 处的终结点）进行出站调用的应用程序。</span><span class="sxs-lookup"><span data-stu-id="39dbf-193">The client idea of certificates that are scoped to a given URI applies only to applications that are making outbound calls to services that expose endpoints at those URIs.</span></span> <span data-ttu-id="39dbf-194">它不会应用于用来签署颁发的令牌，例如那些通过返回的集合中在服务器上配置的证书<xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A>的<xref:System.ServiceModel.Security.IssuedTokenServiceCredential>类。</span><span class="sxs-lookup"><span data-stu-id="39dbf-194">It does not apply to certificates that are used to sign issued tokens, such as those configured on the server in the collection returned by the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential.KnownCertificates%2A> of the <xref:System.ServiceModel.Security.IssuedTokenServiceCredential> class.</span></span> <span data-ttu-id="39dbf-195">有关详细信息，请参阅[如何：联合身份验证服务上配置凭据](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md)。</span><span class="sxs-lookup"><span data-stu-id="39dbf-195">For more information, see [How to: Configure Credentials on a Federation Service](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="39dbf-196">请参阅</span><span class="sxs-lookup"><span data-stu-id="39dbf-196">See also</span></span>

- [<span data-ttu-id="39dbf-197">联合示例</span><span class="sxs-lookup"><span data-stu-id="39dbf-197">Federation Sample</span></span>](../../../../docs/framework/wcf/samples/federation-sample.md)
- [<span data-ttu-id="39dbf-198">如何：禁用安全会话在 WSFederationHttpBinding 上</span><span class="sxs-lookup"><span data-stu-id="39dbf-198">How to: Disable Secure Sessions on a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-disable-secure-sessions-on-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="39dbf-199">如何：创建 WSFederationHttpBinding</span><span class="sxs-lookup"><span data-stu-id="39dbf-199">How to: Create a WSFederationHttpBinding</span></span>](../../../../docs/framework/wcf/feature-details/how-to-create-a-wsfederationhttpbinding.md)
- [<span data-ttu-id="39dbf-200">如何：联合身份验证服务上配置凭据</span><span class="sxs-lookup"><span data-stu-id="39dbf-200">How to: Configure Credentials on a Federation Service</span></span>](../../../../docs/framework/wcf/feature-details/how-to-configure-credentials-on-a-federation-service.md)
- [<span data-ttu-id="39dbf-201">如何：配置本地颁发者</span><span class="sxs-lookup"><span data-stu-id="39dbf-201">How to: Configure a Local Issuer</span></span>](../../../../docs/framework/wcf/feature-details/how-to-configure-a-local-issuer.md)
- [<span data-ttu-id="39dbf-202">元数据的安全性注意事项</span><span class="sxs-lookup"><span data-stu-id="39dbf-202">Security Considerations with Metadata</span></span>](../../../../docs/framework/wcf/feature-details/security-considerations-with-metadata.md)
- [<span data-ttu-id="39dbf-203">如何：保护元数据终结点</span><span class="sxs-lookup"><span data-stu-id="39dbf-203">How to: Secure Metadata Endpoints</span></span>](../../../../docs/framework/wcf/feature-details/how-to-secure-metadata-endpoints.md)
