---
title: Windows 窗体和非托管应用程序概述
ms.date: 03/30/2017
helpviewer_keywords:
- COM [Windows Forms]
- Windows Forms, unmanaged
- COM interop
- ActiveX controls [Windows Forms], about ActiveX controls
- Windows Forms, interop
ms.assetid: 0a26d99d-8135-4895-8760-c9a2b5f67f14
ms.openlocfilehash: fc8e55d8f3824ca11c575479863491d7f949efa3
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2019
ms.locfileid: "64665848"
---
# <a name="windows-forms-and-unmanaged-applications-overview"></a><span data-ttu-id="1c013-102">Windows 窗体和非托管应用程序概述</span><span class="sxs-lookup"><span data-stu-id="1c013-102">Windows Forms and Unmanaged Applications Overview</span></span>
<span data-ttu-id="1c013-103">Windows 窗体应用程序和控件可以与非托管应用程序进行互操作，但有一些需要注意的问题。</span><span class="sxs-lookup"><span data-stu-id="1c013-103">Windows Forms applications and controls can interoperate with unmanaged applications, with some caveats.</span></span> <span data-ttu-id="1c013-104">以下各节将介绍 Windows 窗体应用程序和控件支持和不支持的方案和配置。</span><span class="sxs-lookup"><span data-stu-id="1c013-104">The following sections describe the scenarios and configurations that Windows Forms applications and controls support and those that they do not support.</span></span>  
  
## <a name="windows-forms-controls-and-activex-applications"></a><span data-ttu-id="1c013-105">Windows 窗体控件和 ActiveX 应用程序</span><span class="sxs-lookup"><span data-stu-id="1c013-105">Windows Forms Controls and ActiveX Applications</span></span>  
 <span data-ttu-id="1c013-106">由于存在 Microsoft Internet Explorer 和 Microsoft 基础类 (MFC) 的异常，因此，在为了托管 ActiveX 控件而设计的应用程序中不支持 Windows 窗体控件。</span><span class="sxs-lookup"><span data-stu-id="1c013-106">With the exception of Microsoft Internet Explorer and Microsoft Foundation Classes (MFC), Windows Forms controls are not supported in applications designed to host ActiveX controls.</span></span> <span data-ttu-id="1c013-107">在能够托管 ActiveX 控件的其他应用程序和开发工具（包括早于 Visual Studio .NET 2003 的 Visual Studio 版本中的 ActiveX 测试容器）中也不支持托管 Windows 窗体控件。</span><span class="sxs-lookup"><span data-stu-id="1c013-107">Other applications and development tools that are capable of hosting ActiveX controls, including the ActiveX test containers from versions of Visual Studio that are earlier than Visual Studio .NET 2003, are not supported hosts for Windows Forms controls.</span></span>  
  
 <span data-ttu-id="1c013-108">这些约束还适用于通过组件对象模型 COM 互操作来使用 Windows 窗体控件的情况。</span><span class="sxs-lookup"><span data-stu-id="1c013-108">These constraints also apply to the use of Windows Forms controls through Component Object Model COM interop.</span></span> <span data-ttu-id="1c013-109">只在 Internet Explorer 中支持通过 COM 可调用包装器 (CCW) 来使用 Windows 窗体控件。</span><span class="sxs-lookup"><span data-stu-id="1c013-109">The use of a Windows Forms control through a COM callable wrapper (CCW) is supported only in Internet Explorer.</span></span> <span data-ttu-id="1c013-110">有关 COM 互操作的详细信息，请参阅</span><span class="sxs-lookup"><span data-stu-id="1c013-110">For more information about COM interop, see</span></span>  
  
 <span data-ttu-id="1c013-111">[COM Interop](../../../visual-basic/programming-guide/com-interop/index.md)。</span><span class="sxs-lookup"><span data-stu-id="1c013-111">[COM Interop](../../../visual-basic/programming-guide/com-interop/index.md).</span></span>  
  
 <span data-ttu-id="1c013-112">下表显示了对 Windows 窗体控件的可用 ActiveX 托管支持。</span><span class="sxs-lookup"><span data-stu-id="1c013-112">The following table shows the available ActiveX hosting support for Windows Forms controls.</span></span>  
  
|<span data-ttu-id="1c013-113">Windows 窗体版本</span><span class="sxs-lookup"><span data-stu-id="1c013-113">Windows Forms version</span></span>|<span data-ttu-id="1c013-114">支持</span><span class="sxs-lookup"><span data-stu-id="1c013-114">Support</span></span>|  
|---------------------------|-------------|  
|<span data-ttu-id="1c013-115">.NET Framework 版本 1.0</span><span class="sxs-lookup"><span data-stu-id="1c013-115">.NET Framework version 1.0</span></span>|<span data-ttu-id="1c013-116">Internet Explorer 5.01 和更高版本</span><span class="sxs-lookup"><span data-stu-id="1c013-116">Internet Explorer 5.01 and later versions</span></span>|  
|<span data-ttu-id="1c013-117">.NET Framework 版本 1.1 和更高版本</span><span class="sxs-lookup"><span data-stu-id="1c013-117">.NET Framework version 1.1 and later</span></span>|<span data-ttu-id="1c013-118">Internet Explorer 5.01 和更高版本</span><span class="sxs-lookup"><span data-stu-id="1c013-118">Internet Explorer 5.01 and later versions</span></span><br /><br /> <span data-ttu-id="1c013-119">Microsoft 基础类 (MFC) 7.0 和更高版本</span><span class="sxs-lookup"><span data-stu-id="1c013-119">Microsoft Foundation Classes (MFC) 7.0 and later</span></span>|  
  
## <a name="hosting-windows-forms-components-as-activex-controls"></a><span data-ttu-id="1c013-120">作为 ActiveX 控件托管 Windows 窗体组件</span><span class="sxs-lookup"><span data-stu-id="1c013-120">Hosting Windows Forms components as ActiveX controls</span></span>  
 <span data-ttu-id="1c013-121">在.NET Framework 1.1 中，此支持已扩展到包括 MFC 7.0 和更高版本。</span><span class="sxs-lookup"><span data-stu-id="1c013-121">In the .NET Framework 1.1, support was extended to include MFC 7.0 and later versions.</span></span> <span data-ttu-id="1c013-122">此支持包括与 MFC 7.0 和更高版本的 ActiveX 控件容器完全兼容的任何容器。</span><span class="sxs-lookup"><span data-stu-id="1c013-122">This support includes any container that is fully compatible with the MFC 7.0 and later ActiveX control container.</span></span>  
  
 <span data-ttu-id="1c013-123">但是，不支持将 Windows 窗体控件注册为 ActiveX 控件。</span><span class="sxs-lookup"><span data-stu-id="1c013-123">However, registration of Windows Forms controls as ActiveX controls is not supported.</span></span> <span data-ttu-id="1c013-124">此外，不支持调用 Windows 窗体控件的 `com.ms.win32.Ole32.CoCreateInstance` 方法。</span><span class="sxs-lookup"><span data-stu-id="1c013-124">Also, calling the `com.ms.win32.Ole32.CoCreateInstance` method for Windows Forms controls is not supported.</span></span> <span data-ttu-id="1c013-125">仅支持对 Windows 窗体控件进行托管激活。</span><span class="sxs-lookup"><span data-stu-id="1c013-125">Only managed activation of Windows Forms controls is supported.</span></span> <span data-ttu-id="1c013-126">一旦创建了 Windows 窗体控件，即可按与 ActiveX 控件完全相同的方式在 MFC 应用程序上托管它。</span><span class="sxs-lookup"><span data-stu-id="1c013-126">Once you create a Windows Forms control, you can host it in an MFC application just as with an ActiveX control.</span></span>  
  
 <span data-ttu-id="1c013-127">若要在非托管应用程序中使用 Windows 窗体控件，必须使用非托管 CLR 托管 API 来托管 CLR，或使用 C++ 互操作功能。</span><span class="sxs-lookup"><span data-stu-id="1c013-127">To use Windows Forms controls in your unmanaged application, you must either host the CLR using the unmanaged CLR hosting APIs or use the C++ interop features.</span></span> <span data-ttu-id="1c013-128">使用 C++ 互操作功能是建议采用的解决方案。</span><span class="sxs-lookup"><span data-stu-id="1c013-128">Using the C++ interop features is the recommended solution.</span></span>  
  
## <a name="windows-forms-in-com-client-applications"></a><span data-ttu-id="1c013-129">COM 客户端应用程序中的 Windows 窗体</span><span class="sxs-lookup"><span data-stu-id="1c013-129">Windows Forms in COM client applications</span></span>  
 <span data-ttu-id="1c013-130">从 COM 客户端应用程序（例如，Visual Basic 6.0 应用程序或 MFC 应用程序）打开 Windows 窗体时，窗体可能出现意外行为。</span><span class="sxs-lookup"><span data-stu-id="1c013-130">When you open a Windows Form from a COM client application, such as a Visual Basic 6.0 application or an MFC application, the form may behave unexpectedly.</span></span> <span data-ttu-id="1c013-131">例如，当你按 Tab 键时，焦点不会从一个控件更改到另一个控件。</span><span class="sxs-lookup"><span data-stu-id="1c013-131">For example, when you press the TAB key, the focus does not change from one control to another control.</span></span> <span data-ttu-id="1c013-132">或者当你在命令按钮有焦点的情况下按 Enter 键时，无法引发按钮的 <xref:System.Windows.Forms.Control.Click> 事件。</span><span class="sxs-lookup"><span data-stu-id="1c013-132">When you press the ENTER key while a command button has focus, the button's <xref:System.Windows.Forms.Control.Click> event is not raised.</span></span> <span data-ttu-id="1c013-133">还可能遇到击键或鼠标操作的其他意外行为。</span><span class="sxs-lookup"><span data-stu-id="1c013-133">You may also experience unexpected behavior for keystrokes or mouse activity.</span></span>  
  
 <span data-ttu-id="1c013-134">发生此行为是因为非托管应用程序没有实现消息循环支持，而 Windows 窗体需要该支持才能正确工作。</span><span class="sxs-lookup"><span data-stu-id="1c013-134">This behavior occurs because the unmanaged application does not implement the message loop support that Windows Forms requires to work correctly.</span></span> <span data-ttu-id="1c013-135">COM 客户端应用程序所提供的消息循环根本不同于 Windows 窗体消息循环。</span><span class="sxs-lookup"><span data-stu-id="1c013-135">The message loop provided by the COM client application is fundamentally different from the Windows Forms message loop.</span></span>  
  
 <span data-ttu-id="1c013-136">应用程序的消息循环是内部程序循环，它从线程的消息队列检索消息，然后转换这些消息，之后将它们发送给要处理的应用程序。</span><span class="sxs-lookup"><span data-stu-id="1c013-136">An application's message loop is an internal program loop that retrieves messages from a thread's message queue, translates them, and then sends them to the application to be handled.</span></span> <span data-ttu-id="1c013-137">Windows 窗体的消息循环与更早的应用程序（例如，Visual Basic 6.0 应用程序和 MFC 应用程序）所提供的消息循环的体系结构不同。</span><span class="sxs-lookup"><span data-stu-id="1c013-137">The message loop for a Windows Form does not have the same architecture as message loops that earlier applications, such as Visual Basic 6.0 applications and MFC applications, provide.</span></span> <span data-ttu-id="1c013-138">发布到消息循环的窗口消息的处理方式可能与 Windows 窗体期望的不同。</span><span class="sxs-lookup"><span data-stu-id="1c013-138">The window messages that are posted to the message loop may be handled differently than the Windows Form expects.</span></span> <span data-ttu-id="1c013-139">因此，可能发生意外的行为。</span><span class="sxs-lookup"><span data-stu-id="1c013-139">Therefore, unexpected behavior may occur.</span></span> <span data-ttu-id="1c013-140">某些击键组合可能不起作用，某些鼠标活动可能不工作，或者某些事件可能不会按期望引发。</span><span class="sxs-lookup"><span data-stu-id="1c013-140">Some keystroke combinations may not work, some mouse activity may not work, or some events may not be raised as expected.</span></span>  
  
## <a name="resolving-interoperability-issues"></a><span data-ttu-id="1c013-141">解决互操作性问题</span><span class="sxs-lookup"><span data-stu-id="1c013-141">Resolving Interoperability Issues</span></span>  
 <span data-ttu-id="1c013-142">可以通过在 [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] 消息循环（它是使用 <xref:System.Windows.Forms.Application.Run%2A?displayProperty=nameWithType> 方法创建的）上显示窗体来解决这些问题。</span><span class="sxs-lookup"><span data-stu-id="1c013-142">You can resolve these problems by displaying the form on a [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] message loop, which is created by using the <xref:System.Windows.Forms.Application.Run%2A?displayProperty=nameWithType> method.</span></span>  
  
 <span data-ttu-id="1c013-143">若要使 Windows 窗体在 COM 客户端应用程序中正确工作，必须在 Windows 窗体消息循环上运行该窗体。</span><span class="sxs-lookup"><span data-stu-id="1c013-143">To make a Windows Form work correctly from a COM client application, you must run it on a Windows Forms message loop.</span></span> <span data-ttu-id="1c013-144">若要执行此操作，请使用以下方法之一：</span><span class="sxs-lookup"><span data-stu-id="1c013-144">To do this, use one of the following approaches:</span></span>  
  
- <span data-ttu-id="1c013-145">使用 <xref:System.Windows.Forms.Form.ShowDialog%2A?displayProperty=nameWithType> 方法显示 Windows 窗体。</span><span class="sxs-lookup"><span data-stu-id="1c013-145">Use the <xref:System.Windows.Forms.Form.ShowDialog%2A?displayProperty=nameWithType> method to display the Windows Form.</span></span> <span data-ttu-id="1c013-146">有关详细信息，请参阅[如何：通过显示 Windows 窗体使用 ShowDialog 方法来支持 COM 互操作](com-interop-by-displaying-a-windows-form-shadow.md)。</span><span class="sxs-lookup"><span data-stu-id="1c013-146">For more information, see [How to: Support COM Interop by Displaying a Windows Form with the ShowDialog Method](com-interop-by-displaying-a-windows-form-shadow.md).</span></span>  
  
- <span data-ttu-id="1c013-147">在新线程上显示每个 Windows 窗体。</span><span class="sxs-lookup"><span data-stu-id="1c013-147">Display each Windows Form on a new thread.</span></span> <span data-ttu-id="1c013-148">有关详细信息，请参阅[如何：通过在其自己的线程上显示每个 Windows 窗体来支持 COM 互操作](how-to-support-com-interop-by-displaying-each-windows-form-on-its-own-thread.md)。</span><span class="sxs-lookup"><span data-stu-id="1c013-148">For more information, see [How to: Support COM Interop by Displaying Each Windows Form on Its Own Thread](how-to-support-com-interop-by-displaying-each-windows-form-on-its-own-thread.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1c013-149">请参阅</span><span class="sxs-lookup"><span data-stu-id="1c013-149">See also</span></span>

- [<span data-ttu-id="1c013-150">Windows 窗体和非托管应用程序</span><span class="sxs-lookup"><span data-stu-id="1c013-150">Windows Forms and Unmanaged Applications</span></span>](windows-forms-and-unmanaged-applications.md)
- [<span data-ttu-id="1c013-151">COM 互操作</span><span class="sxs-lookup"><span data-stu-id="1c013-151">COM Interop</span></span>](../../../visual-basic/programming-guide/com-interop/index.md)
- [<span data-ttu-id="1c013-152">.NET Framework 应用程序中的 COM 互操作性</span><span class="sxs-lookup"><span data-stu-id="1c013-152">COM Interoperability in .NET Framework Applications</span></span>](../../../visual-basic/programming-guide/com-interop/com-interoperability-in-net-framework-applications.md)
- <span data-ttu-id="1c013-153">[COM 互操作性示例](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2008/cxcz83xf(v=vs.90))</span><span class="sxs-lookup"><span data-stu-id="1c013-153">[COM Interoperability Samples](https://docs.microsoft.com/previous-versions/visualstudio/visual-studio-2008/cxcz83xf(v=vs.90))</span></span>
- [<span data-ttu-id="1c013-154">Aximp.exe（Windows 窗体 ActiveX 控件导入程序）</span><span class="sxs-lookup"><span data-stu-id="1c013-154">Aximp.exe (Windows Forms ActiveX Control Importer)</span></span>](../../tools/aximp-exe-windows-forms-activex-control-importer.md)
- [<span data-ttu-id="1c013-155">向 COM 公开 .NET Framework 组件</span><span class="sxs-lookup"><span data-stu-id="1c013-155">Exposing .NET Framework Components to COM</span></span>](../../interop/exposing-dotnet-components-to-com.md)
- [<span data-ttu-id="1c013-156">将 COM 的程序集打包</span><span class="sxs-lookup"><span data-stu-id="1c013-156">Packaging an Assembly for COM</span></span>](../../interop/packaging-an-assembly-for-com.md)
- [<span data-ttu-id="1c013-157">向 COM 注册程序集</span><span class="sxs-lookup"><span data-stu-id="1c013-157">Registering Assemblies with COM</span></span>](../../interop/registering-assemblies-with-com.md)
- [<span data-ttu-id="1c013-158">如何：通过显示 Windows 窗体使用 ShowDialog 方法来支持 COM 互操作</span><span class="sxs-lookup"><span data-stu-id="1c013-158">How to: Support COM Interop by Displaying a Windows Form with the ShowDialog Method</span></span>](com-interop-by-displaying-a-windows-form-shadow.md)
- [<span data-ttu-id="1c013-159">如何：通过在其自己的线程上显示每个 Windows 窗体来支持 COM 互操作</span><span class="sxs-lookup"><span data-stu-id="1c013-159">How to: Support COM Interop by Displaying Each Windows Form on Its Own Thread</span></span>](how-to-support-com-interop-by-displaying-each-windows-form-on-its-own-thread.md)
