---
title: Exceptions
ms.date: 03/30/2017
ms.assetid: 065205cc-52dd-4f30-9578-b17d8d113136
ms.openlocfilehash: b08fca37e9695f57f1fcca114531e8a1e8b90c55
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2019
ms.locfileid: "64640903"
---
# <a name="exceptions"></a><span data-ttu-id="94702-102">Exceptions</span><span class="sxs-lookup"><span data-stu-id="94702-102">Exceptions</span></span>
<span data-ttu-id="94702-103">工作流可以使用 <xref:System.Activities.Statements.TryCatch> 活动处理工作流执行期间引发的异常。</span><span class="sxs-lookup"><span data-stu-id="94702-103">Workflows can use the <xref:System.Activities.Statements.TryCatch> activity to handle exceptions that are raised during the execution of a workflow.</span></span> <span data-ttu-id="94702-104">可以对这些异常进行处理，或者使用 <xref:System.Activities.Statements.Rethrow> 活动重新引发异常。</span><span class="sxs-lookup"><span data-stu-id="94702-104">These exceptions can be handled or they can be re-thrown using the <xref:System.Activities.Statements.Rethrow> activity.</span></span> <span data-ttu-id="94702-105"><xref:System.Activities.Statements.TryCatch.Finally%2A> 节中的活动在 <xref:System.Activities.Statements.TryCatch.Try%2A> 节或 <xref:System.Activities.Statements.TryCatch.Catches%2A> 节完成时执行。</span><span class="sxs-lookup"><span data-stu-id="94702-105">Activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section are executed when either the <xref:System.Activities.Statements.TryCatch.Try%2A> section or the <xref:System.Activities.Statements.TryCatch.Catches%2A> section completes.</span></span> <span data-ttu-id="94702-106">通过托管工作流<xref:System.Activities.WorkflowApplication>还可以使用实例<xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>事件处理程序以处理未处理的异常<xref:System.Activities.Statements.TryCatch>活动。</span><span class="sxs-lookup"><span data-stu-id="94702-106">Workflows hosted by a <xref:System.Activities.WorkflowApplication> instance can also use the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> event handler to handle exceptions that are not handled by a <xref:System.Activities.Statements.TryCatch> activity.</span></span>  
  
## <a name="causes-of-exceptions"></a><span data-ttu-id="94702-107">异常的原因</span><span class="sxs-lookup"><span data-stu-id="94702-107">Causes of Exceptions</span></span>  
 <span data-ttu-id="94702-108">在工作流中，异常可能通过下列方式生成：</span><span class="sxs-lookup"><span data-stu-id="94702-108">In a workflow, exceptions can be generated in the following ways:</span></span>  
  
- <span data-ttu-id="94702-109"><xref:System.Activities.Statements.TransactionScope> 中的事务超时。</span><span class="sxs-lookup"><span data-stu-id="94702-109">A time-out of transactions in <xref:System.Activities.Statements.TransactionScope>.</span></span>  
  
- <span data-ttu-id="94702-110">工作流通过使用 <xref:System.Activities.Statements.Throw> 活动引发的显式异常。</span><span class="sxs-lookup"><span data-stu-id="94702-110">An explicit exception thrown by the workflow using the <xref:System.Activities.Statements.Throw> activity.</span></span>  
  
- <span data-ttu-id="94702-111">某个活动引发的 [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)] 异常。</span><span class="sxs-lookup"><span data-stu-id="94702-111">A [!INCLUDE[netfx_current_short](../../../includes/netfx-current-short-md.md)] exception thrown from an activity.</span></span>  
  
- <span data-ttu-id="94702-112">外部代码引发的异常，例如工作流中使用的库、组件或服务。</span><span class="sxs-lookup"><span data-stu-id="94702-112">An exception thrown from external code, such as libraries, components, or services that are used in the workflow.</span></span>  
  
## <a name="handling-exceptions"></a><span data-ttu-id="94702-113">处理异常</span><span class="sxs-lookup"><span data-stu-id="94702-113">Handling Exceptions</span></span>  
 <span data-ttu-id="94702-114">如果异常由某个活动引发并且未经处理，则默认行为是终止该工作流实例。</span><span class="sxs-lookup"><span data-stu-id="94702-114">If an exception is thrown by an activity and is unhandled, the default behavior is to terminate the workflow instance.</span></span> <span data-ttu-id="94702-115">如果存在自定义 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 处理程序，则它会重写此默认行为。</span><span class="sxs-lookup"><span data-stu-id="94702-115">If a custom <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is present, it can override this default behavior.</span></span> <span data-ttu-id="94702-116">通过此处理程序，工作流宿主作者能够提供合适的处理操作，例如自定义日志记录、中止工作流、取消工作流或终止工作流。</span><span class="sxs-lookup"><span data-stu-id="94702-116">This handler gives the workflow host author an opportunity to provide the appropriate handling, such as custom logging, aborting the workflow, canceling the workflow, or terminating the workflow.</span></span>  <span data-ttu-id="94702-117">如果工作流引发未处理的异常，则将调用 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 处理程序。</span><span class="sxs-lookup"><span data-stu-id="94702-117">If a workflow raises an exception that is not handled, the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="94702-118">从 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 返回了三个可能的操作，确定工作流的最后结果。</span><span class="sxs-lookup"><span data-stu-id="94702-118">There are three possible actions returned from <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> which determine the final outcome of the workflow.</span></span>  
  
- <span data-ttu-id="94702-119">**取消**-取消的工作流实例是分支执行的正常退出。</span><span class="sxs-lookup"><span data-stu-id="94702-119">**Cancel** - A cancelled workflow instance is a graceful exit of a branch execution.</span></span> <span data-ttu-id="94702-120">您可以对取消行为进行建模（例如，通过使用 CancellationScope 活动）。</span><span class="sxs-lookup"><span data-stu-id="94702-120">You can model cancelation behavior (for example, by using a CancellationScope activity).</span></span> <span data-ttu-id="94702-121">取消进程完成时，将调用“已完成”处理程序。</span><span class="sxs-lookup"><span data-stu-id="94702-121">The Completed handler is invoked when the cancellation process completes.</span></span> <span data-ttu-id="94702-122">已取消的工作流处于“已取消”状态。</span><span class="sxs-lookup"><span data-stu-id="94702-122">A cancelled workflow is in the Cancelled state.</span></span>  
  
- <span data-ttu-id="94702-123">**终止**-无法恢复或重新启动终止的工作流实例。</span><span class="sxs-lookup"><span data-stu-id="94702-123">**Terminate** - A terminated workflow instance cannot be resumed or restarted.</span></span>  <span data-ttu-id="94702-124">这会触发“已完成”事件，并且可以提供相应的异常来表明终止的原因。</span><span class="sxs-lookup"><span data-stu-id="94702-124">This triggers the Completed event in which you can provide an exception as the reason it was terminated.</span></span> <span data-ttu-id="94702-125">终止进程完成时，将调用“已终止”处理程序。</span><span class="sxs-lookup"><span data-stu-id="94702-125">The Terminated handler is invoked when the termination process completes.</span></span> <span data-ttu-id="94702-126">终止的工作流处于“已出错”状态。</span><span class="sxs-lookup"><span data-stu-id="94702-126">A terminated workflow is in the Faulted state.</span></span>  
  
- <span data-ttu-id="94702-127">**中止**-中止的工作流实例可以恢复，仅当已配置为在不变。</span><span class="sxs-lookup"><span data-stu-id="94702-127">**Abort** - An aborted workflow instances can be resumed only if it has been configured to be persistent.</span></span>  <span data-ttu-id="94702-128">如果未配置持久性，则工作流无法继续执行。</span><span class="sxs-lookup"><span data-stu-id="94702-128">Without persistence, a workflow cannot be resumed.</span></span>  <span data-ttu-id="94702-129">在工作流中止的时间点上，自上次持久性点以来的所有已完成工作（内存中）都将丢失。</span><span class="sxs-lookup"><span data-stu-id="94702-129">At the point a workflow is aborted, any work done (in memory) since the last persistence point will be lost.</span></span> <span data-ttu-id="94702-130">对于已中止的工作流，在中止进程结束时将调用“已中止”处理程序，并且使用相应的异常来表明中止的原因。</span><span class="sxs-lookup"><span data-stu-id="94702-130">For an aborted workflow, the Aborted handler is invoked using the exception as the reason when the abort process completes.</span></span> <span data-ttu-id="94702-131">不过，与已取消和已终止不同，已中止的工作流不会调用“已完成”处理程序。</span><span class="sxs-lookup"><span data-stu-id="94702-131">However, unlike Cancelled and Terminated, the Completed handler is not invoked.</span></span> <span data-ttu-id="94702-132">中止的工作流处于“已中止”状态。</span><span class="sxs-lookup"><span data-stu-id="94702-132">An aborted workflow is in an Aborted state.</span></span>  
  
 <span data-ttu-id="94702-133">下面的示例调用了引发异常的工作流。</span><span class="sxs-lookup"><span data-stu-id="94702-133">The following example invokes a workflow that throws an exception.</span></span> <span data-ttu-id="94702-134">工作流未处理异常，并且 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 处理程序已被调用。</span><span class="sxs-lookup"><span data-stu-id="94702-134">The exception is unhandled by the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="94702-135">将检查 <xref:System.Activities.WorkflowApplicationUnhandledExceptionEventArgs> 以提供有关异常的信息，且终止工作流。</span><span class="sxs-lookup"><span data-stu-id="94702-135">The <xref:System.Activities.WorkflowApplicationUnhandledExceptionEventArgs> are inspected to provide information about the exception, and the workflow is terminated.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#1](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1)]  
  
### <a name="handling-exceptions-with-the-trycatch-activity"></a><span data-ttu-id="94702-136">使用 TryCatch 活动处理异常</span><span class="sxs-lookup"><span data-stu-id="94702-136">Handling Exceptions with the TryCatch Activity</span></span>  
 <span data-ttu-id="94702-137">在工作流内部处理异常是通过 <xref:System.Activities.Statements.TryCatch> 活动执行的。</span><span class="sxs-lookup"><span data-stu-id="94702-137">Handling exceptions inside a workflow is performed with the <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="94702-138"><xref:System.Activities.Statements.TryCatch> 活动带有 <xref:System.Activities.Statements.TryCatch.Catches%2A> 活动的 <xref:System.Activities.Statements.Catch> 集合，其中每个活动都与一个特定的 <xref:System.Exception> 类型关联。</span><span class="sxs-lookup"><span data-stu-id="94702-138">The <xref:System.Activities.Statements.TryCatch> activity has a <xref:System.Activities.Statements.TryCatch.Catches%2A> collection of <xref:System.Activities.Statements.Catch> activities that are each associated with a specific <xref:System.Exception> type.</span></span> <span data-ttu-id="94702-139">如果 <xref:System.Activities.Statements.TryCatch.Try%2A> 活动的 <xref:System.Activities.Statements.TryCatch> 节中包含的活动引发的异常与 <xref:System.Activities.Statements.Catch%601> 集合中 <xref:System.Activities.Statements.TryCatch.Catches%2A> 活动的异常匹配，则处理该异常。</span><span class="sxs-lookup"><span data-stu-id="94702-139">If the exception thrown by an activity that is contained in the <xref:System.Activities.Statements.TryCatch.Try%2A> section of a <xref:System.Activities.Statements.TryCatch> activity matches the exception of a <xref:System.Activities.Statements.Catch%601> activity in the <xref:System.Activities.Statements.TryCatch.Catches%2A> collection, then the exception is handled.</span></span> <span data-ttu-id="94702-140">如果此异常再次显式引发，或者引发了新异常，则此异常将向上传递到父活动。</span><span class="sxs-lookup"><span data-stu-id="94702-140">If the exception is explicitly re-thrown or a new exception is thrown then this exception passes up to the parent activity.</span></span> <span data-ttu-id="94702-141">下面的代码示例演示处理 <xref:System.Activities.Statements.TryCatch> 的 <xref:System.ApplicationException> 活动，该异常由 <xref:System.Activities.Statements.TryCatch.Try%2A> 活动在 <xref:System.Activities.Statements.Throw> 节中引发。</span><span class="sxs-lookup"><span data-stu-id="94702-141">The following code example shows a <xref:System.Activities.Statements.TryCatch> activity that handles an <xref:System.ApplicationException> that is thrown in the <xref:System.Activities.Statements.TryCatch.Try%2A> section by a <xref:System.Activities.Statements.Throw> activity.</span></span> <span data-ttu-id="94702-142">异常的消息由 <xref:System.Activities.Statements.Catch%601> 活动写入控制台，然后在 <xref:System.Activities.Statements.TryCatch.Finally%2A> 节中将一条消息写入控制台。</span><span class="sxs-lookup"><span data-stu-id="94702-142">The exception's message is written to the console by the <xref:System.Activities.Statements.Catch%601> activity, and then a message is written to the console in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#33](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#33)]  
  
 <span data-ttu-id="94702-143"><xref:System.Activities.Statements.TryCatch.Finally%2A> 节中的活动在 <xref:System.Activities.Statements.TryCatch.Try%2A> 节或 <xref:System.Activities.Statements.TryCatch.Catches%2A> 节成功完成时执行。</span><span class="sxs-lookup"><span data-stu-id="94702-143">The activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> section are executed when either the <xref:System.Activities.Statements.TryCatch.Try%2A> section or the <xref:System.Activities.Statements.TryCatch.Catches%2A> section successfully completes.</span></span> <span data-ttu-id="94702-144">如果未从中引发任何异常，则 <xref:System.Activities.Statements.TryCatch.Try%2A> 节成功完成；如果未从中引发或重新引发任何异常，则 <xref:System.Activities.Statements.TryCatch.Catches%2A> 节成功完成。</span><span class="sxs-lookup"><span data-stu-id="94702-144">The <xref:System.Activities.Statements.TryCatch.Try%2A> section successfully completes if no exceptions are thrown from it, and the <xref:System.Activities.Statements.TryCatch.Catches%2A> section successfully completes if no exceptions are thrown or rethrown from it.</span></span> <span data-ttu-id="94702-145">如果在 <xref:System.Activities.Statements.TryCatch.Try%2A> 的 <xref:System.Activities.Statements.TryCatch> 节中引发了异常，并且未由 <xref:System.Activities.Statements.Catch%601> 节中的 <xref:System.Activities.Statements.TryCatch.Catches%2A> 处理或是从 <xref:System.Activities.Statements.TryCatch.Catches%2A> 重新引发，将不执行 <xref:System.Activities.Statements.TryCatch.Finally%2A> 中的活动，除非出现下列情况之一。</span><span class="sxs-lookup"><span data-stu-id="94702-145">If an exception is thrown in the <xref:System.Activities.Statements.TryCatch.Try%2A> section of a <xref:System.Activities.Statements.TryCatch> and is either not handled by a <xref:System.Activities.Statements.Catch%601> in the <xref:System.Activities.Statements.TryCatch.Catches%2A> section, or is rethrown from the <xref:System.Activities.Statements.TryCatch.Catches%2A>, the activities in the <xref:System.Activities.Statements.TryCatch.Finally%2A> will not be executed unless the one of the following occurs.</span></span>  
  
- <span data-ttu-id="94702-146">无论异常是否由该更高级别的 <xref:System.Activities.Statements.TryCatch> 重新引发，均应由工作流中更高级别的 <xref:System.Activities.Statements.TryCatch> 活动捕获该异常。</span><span class="sxs-lookup"><span data-stu-id="94702-146">The exception is caught by a higher level <xref:System.Activities.Statements.TryCatch> activity in the workflow, regardless of whether it is rethrown from that higher level <xref:System.Activities.Statements.TryCatch>.</span></span>  
  
- <span data-ttu-id="94702-147">异常未由更高级别的 <xref:System.Activities.Statements.TryCatch> 进行处理，并且排除了工作流的根，此时工作流将配置为取消而不是终止或中止。</span><span class="sxs-lookup"><span data-stu-id="94702-147">The exception is not handled by a higher level <xref:System.Activities.Statements.TryCatch>, escapes the root of the workflow, and the workflow is configured to cancel instead of terminate or abort.</span></span> <span data-ttu-id="94702-148">使用 <xref:System.Activities.WorkflowApplication> 承载的工作流可以通过处理 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 和返回 <xref:System.Activities.UnhandledExceptionAction.Cancel> 来对此进行配置。</span><span class="sxs-lookup"><span data-stu-id="94702-148">Workflows hosted using <xref:System.Activities.WorkflowApplication> can configure this by handling <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> and returning <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="94702-149">在本主题的前面提供了处理 <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> 的示例。</span><span class="sxs-lookup"><span data-stu-id="94702-149">An example of handling <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> is provided previously in this topic.</span></span> <span data-ttu-id="94702-150">工作流服务可以通过使用 <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> 并指定 <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> 来对此进行配置。</span><span class="sxs-lookup"><span data-stu-id="94702-150">Workflow services can configure this by using <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> and specifying <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="94702-151">有关配置的示例<xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior>，请参阅[Workflow Service Host Extensibility](../wcf/feature-details/workflow-service-host-extensibility.md)。</span><span class="sxs-lookup"><span data-stu-id="94702-151">For an example of configuring <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior>, see [Workflow Service Host Extensibility](../wcf/feature-details/workflow-service-host-extensibility.md).</span></span>  
  
## <a name="exception-handling-versus-compensation"></a><span data-ttu-id="94702-152">异常处理与补偿</span><span class="sxs-lookup"><span data-stu-id="94702-152">Exception Handling versus Compensation</span></span>  
 <span data-ttu-id="94702-153">异常处理与补偿的不同之处在于：异常处理是在活动的执行期间发生的，</span><span class="sxs-lookup"><span data-stu-id="94702-153">The difference between exception handling and compensation is that exception handling occurs during the execution of an activity.</span></span> <span data-ttu-id="94702-154">而补偿在活动成功完成后发生。</span><span class="sxs-lookup"><span data-stu-id="94702-154">Compensation occurs after an activity has successfully completed.</span></span> <span data-ttu-id="94702-155">通过异常处理，可以在活动引发异常之后进行清理，而补偿提供了一种机制，可用于撤消以前完成的活动中所成功完成的工作。</span><span class="sxs-lookup"><span data-stu-id="94702-155">Exception handling provides an opportunity to clean up after the activity raises the exception, whereas compensation provides a mechanism by which the successfully completed work of a previously completed activity can be undone.</span></span> <span data-ttu-id="94702-156">有关详细信息，请参阅[补偿](compensation.md)。</span><span class="sxs-lookup"><span data-stu-id="94702-156">For more information, see [Compensation](compensation.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="94702-157">请参阅</span><span class="sxs-lookup"><span data-stu-id="94702-157">See also</span></span>

- <xref:System.Activities.Statements.TryCatch>
- <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>
- <xref:System.Activities.Statements.CompensableActivity>
