---
title: Direct3D9 和 WPF 互操作的性能注意事项
titleSuffix: ''
ms.date: 03/30/2017
helpviewer_keywords:
- WPF [WPF], Direct3D9 interop performance
- Direct3D9 [WPF interoperability], performance
ms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd
ms.openlocfilehash: 2445732c27d210a41da26303d6a9ce07ef6fcc94
ms.sourcegitcommit: de17a7a0a37042f0d4406f5ae5393531caeb25ba
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/24/2020
ms.locfileid: "76743930"
---
# <a name="performance-considerations-for-direct3d9-and-wpf-interoperability"></a><span data-ttu-id="7cd00-102">Direct3D9 和 WPF 互操作性的性能注意事项</span><span class="sxs-lookup"><span data-stu-id="7cd00-102">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>
<span data-ttu-id="7cd00-103">可以通过使用 <xref:System.Windows.Interop.D3DImage> 类来承载 Direct3D9 内容。</span><span class="sxs-lookup"><span data-stu-id="7cd00-103">You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class.</span></span> <span data-ttu-id="7cd00-104">托管 Direct3D9 内容会影响应用程序的性能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-104">Hosting Direct3D9 content can affect the performance of your application.</span></span> <span data-ttu-id="7cd00-105">本主题介绍在 Windows Presentation Foundation （WPF）应用程序中承载 Direct3D9 内容时优化性能的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="7cd00-105">This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="7cd00-106">这些最佳实践包括如何在使用 Windows Vista、Windows XP 和多监视器显示器时使用 <xref:System.Windows.Interop.D3DImage> 和最佳实践。</span><span class="sxs-lookup"><span data-stu-id="7cd00-106">These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7cd00-107">有关演示这些最佳实践的代码示例，请参阅[WPF 和 Direct3D9 互操作](wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="7cd00-107">For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="use-d3dimage-sparingly"></a><span data-ttu-id="7cd00-108">慎用 D3DImage</span><span class="sxs-lookup"><span data-stu-id="7cd00-108">Use D3DImage Sparingly</span></span>  
 <span data-ttu-id="7cd00-109"><xref:System.Windows.Interop.D3DImage> 实例中托管的 Direct3D9 内容的呈现速度不像在纯 Direct3D 应用程序中一样。</span><span class="sxs-lookup"><span data-stu-id="7cd00-109">Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application.</span></span> <span data-ttu-id="7cd00-110">复制图面并刷新命令缓冲区可能会耗费大量的操作。</span><span class="sxs-lookup"><span data-stu-id="7cd00-110">Copying the surface and flushing the command buffer can be costly operations.</span></span> <span data-ttu-id="7cd00-111">随着 <xref:System.Windows.Interop.D3DImage> 实例数量的增加，会发生更多刷新，并且性能会下降。</span><span class="sxs-lookup"><span data-stu-id="7cd00-111">As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades.</span></span> <span data-ttu-id="7cd00-112">因此，应慎用 <xref:System.Windows.Interop.D3DImage>。</span><span class="sxs-lookup"><span data-stu-id="7cd00-112">Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.</span></span>  
  
## <a name="best-practices-on-windows-vista"></a><span data-ttu-id="7cd00-113">Windows Vista 上的最佳做法</span><span class="sxs-lookup"><span data-stu-id="7cd00-113">Best Practices on Windows Vista</span></span>  
 <span data-ttu-id="7cd00-114">若要在 Windows Vista 上以配置为使用 Windows 显示驱动程序模型（WDDM）的显示获得最佳性能，请在 `IDirect3DDevice9Ex` 设备上创建 Direct3D9 图面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-114">For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device.</span></span> <span data-ttu-id="7cd00-115">这会启用表面共享。</span><span class="sxs-lookup"><span data-stu-id="7cd00-115">This enables surface sharing.</span></span> <span data-ttu-id="7cd00-116">视频卡必须支持 Windows Vista 上的 `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` 和 `D3DCAPS2_CANSHARERESOURCE` 驱动程序功能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-116">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista.</span></span> <span data-ttu-id="7cd00-117">任何其他设置都会导致通过软件复制表面，这会显著降低性能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-117">Any other settings cause the surface to be copied through software, which reduces performance significantly.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7cd00-118">如果 Windows Vista 具有配置为使用 Windows XP 显示驱动程序模型（XDDM）的显示，则无论设置如何，都将始终通过软件复制表面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-118">If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.</span></span> <span data-ttu-id="7cd00-119">如果使用了适当的设置和视频卡，则在使用 WDDM 时，Windows Vista 上将显示更好的性能，因为在硬件中执行 surface 副本。</span><span class="sxs-lookup"><span data-stu-id="7cd00-119">With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.</span></span>  
  
## <a name="best-practices-on-windows-xp"></a><span data-ttu-id="7cd00-120">Windows XP 上的最佳做法</span><span class="sxs-lookup"><span data-stu-id="7cd00-120">Best Practices on Windows XP</span></span>  
 <span data-ttu-id="7cd00-121">为了在使用 Windows XP 显示驱动程序模型（XDDM）的 Windows XP 上获得最佳性能，请在调用 `IDirect3DSurface9::GetDC` 方法时创建一个正常运行的可锁定表面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-121">For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called.</span></span> <span data-ttu-id="7cd00-122">在内部，`BitBlt` 方法在硬件中的设备之间传输表面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-122">Internally, the `BitBlt` method transfers the surface across devices in hardware.</span></span> <span data-ttu-id="7cd00-123">`GetDC` 方法始终适用于 XRGB 图面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-123">The `GetDC` method always works on XRGB surfaces.</span></span> <span data-ttu-id="7cd00-124">但是，如果客户端计算机运行的是带有 SP3 或 SP2 的 Windows XP，并且客户端也具有用于分层窗口功能的修补程序，则此方法仅适用于 ARGB 图面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-124">However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.</span></span> <span data-ttu-id="7cd00-125">视频卡必须支持 `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` 驱动程序功能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-125">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.</span></span>  
  
 <span data-ttu-id="7cd00-126">16位桌面显示深度可能会显著降低性能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-126">A 16-bit desktop display depth can significantly reduce performance.</span></span> <span data-ttu-id="7cd00-127">建议使用32位桌面。</span><span class="sxs-lookup"><span data-stu-id="7cd00-127">A 32-bit desktop is recommended.</span></span>  
  
 <span data-ttu-id="7cd00-128">如果要针对 Windows Vista 和 Windows XP 进行开发，请在 Windows XP 上测试性能。</span><span class="sxs-lookup"><span data-stu-id="7cd00-128">If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.</span></span> <span data-ttu-id="7cd00-129">Windows XP 上的视频内存不足是个问题。</span><span class="sxs-lookup"><span data-stu-id="7cd00-129">Running out of video memory on Windows XP is a concern.</span></span> <span data-ttu-id="7cd00-130">此外，由于需要额外的视频内存复制，Windows XP 上的 <xref:System.Windows.Interop.D3DImage> 比 Windows Vista WDDM 使用的视频内存和带宽更多。</span><span class="sxs-lookup"><span data-stu-id="7cd00-130">In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.</span></span> <span data-ttu-id="7cd00-131">因此，对于同一视频硬件，在 Windows XP 和 Windows Vista 上，性能会更糟。</span><span class="sxs-lookup"><span data-stu-id="7cd00-131">Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7cd00-132">Windows XP 和 Windows Vista 上都提供了 XDDM;但是，WDDM 仅适用于 Windows Vista。</span><span class="sxs-lookup"><span data-stu-id="7cd00-132">XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.</span></span>  
  
## <a name="general-best-practices"></a><span data-ttu-id="7cd00-133">一般最佳实践</span><span class="sxs-lookup"><span data-stu-id="7cd00-133">General Best Practices</span></span>  
 <span data-ttu-id="7cd00-134">创建设备时，请使用 `D3DCREATE_MULTITHREADED` 创建标志。</span><span class="sxs-lookup"><span data-stu-id="7cd00-134">When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag.</span></span> <span data-ttu-id="7cd00-135">这会降低性能，但 WPF 呈现系统会从另一个线程调用此设备上的方法。</span><span class="sxs-lookup"><span data-stu-id="7cd00-135">This reduces performance, but the WPF rendering system calls methods on this device from another thread.</span></span> <span data-ttu-id="7cd00-136">请确保正确遵循锁定协议，以便没有两个线程同时访问设备。</span><span class="sxs-lookup"><span data-stu-id="7cd00-136">Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.</span></span>  
  
 <span data-ttu-id="7cd00-137">如果您的呈现在 WPF 托管线程上执行，则强烈建议您使用 `D3DCREATE_FPU_PRESERVE` 创建标志来创建设备。</span><span class="sxs-lookup"><span data-stu-id="7cd00-137">If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag.</span></span> <span data-ttu-id="7cd00-138">如果没有此设置，D3D 呈现可以降低 WPF 双精度操作的准确性，并引入呈现问题。</span><span class="sxs-lookup"><span data-stu-id="7cd00-138">Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.</span></span>  
  
 <span data-ttu-id="7cd00-139">平铺 <xref:System.Windows.Interop.D3DImage> 的速度很快，除非您平铺没有硬件支持的非 pow2 表面，或者平铺包含 <xref:System.Windows.Interop.D3DImage>的 <xref:System.Windows.Media.DrawingBrush> 或 <xref:System.Windows.Media.VisualBrush>。</span><span class="sxs-lookup"><span data-stu-id="7cd00-139">Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.</span></span>  
  
## <a name="best-practices-for-multi-monitor-displays"></a><span data-ttu-id="7cd00-140">多监视器显示器的最佳实践</span><span class="sxs-lookup"><span data-stu-id="7cd00-140">Best Practices for Multi-Monitor Displays</span></span>  
 <span data-ttu-id="7cd00-141">如果你使用的是具有多个监视器的计算机，则应遵循前面所述的最佳实践。</span><span class="sxs-lookup"><span data-stu-id="7cd00-141">If you are using a computer that has multiple monitors, you should follow the previously described best practices.</span></span> <span data-ttu-id="7cd00-142">对于多监视器配置，还有一些其他性能注意事项。</span><span class="sxs-lookup"><span data-stu-id="7cd00-142">There are also some additional performance considerations for a multi-monitor configuration.</span></span>  
  
 <span data-ttu-id="7cd00-143">创建后台缓冲区时，将在特定设备和适配器上创建它，但 WPF 可能会在任何适配器上显示前台缓冲区。</span><span class="sxs-lookup"><span data-stu-id="7cd00-143">When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.</span></span> <span data-ttu-id="7cd00-144">跨适配器复制以更新前台缓冲区可能非常昂贵。</span><span class="sxs-lookup"><span data-stu-id="7cd00-144">Copying across adapters to update the front buffer can be very expensive.</span></span> <span data-ttu-id="7cd00-145">在配置为使用具有多个视频卡的 WDDM 和 `IDirect3DDevice9Ex` 设备的 Windows Vista 上，如果前台缓冲区位于不同的适配器上，但仍处于同一视频卡，则不会产生性能损失。</span><span class="sxs-lookup"><span data-stu-id="7cd00-145">On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.</span></span> <span data-ttu-id="7cd00-146">但是，在 Windows XP 和具有多个视频卡的 XDDM 上，当前台缓冲区显示在不同于后台缓冲区的适配器上时，将会出现明显的性能下降。</span><span class="sxs-lookup"><span data-stu-id="7cd00-146">However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.</span></span> <span data-ttu-id="7cd00-147">有关详细信息，请参阅[WPF 和 Direct3D9 互操作](wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="7cd00-147">For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="performance-summary"></a><span data-ttu-id="7cd00-148">性能摘要</span><span class="sxs-lookup"><span data-stu-id="7cd00-148">Performance Summary</span></span>  
 <span data-ttu-id="7cd00-149">下表显示了前台缓冲区更新的性能，作为操作系统、像素格式和 surface lockability 的函数。</span><span class="sxs-lookup"><span data-stu-id="7cd00-149">The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.</span></span> <span data-ttu-id="7cd00-150">前台缓冲区和后台缓冲区假定位于同一适配器上。</span><span class="sxs-lookup"><span data-stu-id="7cd00-150">The front buffer and back buffer are assumed to be on the same adapter.</span></span> <span data-ttu-id="7cd00-151">硬件更新的速度通常比软件更新的速度要快得多，具体取决于适配器配置。</span><span class="sxs-lookup"><span data-stu-id="7cd00-151">Depending on the adapter configuration, hardware updates are generally much faster than software updates.</span></span>  
  
|<span data-ttu-id="7cd00-152">Surface 像素格式</span><span class="sxs-lookup"><span data-stu-id="7cd00-152">Surface pixel format</span></span>|<span data-ttu-id="7cd00-153">Windows Vista、WDDM 和9Ex</span><span class="sxs-lookup"><span data-stu-id="7cd00-153">Windows Vista, WDDM and 9Ex</span></span>|<span data-ttu-id="7cd00-154">其他 Windows Vista 配置</span><span class="sxs-lookup"><span data-stu-id="7cd00-154">Other Windows Vista configurations</span></span>|<span data-ttu-id="7cd00-155">Windows XP SP3 或 SP2 w/修补程序</span><span class="sxs-lookup"><span data-stu-id="7cd00-155">Windows XP SP3 or SP2 w/ hotfix</span></span>|<span data-ttu-id="7cd00-156">Windows XP SP2</span><span class="sxs-lookup"><span data-stu-id="7cd00-156">Windows XP SP2</span></span>|  
|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  
|<span data-ttu-id="7cd00-157">D3DFMT_X8R8G8B8 （不可锁定）</span><span class="sxs-lookup"><span data-stu-id="7cd00-157">D3DFMT_X8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="7cd00-158">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-158">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-159">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-159">Software Update</span></span>|<span data-ttu-id="7cd00-160">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-160">Software Update</span></span>|<span data-ttu-id="7cd00-161">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-161">Software Update</span></span>|  
|<span data-ttu-id="7cd00-162">D3DFMT_X8R8G8B8 （锁定）</span><span class="sxs-lookup"><span data-stu-id="7cd00-162">D3DFMT_X8R8G8B8 (lockable)</span></span>|<span data-ttu-id="7cd00-163">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-163">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-164">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-164">Software Update</span></span>|<span data-ttu-id="7cd00-165">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-165">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-166">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-166">**Hardware Update**</span></span>|  
|<span data-ttu-id="7cd00-167">D3DFMT_A8R8G8B8 （不可锁定）</span><span class="sxs-lookup"><span data-stu-id="7cd00-167">D3DFMT_A8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="7cd00-168">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-168">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-169">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-169">Software Update</span></span>|<span data-ttu-id="7cd00-170">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-170">Software Update</span></span>|<span data-ttu-id="7cd00-171">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-171">Software Update</span></span>|  
|<span data-ttu-id="7cd00-172">D3DFMT_A8R8G8B8 （锁定）</span><span class="sxs-lookup"><span data-stu-id="7cd00-172">D3DFMT_A8R8G8B8 (lockable)</span></span>|<span data-ttu-id="7cd00-173">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-173">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-174">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-174">Software Update</span></span>|<span data-ttu-id="7cd00-175">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="7cd00-175">**Hardware Update**</span></span>|<span data-ttu-id="7cd00-176">软件更新</span><span class="sxs-lookup"><span data-stu-id="7cd00-176">Software Update</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="7cd00-177">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7cd00-177">See also</span></span>

- <xref:System.Windows.Interop.D3DImage>
- [<span data-ttu-id="7cd00-178">WPF 和 Direct3D9 互操作</span><span class="sxs-lookup"><span data-stu-id="7cd00-178">WPF and Direct3D9 Interoperation</span></span>](wpf-and-direct3d9-interoperation.md)
- [<span data-ttu-id="7cd00-179">演练：创建在 WPF 中托管的 Direct3D9 内容</span><span class="sxs-lookup"><span data-stu-id="7cd00-179">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)
- [<span data-ttu-id="7cd00-180">演练：在 WPF 中托管 Direct3D9 内容</span><span class="sxs-lookup"><span data-stu-id="7cd00-180">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](walkthrough-hosting-direct3d9-content-in-wpf.md)
